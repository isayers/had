<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DNATA Employee Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Advanced Confirmation Dialogs */
.confirmation-dialog {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 300;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
}

.confirmation-dialog.active {
    opacity: 1;
    pointer-events: all;
}

.confirmation-content {
    background: var(--card-bg);
    border-radius: 20px;
    width: 90%;
    max-width: 400px;
    padding: 25px;
    box-shadow: var(--shadow);
    transform: translateY(20px);
    transition: all 0.3s ease;
    border-top: 4px solid var(--primary);
}

.confirmation-dialog.active .confirmation-content {
    transform: translateY(0);
}

.confirmation-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.confirmation-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    color: var(--white);
    display: flex;
    justify-content: center;
    align-items: center;
    margin-right: 15px;
    flex-shrink: 0;
}

.confirmation-icon.warning {
    background: var(--warning);
}

.confirmation-icon.danger {
    background: var(--danger);
}

.confirmation-icon.success {
    background: var(--success);
}

.confirmation-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 5px;
}

.confirmation-message {
    color: var(--text-color);
    line-height: 1.5;
    margin-bottom: 25px;
    padding: 0 10px;
}

.confirmation-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.confirmation-btn {
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    font-size: 0.9rem;
}

.confirmation-btn-cancel {
    background: var(--light);
    color: var(--dark);
}

.confirmation-btn-cancel:hover {
    background: #e0e0e0;
    transform: translateY(-2px);
}

.confirmation-btn-confirm {
    background: var(--primary);
    color: var(--white);
}

.confirmation-btn-confirm:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}

.confirmation-btn-danger {
    background: var(--danger);
    color: var(--white);
}

.confirmation-btn-danger:hover {
    background: #c0392b;
    transform: translateY(-2px);
}

.confirmation-input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid var(--light);
    border-radius: 12px;
    background: var(--white);
    margin-bottom: 20px;
    font-size: 1rem;
    color: var(--dark);
    transition: all 0.3s ease;
    box-shadow: var(--neumorphic-shadow-inset);
}

.confirmation-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

/* Prompt dialog specific styles */
.prompt-dialog .confirmation-content {
    max-width: 450px;
}

.prompt-dialog .confirmation-message {
    margin-bottom: 15px;
}

/* Small screens adjustments */
@media (max-width: 480px) {
    .confirmation-content {
        padding: 20px;
    }
    
    .confirmation-footer {
        flex-direction: column-reverse;
    }
    
    .confirmation-btn {
        width: 100%;
    }
}
        /* Avatar image fitting */
.header-avatar,
#userAvatar,
.profile-avatar,
.message-avatar,
.employee-avatar {
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    overflow: hidden;
}

/* Specific adjustments for different avatar types */
.header-avatar, /* Header avatar */
#userAvatar {   /* Dashboard welcome avatar */
    width: 40px;
    height: 40px;
}

#userAvatar {   /* Larger version in dashboard */
    width: 60px;
    height: 60px;
}

.profile-avatar { /* Profile modal avatar */
    width: 120px;
    height: 120px;
}

.message-avatar { /* Chat message avatars */
    width: 30px;
    height: 30px;
}

.employee-avatar { /* Employee list avatars */
    width: 50px;
    height: 50px;
}

/* Fallback for avatars without images */
.header-avatar:not([style*="background-image"]),
#userAvatar:not([style*="background-image"]),
.profile-avatar:not([style*="background-image"]),
.message-avatar:not([style*="background-image"]),
.employee-avatar:not([style*="background-image"]) {
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 600;
    background-color: var(--primary);
    color: var(--white);
}

/* Ensure text initials are centered and visible */
.header-avatar span,
#userAvatar span,
.profile-avatar span,
.message-avatar span,
.employee-avatar span {
    display: block;
    text-align: center;
    width: 100%;
}
        /* Improved logo and avatar fitting */
.login-logo img {
    width: 80%;
    height: 80%;
    object-fit: contain;
    border-radius: 50%;
}

.header-avatar, 
.user-avatar,
.profile-avatar,
.message-avatar,
.employee-avatar {
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    object-fit: cover;
}

/* Ensure all scrollable containers work properly */
.dashboard-content,
.fullscreen-content,
.chat-messages,
.profile-modal-body {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: var(--primary) var(--light);
}

/* Custom scrollbar for WebKit browsers */
.dashboard-content::-webkit-scrollbar,
.fullscreen-content::-webkit-scrollbar,
.chat-messages::-webkit-scrollbar,
.profile-modal-body::-webkit-scrollbar {
    width: 6px;
}

.dashboard-content::-webkit-scrollbar-track,
.fullscreen-content::-webkit-scrollbar-track,
.chat-messages::-webkit-scrollbar-track,
.profile-modal-body::-webkit-scrollbar-track {
    background: var(--light);
    border-radius: 3px;
}

.dashboard-content::-webkit-scrollbar-thumb,
.fullscreen-content::-webkit-scrollbar-thumb,
.chat-messages::-webkit-scrollbar-thumb,
.profile-modal-body::-webkit-scrollbar-thumb {
    background-color: var(--primary);
    border-radius: 3px;
}

/* Ensure body is always scrollable */
html, body {
    overflow-y: auto;
    height: auto;
    min-height: 100vh;
}

/* Fix for dashboard container scrolling */
#dashboardContainer {
    height: auto;
    min-height: 100vh;
    overflow: hidden;
}

/* Fix for fullscreen content scrolling */
.fullscreen-content {
    height: auto;
    min-height: calc(100vh - 170px); /* Account for header and footer */
    padding-bottom: 20px;
}

/* Chat modal scrolling fix */
#chatModal {
    height: 100vh;
    overflow: hidden;
}

.chat-messages {
    flex: 1;
    min-height: 0; /* Fix for flexbox scrolling */
}

/* Profile modal scrolling fix */
#profileModal {
    height: 100vh;
    overflow: hidden;
}

.profile-modal-body {
    flex: 1;
    min-height: 0; /* Fix for flexbox scrolling */
}
        /* Base Styles */
        :root {
            --primary: #3498db;
            --primary-light: #5dade2;
            --primary-dark: #2874a6;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --success: #2ecc71;
            --info: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --white: #ffffff;
            --shadow: 0 8px 22px rgba(0, 0, 0, 0.1);
            --neumorphic-shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
            --neumorphic-shadow-inset: inset 3px 3px 6px #d1d9e6, inset -3px -3px 6px #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.2);
            --glass-border: rgba(255, 255, 255, 0.3);
            --bg-gradient: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%);
            --text-color: #2c3e50;
            --card-bg: #ffffff;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --light: #2d3436;
            --dark: #f5f6fa;
            --gray: #b2bec3;
            --white: #1e272e;
            --shadow: 0 8px 22px rgba(0, 0, 0, 0.3);
            --neumorphic-shadow: 8px 8px 16px #1a1a1a, -8px -8px 16px #2a2a2a;
            --neumorphic-shadow-inset: inset 3px 3px 6px #1a1a1a, inset -3px -3px 6px #2a2a2a;
            --glass-bg: rgba(30, 39, 46, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --text-color: #f5f6fa;
            --card-bg: #1e272e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            background: var(--bg-gradient);
            color: var(--text-color);
            transition: background 0.3s ease, color 0.3s ease;
        }

        body {
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Loading Animation */
        #loadingContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        #loadingContainer.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #loadingAnimation {
            width: 150px;
            height: 150px;
        }

        /* Theme Switcher */
        .theme-switcher {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--neumorphic-shadow);
            z-index: 95;
            transition: all 0.3s ease;
        }

        .theme-switcher:hover {
            transform: translateY(-3px) scale(1.1);
        }

        .theme-switcher i {
            font-size: 1.2rem;
            color: var(--primary);
        }

        /* Login Container */
        #loginContainer {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            transition: all 0.4s ease;
        }

        #loginContainer.hidden {
            opacity: 0;
            transform: translateY(20px);
        }

        .login-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            border-radius: 50%;
            background-color: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--neumorphic-shadow);
        }

        .login-logo img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary-dark);
            text-align: center;
        }

        .login-subtitle {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 30px;
            text-align: center;
        }

        .login-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            position: relative;
            width: 100%;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 15px 20px;
            border: none;
            border-radius: 15px;
            background: var(--white);
            box-shadow: var(--neumorphic-shadow-inset);
            font-size: 1rem;
            color: var(--dark);
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            box-shadow: inset 4px 4px 8px var(--neumorphic-shadow-inset);
        }

        .input-with-icon {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .input-with-icon .form-control {
            padding-left: 45px;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .password-toggle:hover {
            color: var(--primary);
        }

        .alert {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
            background-color: var(--white);
            box-shadow: var(--neumorphic-shadow);
        }

        .alert i {
            font-size: 1.2rem;
        }

        .alert-warning {
            color: var(--warning);
        }

        .alert-danger {
            color: var(--danger);
        }

        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            box-shadow: var(--neumorphic-shadow);
            background: var(--white);
            color: var(--primary-dark);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-dark) 100%);
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-block {
            width: 100%;
        }

        .btn-text {
            transition: all 0.3s ease;
        }

        .btn-spinner {
            display: none;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .text-center {
            text-align: center;
        }

        .mt-3 {
            margin-top: 15px;
        }

        .forgot-password {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .forgot-password:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        /* Dashboard Container */
        #dashboardContainer {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            position: relative;
            transition: all 0.4s ease;
        }

        #dashboardContainer.active {
            display: flex;
        }

        /* Fixed Header */
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(-100%);
            transition: all 0.3s ease;
        }

        .fixed-header.visible {
            transform: translateY(0);
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            color: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            box-shadow: var(--neumorphic-shadow);
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--neumorphic-shadow);
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            transform: translateY(-2px);
        }

        .header-btn i {
            color: var(--primary-dark);
            font-size: 1.2rem;
        }

        /* Dashboard Content */
        .dashboard-content {
            flex: 1;
            padding: 80px 20px 90px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Dashboard Sections */
        .dashboard-section {
            margin-bottom: 30px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
        }

        .dashboard-section.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary);
        }

        .section-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--neumorphic-shadow);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .section-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        /* Teams List */
        .no-teams, .no-announcements, .no-employees, .no-messages {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-style: italic;
        }

        /* Announcements */
        .announcement-item {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--neumorphic-shadow);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .announcement-item.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .announcement-title {
            font-weight: 600;
            color: var(--primary-dark);
            flex: 1;
        }

        .announcement-date {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .announcement-content {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            color: var(--dark);
            line-height: 1.6;
        }

        .announcement-image {
            width: 100%;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: var(--neumorphic-shadow);
        }

        .announcement-author {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 10px;
            font-style: italic;
        }

        /* Dashboard Icons */
        #dashboardIconsContainer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
            z-index: 90;
            transition: all 0.3s ease;
        }

        #dashboardIconsContainer.hidden {
            transform: translateY(100%);
        }

        .dashboard-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            padding: 10px;
            border-radius: 15px;
        }

        .dashboard-icon.active {
            background: rgba(52, 152, 219, 0.1);
        }

        .dashboard-icon i {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }

        .dashboard-icon.active i {
            color: var(--primary-dark);
            transform: scale(1.1);
        }

        .dashboard-icon-text {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--primary);
            transition: all 0.3s ease;
        }

        .dashboard-icon.active .dashboard-icon-text {
            color: var(--primary-dark);
            font-weight: 700;
        }

        .dashboard-icon-tooltip {
            position: absolute;
            top: -40px;
            background: var(--dark);
            color: var(--white);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            white-space: nowrap;
            pointer-events: none;
        }

        .dashboard-icon-tooltip::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--dark);
        }

        /* Fullscreen Content */
        .fullscreen-content {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            padding: 80px 20px 90px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            z-index: 80;
            display: none;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
        }

        .fullscreen-content.active {
            display: block;
            opacity: 1;
            transform: translateX(0);
        }

        @keyframes swipeIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes swipeOut {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }

        /* Teams Content */
        .team-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--neumorphic-shadow);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .team-card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .team-name {
            font-weight: 700;
            color: var(--primary-dark);
            font-size: 1.1rem;
        }

        .team-date {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .team-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .team-detail {
            display: flex;
            flex-direction: column;
        }

        .team-label {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .team-value {
            font-weight: 600;
            color: var(--dark);
        }

        .break-schedule {
            background: rgba(52, 152, 219, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }

        .break-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 10px;
        }

        .break-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
        }

        .break-item:last-child {
            border-bottom: none;
        }

        .break-time {
            font-weight: 500;
            color: var(--dark);
        }

        .break-duration {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .team-members {
            margin-top: 20px;
        }

        .team-members h4 {
            font-size: 1rem;
            color: var(--primary-dark);
            margin-bottom: 10px;
        }

        .member-item {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
        }

        .member-item:last-child {
            border-bottom: none;
        }

        .member-role {
            font-weight: 500;
            color: var(--gray);
            width: 120px;
        }

        .member-name {
            font-weight: 600;
            color: var(--dark);
            flex: 1;
        }

        .supervisor-badge {
            display: inline-block;
            background: var(--primary);
            color: var(--white);
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        /* Connect Content */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 15px;
            background: var(--white);
            box-shadow: var(--neumorphic-shadow-inset);
            font-size: 1rem;
            color: var(--dark);
        }

        .search-input:focus {
            outline: none;
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
        }

        .search-btn {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            background: var(--primary);
            color: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--neumorphic-shadow);
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: translateY(-2px);
        }

        .search-btn i {
            font-size: 1.2rem;
        }

        .employee-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--neumorphic-shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .employee-card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .employee-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary);
            color: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .employee-info {
            flex: 1;
        }

        .employee-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 3px;
        }

        .employee-id {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 3px;
        }

        .employee-position {
            font-size: 0.8rem;
            color: var(--primary);
        }

        .employee-connect-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 12px;
            background: var(--primary);
            color: var(--white);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .employee-connect-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Forums Content */
        .forum-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--neumorphic-shadow);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .forum-card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .forum-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .forum-title {
            font-weight: 700;
            color: var(--primary-dark);
            font-size: 1.1rem;
        }

        .forum-members {
            font-size: 0.8rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .forum-description {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .forum-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .forum-category {
            font-size: 0.8rem;
            color: var(--primary);
            background: rgba(52, 152, 219, 0.1);
            padding: 5px 10px;
            border-radius: 10px;
        }

        .forum-join-btn, .forum-exit-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .forum-join-btn {
            background: var(--primary);
            color: var(--white);
        }

        .forum-join-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .forum-exit-btn {
            background: var(--light);
            color: var(--danger);
            margin-left: 10px;
        }

        .forum-exit-btn:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
        }

        /* Chat Modal */
        #chatModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            z-index: 110;
            display: none;
            flex-direction: column;
            transform: translateX(100%);
            transition: all 0.4s ease;
        }

        #chatModal.active {
            display: flex;
            transform: translateX(0);
        }

        .chat-header {
            padding: 15px 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--neumorphic-shadow);
            transition: all 0.3s ease;
        }

        .chat-back-btn:hover {
            transform: translateY(-2px);
        }

        .chat-back-btn i {
            color: var(--primary-dark);
            font-size: 1.2rem;
        }

        .chat-title {
            font-weight: 700;
            color: var(--dark);
            font-size: 1.1rem;
            flex: 1;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .message-sent {
            margin-left: auto;
        }

        .message-received {
            margin-right: auto;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .message-sent .message-header {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--primary);
            color: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 600;
            background-size: cover;
            background-position: center;
        }

        .message-info {
            display: flex;
            flex-direction: column;
        }

        .message-sender {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark);
        }

        .message-received .message-sender {
            color: var(--primary-dark);
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--gray);
        }

        .message-content {
            background: var(--white);
            padding: 10px 15px;
            border-radius: 15px;
            box-shadow: var(--neumorphic-shadow);
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-sent .message-content {
            background: var(--primary);
            color: var(--white);
            border-bottom-right-radius: 5px;
        }

        .message-received .message-content {
            border-bottom-left-radius: 5px;
        }

        .file-message {
            background: var(--white);
            padding: 15px;
            border-radius: 15px;
            box-shadow: var(--neumorphic-shadow);
            margin-top: 10px;
        }

        .file-message i {
            color: var(--primary);
            margin-right: 8px;
        }

        .file-preview {
            width: 100%;
            border-radius: 10px;
            margin-top: 10px;
            box-shadow: var(--neumorphic-shadow);
        }

        .file-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .file-action {
            padding: 5px 10px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .file-action:hover {
            background: rgba(52, 152, 219, 0.2);
        }

        .file-action i {
            margin: 0;
            font-size: 0.8rem;
        }

        .audio-message {
            background: var(--white);
            padding: 15px;
            border-radius: 15px;
            box-shadow: var(--neumorphic-shadow);
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .audio-message i {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .audio-player {
            flex: 1;
            height: 30px;
        }

        .message-actions {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            justify-content: flex-end;
        }

        .message-action {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .message-action:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .message-action i {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .chat-input-container {
            padding: 15px;
            background: var(--white);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 20px;
            background: var(--light);
            font-size: 1rem;
            resize: none;
            max-height: 100px;
            box-shadow: var(--neumorphic-shadow-inset);
        }

        .chat-input:focus {
            outline: none;
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
        }

        .chat-send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--neumorphic-shadow);
            transition: all 0.3s ease;
            border: none;
        }

        .chat-send-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .chat-send-btn i {
            font-size: 1.2rem;
        }

        .chat-actions {
            display: flex;
            gap: 5px;
        }

        .chat-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .chat-action-btn:hover {
            background: #e0e0e0;
        }

        .chat-action-btn i {
            color: var(--primary);
            font-size: 1.1rem;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            gap: 5px;
            color: var(--danger);
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0 10px;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* Break Alerts */
        .break-alert {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            max-width: 400px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 120;
            overflow: hidden;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .break-alert-popup {
            animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes slideUp {
            to { transform: translateY(0); opacity: 1; }
        }

        .break-alert-fadeout {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes fadeOut {
            to { transform: translateY(100px); opacity: 0; }
        }

        .break-alert-team {
            border-left: 5px solid var(--primary);
        }

        .break-alert-individual {
            border-left: 5px solid var(--secondary);
        }

        .break-alert-content {
            padding: 15px;
        }

        .break-alert-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .break-alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .break-alert-individual .break-alert-icon {
            background: var(--secondary);
        }

        .break-alert-icon i {
            font-size: 1.2rem;
        }

        .break-alert-title {
            flex: 1;
        }

        .break-alert-title h4 {
            font-size: 1rem;
            color: var(--dark);
            margin-bottom: 3px;
        }

        .break-alert-time {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .break-alert-close {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--gray);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .break-alert-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--danger);
        }

        .break-alert-body {
            color: var(--dark);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .break-alert-footer {
            display: flex;
            gap: 10px;
        }

        .break-alert-action {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .break-alert-action i {
            font-size: 1rem;
        }

        .break-alert-action:first-child {
            background: rgba(0, 0, 0, 0.05);
            color: var(--dark);
        }

        .break-alert-action:first-child:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .break-alert-action:last-child {
            background: var(--primary);
            color: var(--white);
        }

        .break-alert-action:last-child:hover {
            background: var(--primary-dark);
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            padding: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .modal-close {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .modal-close:hover {
            background: #e0e0e0;
        }

        .modal-close i {
            color: var(--gray);
            font-size: 1rem;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
        }

        /* Profile Modal */
        #profileModal {
            position: fixed;
            top: 0;
            right: 0;
            width: 90%;
            max-width: 350px;
            height: 100%;
            background: var(--white);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.1);
            z-index: 200;
            transform: translateX(100%);
            transition: all 0.4s ease;
            display: flex;
            flex-direction: column;
        }

        #profileModal.active {
            transform: translateX(0);
        }

        .profile-modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .profile-modal-close {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .profile-modal-close:hover {
            background: #e0e0e0;
        }

        .profile-modal-close i {
            color: var(--gray);
            font-size: 1rem;
        }

        .profile-modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .profile-avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
        }

        #profileAvatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: var(--primary);
            color: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            font-size: 2rem;
            background-size: cover;
            background-position: center;
            box-shadow: var(--neumorphic-shadow);
        }

        #profileAvatarEdit {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--neumorphic-shadow);
            transition: all 0.3s ease;
            border: none;
        }

        #profileAvatarEdit:hover {
            transform: scale(1.1);
        }

        #profileAvatarEdit i {
            font-size: 1.2rem;
        }

        #profileAvatarInput {
            display: none;
        }

        .profile-info-item {
            margin-bottom: 15px;
        }

        .profile-info-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 5px;
        }

        .profile-info-value {
            font-weight: 600;
            color: var(--dark);
            padding: 10px 15px;
            background: var(--light);
            border-radius: 10px;
        }

        .profile-modal-footer {
            padding: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* Camera Modal */
        #cameraModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 210;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #cameraModal.active {
            display: flex;
        }

        #cameraVideo {
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            background: #000;
        }

        .camera-controls {
            position: fixed;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }

        .camera-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .camera-btn i {
            color: var(--white);
            font-size: 1.5rem;
        }

        #cameraCaptureBtn {
            width: 70px;
            height: 70px;
            border: 3px solid var(--white);
            background: transparent;
        }

        #cameraCloseBtn {
            position: fixed;
            top: 30px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
        }

        #cameraPreview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 220;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #cameraPreview.active {
            display: flex;
        }

        #cameraPreviewImg {
            max-width: 100%;
            max-height: 70vh;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .preview-controls {
            display: flex;
            gap: 30px;
        }

        .preview-btn {
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        #cameraPreviewRetake {
            background: rgba(255, 255, 255, 0.2);
            color: var(--white);
        }

        #cameraPreviewRetake:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        #cameraPreviewAccept {
            background: var(--primary);
            color: var(--white);
        }

        #cameraPreviewAccept:hover {
            background: var(--primary-dark);
        }

        /* Ripple Effect */
        .ripple {
            position: relative;
            overflow: hidden;
        }

        .ripple-effect {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.7);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Responsive Adjustments */
        @media (max-width: 480px) {
            .login-title {
                font-size: 1.5rem;
            }
            
            .login-subtitle {
                font-size: 0.9rem;
            }
            
            .form-control {
                padding: 12px 15px;
            }
            
            .btn {
                padding: 12px 15px;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .section-card {
                padding: 15px;
            }
            
            .team-card, .forum-card {
                padding: 15px;
            }
            
            .chat-header {
                padding: 10px 15px;
            }
            
            .chat-messages {
                padding: 15px;
            }
            
            .chat-input-container {
                padding: 10px;
            }
            
            #profileModal {
                width: 100%;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Animation -->
    <div id="loadingContainer">
        <div id="loadingAnimation"></div>
    </div>

    <!-- Theme Switcher -->
    <div class="theme-switcher" id="themeSwitcher">
        <i class="fas fa-moon"></i>
    </div>

    <!-- Login Container -->
    <div id="loginContainer">
        <div class="login-logo">
            <img src="dnata.jpg" alt="DNATA Logo">
        </div>
        <h1 class="login-title">DNATA Employee Portal</h1>
        <p class="login-subtitle">Sign in to access your dashboard</p>
        
        <!-- Temporary Password Alert -->
        <div id="temporaryPasswordAlert" class="alert alert-warning">
            <i class="fas fa-exclamation-circle"></i>
            <div>Please change your temporary password</div>
        </div>
        
        <!-- Disabled Account Alert -->
        <div id="disabledAccountAlert" class="alert alert-danger">
            <i class="fas fa-ban"></i>
            <div>Your account has been disabled. Please contact HR.</div>
        </div>
        
        <form id="loginForm" class="login-form">
            <div class="form-group">
                <label for="username" class="form-label">Employee ID</label>
                <div class="input-with-icon">
                    <i class="fas fa-user input-icon"></i>
                    <input type="text" id="username" class="form-control" placeholder="Enter your employee ID" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <div class="input-with-icon">
                    <i class="fas fa-lock input-icon"></i>
                    <input type="password" id="password" class="form-control" placeholder="Enter your password" required>
                    <i class="fas fa-eye password-toggle" id="togglePassword"></i>
                </div>
            </div>
            
            <button type="submit" id="loginBtn" class="btn btn-primary btn-block ripple">
                <span id="btnText">Sign In</span>
                <i class="fas fa-spinner btn-spinner" id="btnSpinner"></i>
            </button>
            
            <div class="text-center mt-3">
                <a href="#" id="forgotPassword" class="forgot-password">Forgot Password?</a>
            </div>
        </form>
    </div>

    <!-- Dashboard Container -->
    <div id="dashboardContainer">
        <!-- Fixed Header -->
        <header class="fixed-header">
            <button id="globalBackButton" class="header-btn">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 id="headerTitle" class="header-title">DNATA Employee Portal</h1>
            <div id="headerActions" class="header-actions">
                <div id="headerUserAvatar" class="header-avatar"></div>
                <button id="headerLogoutBtn" class="header-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>
        
        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Dashboard Home Content -->
            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-home"></i> Dashboard</h2>
                <div class="section-card">
                    <div id="userAvatar" class="header-avatar" style="width: 60px; height: 60px; margin: 0 auto 15px;"></div>
                    <h3 style="text-align: center; margin-bottom: 5px;">Welcome Back!</h3>
                    <p style="text-align: center; color: var(--gray); font-size: 0.9rem;">Check your schedule and announcements below</p>
                </div>
            </div>
            
            <!-- Teams Section -->
            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-users"></i> Your Teams</h2>
                <div class="section-card">
                    <div id="teamsList"></div>
                </div>
            </div>
            
            <!-- Announcements Section -->
            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-bullhorn"></i> Announcements</h2>
                <div class="section-card">
                    <div id="announcementsBody"></div>
                </div>
            </div>
        </div>
        
        <!-- Fullscreen Content Sections -->
        <!-- Teams Content -->
        <div id="teamsContent" class="fullscreen-content">
            <h2>Your Team Assignments</h2>
            <div id="teamsModalBody"></div>
        </div>
        
        <!-- Connect Content -->
        <div id="connectContent" class="fullscreen-content">
            <h2>Connect with Colleagues</h2>
            <div class="search-container">
                <input type="text" id="employeeSearchInput" class="search-input" placeholder="Search employees...">
                <button id="employeeSearchBtn" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div id="employeeList"></div>
        </div>
        
        <!-- Forums Content -->
        <div id="forumsContent" class="fullscreen-content">
            <h2>Chat Forums</h2>
            <div id="forumsBody"></div>
        </div>
        
        <!-- Dashboard Icons -->
        <div id="dashboardIconsContainer" class="hidden">
            <div id="dashboardHomeIcon" class="dashboard-icon">
                <i class="fas fa-home"></i>
                <span class="dashboard-icon-text">Home</span>
                <div class="dashboard-icon-tooltip">Dashboard Home</div>
            </div>
            <div id="dashboardTeamsIcon" class="dashboard-icon">
                <i class="fas fa-users"></i>
                <span class="dashboard-icon-text">Teams</span>
                <div class="dashboard-icon-tooltip">View Teams</div>
            </div>
            <div id="dashboardConnectIcon" class="dashboard-icon">
                <i class="fas fa-user-friends"></i>
                <span class="dashboard-icon-text">Connect</span>
                <div class="dashboard-icon-tooltip">Connect</div>
            </div>
            <div id="dashboardForumsIcon" class="dashboard-icon">
                <i class="fas fa-comments"></i>
                <span class="dashboard-icon-text">Forums</span>
                <div class="dashboard-icon-tooltip">Chat Forums</div>
            </div>
        </div>
    </div>
    
    <!-- Chat Modal -->
    <div id="chatModal">
        <div class="chat-header">
            <button class="chat-back-btn" id="chatBackBtn">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 class="chat-title" id="chatForumTitle">Chat</h3>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-container">
            <div class="chat-actions">
                <button class="chat-action-btn" id="fileUploadBtn">
                    <i class="fas fa-paperclip"></i>
                    <input type="file" id="fileUploadInput" style="display: none;">
                </button>
                <button class="chat-action-btn" id="cameraUploadBtn">
                    <i class="fas fa-camera"></i>
                </button>
                <button class="chat-action-btn" id="voiceRecordBtn">
                    <i class="fas fa-microphone"></i>
                </button>
                <div class="recording-indicator" id="recordingIndicator">
                    <div class="recording-dot"></div>
                    <span>Recording</span>
                </div>
            </div>
            <input type="text" id="chatInput" class="chat-input" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Camera Modal -->
    <div id="cameraModal">
        <video id="cameraVideo" autoplay playsinline></video>
        <div class="camera-controls">
            <button class="camera-btn" id="cameraFlipBtn">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="camera-btn" id="cameraCaptureBtn">
                <i class="fas fa-circle"></i>
            </button>
            <button class="camera-btn" id="cameraCloseBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- Camera Preview -->
    <div id="cameraPreview">
        <img id="cameraPreviewImg" alt="Preview">
        <div class="preview-controls">
            <button class="preview-btn" id="cameraPreviewRetake">Retake</button>
            <button class="preview-btn" id="cameraPreviewAccept">Use Photo</button>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Change Password</h3>
                <button class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="currentPassword" class="form-label">Current Password</label>
                    <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password" required>
                </div>
                <div class="form-group">
                    <label for="newPassword" class="form-label">New Password</label>
                    <input type="password" id="newPassword" class="form-control" placeholder="Enter new password" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword" class="form-label">Confirm Password</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelPasswordChange">Cancel</button>
                <button class="btn btn-primary" id="submitNewPassword">Change Password</button>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profileModal">
        <div class="profile-modal-header">
            <h3 class="profile-modal-title">Your Profile</h3>
            <button class="profile-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="profile-modal-body">
            <div class="profile-avatar-container">
                <div id="profileAvatar"></div>
                <button id="profileAvatarEdit">
                    <i class="fas fa-camera"></i>
                    <input type="file" id="profileAvatarInput" accept="image/*">
                </button>
            </div>
            
            <div class="profile-info-item">
                <div class="profile-info-label">Employee ID</div>
                <div class="profile-info-value" id="profileEmployeeId"></div>
            </div>
            
            <div class="profile-info-item">
                <div class="profile-info-label">Name</div>
                <div class="profile-info-value" id="profileName"></div>
            </div>
            
            <div class="profile-info-item">
                <div class="profile-info-label">Department</div>
                <div class="profile-info-value" id="profileDepartment"></div>
            </div>
            
            <div class="profile-info-item">
                <div class="profile-info-label">Position</div>
                <div class="profile-info-value" id="profilePosition"></div>
            </div>
        </div>
        <div class="profile-modal-footer">
            <button class="btn btn-primary btn-block" id="logoutBtn">Sign Out</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.1/lottie.min.js"></script>
 <script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDQfo8qILskxClJy52_19tFdx6xMsiQD2M",
    authDomain: "dnata-e2569.firebaseapp.com",
    databaseURL: "https://dnata-e2569-default-rtdb.firebaseio.com",
    projectId: "dnata-e2569",
    storageBucket: "dnata-e2569.firebasestorage.app",
    messagingSenderId: "693382423789",
    appId: "1:693382423789:web:8aa14672c6ef34ee59d8e4",
    measurementId: "G-B6F7CHPM2Y"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// Initialize OneSignal for push notifications
window.OneSignal = window.OneSignal || [];
OneSignal.push(function() {
    OneSignal.init({
        appId: "8e997ba2-12d1-4d7b-86f5-608d9bf30a56",
        safari_web_id: "web.onesignal.auto.8e997ba2-12d1-4d7b-86f5-608d9bf30a56",
        notifyButton: {
            enable: false
        },
        allowLocalhostAsSecureOrigin: true
    });
    
    // Check if user is logged in to set external user ID
    auth.onAuthStateChanged(user => {
        if (user) {
            const userId = user.email.split('@')[0];
            OneSignal.setExternalUserId(userId);
        }
    });
});

// Initialize loading animation
const loadingAnimation = document.getElementById('loadingAnimation');
const loadingContainer = document.getElementById('loadingContainer');

// Load Lottie animation
const anim = lottie.loadAnimation({
    container: loadingAnimation,
    renderer: 'svg',
    loop: true,
    autoplay: true,
    path: 'https://assets9.lottiefiles.com/packages/lf20_usmfx6bp.json'
});

// Hide loading animation after 1.5 seconds (simulate loading)
setTimeout(() => {
    loadingContainer.classList.add('hidden');
}, 1500);

// Global variables for break management
let breakCheckInterval = null;
let alertedBreaks = new Set();
let teams = []; // Initialize teams array globally
let activeBreakAlerts = []; // Track active break alerts

// Theme switcher functionality
const themeSwitcher = document.getElementById('themeSwitcher');
const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

// Check for saved theme preference or use system preference
const currentTheme = localStorage.getItem('theme');
if (currentTheme === 'dark' || (!currentTheme && prefersDarkScheme.matches)) {
    document.documentElement.setAttribute('data-theme', 'dark');
    themeSwitcher.innerHTML = '<i class="fas fa-sun"></i>';
} else {
    document.documentElement.setAttribute('data-theme', 'light');
    themeSwitcher.innerHTML = '<i class="fas fa-moon"></i>';
}

// Toggle theme when switcher is clicked
themeSwitcher.addEventListener('click', function() {
    if (document.documentElement.getAttribute('data-theme') === 'dark') {
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
        themeSwitcher.innerHTML = '<i class="fas fa-moon"></i>';
    } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
        themeSwitcher.innerHTML = '<i class="fas fa-sun"></i>';
    }
});

// Custom confirmation dialog function
function showConfirmation(options) {
    return new Promise((resolve) => {
        const dialog = document.createElement('div');
        dialog.className = 'confirmation-dialog';
        
        const iconClass = options.type === 'danger' ? 'danger' : 
                         options.type === 'warning' ? 'warning' : 
                         options.type === 'success' ? 'success' : '';
        
        dialog.innerHTML = `
            <div class="confirmation-content">
                <div class="confirmation-header">
                    <div class="confirmation-icon ${iconClass}">
                        <i class="fas ${options.icon || 'fa-question'}"></i>
                    </div>
                    <div>
                        <h3 class="confirmation-title">${options.title || 'Are you sure?'}</h3>
                    </div>
                </div>
                <div class="confirmation-message">${options.message}</div>
                ${options.input ? 
                    `<input type="${options.inputType || 'text'}" class="confirmation-input" 
                           placeholder="${options.inputPlaceholder || ''}" 
                           value="${options.inputValue || ''}">` : ''}
                <div class="confirmation-footer">
                    <button class="confirmation-btn confirmation-btn-cancel">
                        ${options.cancelText || 'Cancel'}
                    </button>
                    <button class="confirmation-btn ${options.danger ? 'confirmation-btn-danger' : 'confirmation-btn-confirm'}">
                        ${options.confirmText || 'Confirm'}
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
        
        setTimeout(() => dialog.classList.add('active'), 10);
        
        const cancelBtn = dialog.querySelector('.confirmation-btn-cancel');
        const confirmBtn = dialog.querySelector('.confirmation-btn-confirm, .confirmation-btn-danger');
        const input = dialog.querySelector('.confirmation-input');
        
        cancelBtn.addEventListener('click', () => {
            dialog.classList.remove('active');
            setTimeout(() => dialog.remove(), 300);
            resolve(options.input ? { confirmed: false } : false);
        });
        
        confirmBtn.addEventListener('click', () => {
            dialog.classList.remove('active');
            setTimeout(() => dialog.remove(), 300);
            if (options.input) {
                resolve({ confirmed: true, value: input.value });
            } else {
                resolve(true);
            }
        });
        
        // Close on ESC key
        document.addEventListener('keydown', function onKeydown(e) {
            if (e.key === 'Escape') {
                dialog.classList.remove('active');
                setTimeout(() => dialog.remove(), 300);
                resolve(options.input ? { confirmed: false } : false);
                document.removeEventListener('keydown', onKeydown);
            }
        });
    });
}

// Replace window.confirm with custom version
window.customConfirm = async (message, options = {}) => {
    return await showConfirmation({
        ...options,
        message: message,
        title: options.title || 'Are you sure?'
    });
};

// Replace window.prompt with custom version
window.customPrompt = async (message, defaultValue = '', options = {}) => {
    const result = await showConfirmation({
        ...options,
        message: message,
        title: options.title || 'Please enter',
        input: true,
        inputValue: defaultValue,
        inputPlaceholder: options.placeholder,
        inputType: options.type
    });
    
    return result.confirmed ? result.value : null;
};

document.addEventListener('DOMContentLoaded', function() {
    // Fixed header elements
    const fixedHeader = document.querySelector('.fixed-header');
    const headerTitle = document.getElementById('headerTitle');
    const headerActions = document.getElementById('headerActions');
    const headerUserAvatar = document.getElementById('headerUserAvatar');
    const headerLogoutBtn = document.getElementById('headerLogoutBtn');
    const globalBackButton = document.getElementById('globalBackButton');

    // Password toggle functionality
    const togglePassword = document.getElementById('togglePassword');
    const password = document.getElementById('password');
    
    togglePassword.addEventListener('click', function() {
        const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
        password.setAttribute('type', type);
        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
        
        // Micro-interaction
        this.style.transform = 'scale(1.2)';
        setTimeout(() => {
            this.style.transform = 'scale(1)';
        }, 200);
    });

    // Ripple effect for buttons
    const buttons = document.querySelectorAll('.ripple');
    buttons.forEach(button => {
        button.addEventListener('click', function(e) {
            const x = e.clientX - e.target.getBoundingClientRect().left;
            const y = e.clientY - e.target.getBoundingClientRect().top;
            
            const ripple = document.createElement('span');
            ripple.classList.add('ripple-effect');
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            
            this.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        });
    });

    // Modal functionality
    const modal = document.getElementById('changePasswordModal');
    const modalCloseButtons = document.querySelectorAll('.modal-close');
    
    modalCloseButtons.forEach(button => {
        button.addEventListener('click', function() {
            modal.classList.remove('active');
        });
    });

    // Profile modal functionality
    const profileModal = document.getElementById('profileModal');
    const profileModalClose = document.querySelector('.profile-modal-close');
    
    profileModalClose.addEventListener('click', function() {
        profileModal.classList.remove('active');
    });

    // Fullscreen content sections
    const fullscreenContents = document.querySelectorAll('.fullscreen-content');
    let currentActiveContent = null;
    let currentActiveIcon = null;

    function showFullscreenContent(contentId) {
        // Hide currently active content with animation
        if (currentActiveContent) {
            currentActiveContent.classList.remove('active');
            if (currentActiveIcon) {
                currentActiveIcon.classList.remove('active');
            }
        }
        
        // Show new content with animation
        const content = document.getElementById(contentId);
        content.classList.add('active');
        currentActiveContent = content;
        
        // Highlight the active icon
        const iconId = contentId.replace('Content', 'Icon');
        currentActiveIcon = document.getElementById(iconId);
        if (currentActiveIcon) {
            currentActiveIcon.classList.add('active');
        }
        
        // Update header title
        const contentTitle = content.querySelector('h2').textContent;
        headerTitle.textContent = contentTitle;
        
        // Show back button in header
        globalBackButton.style.display = 'block';
        
        // Load data if needed
        if (contentId === 'teamsContent') {
            const user = auth.currentUser;
            if (user) {
                const username = user.email.split('@')[0];
                loadEmployeeTeamsForModal(username);
            }
        } else if (contentId === 'connectContent') {
            // Initialize the connect page with all employees
            searchEmployees();
        } else if (contentId === 'forumsContent') {
            loadChatForums();
        }
        
        // Animate in the content
        const elements = content.querySelectorAll('.employee-card, .forum-card, .team-card');
        elements.forEach((el, index) => {
            setTimeout(() => {
                el.classList.add('visible');
            }, index * 100);
        });
    }

    function hideFullscreenContent() {
        if (currentActiveContent) {
            currentActiveContent.classList.remove('active');
            currentActiveContent = null;
            
            if (currentActiveIcon) {
                currentActiveIcon.classList.remove('active');
                currentActiveIcon = null;
            }
        }
        
        // Reset header title
        headerTitle.textContent = 'DNATA Employee Portal';
        
        // Hide back button in header
        globalBackButton.style.display = 'none';
        
        // Show dashboard sections with animation
        const sections = document.querySelectorAll('.dashboard-section');
        sections.forEach((section, index) => {
            setTimeout(() => {
                section.classList.add('visible');
            }, index * 150);
        });
    }

    // Global back button functionality
    globalBackButton.addEventListener('click', function() {
        if (currentActiveContent) {
            // Animate out the current content
            currentActiveContent.style.animation = 'swipeOut 0.4s forwards';
            setTimeout(() => {
                hideFullscreenContent();
                currentActiveContent.style.animation = '';
            }, 400);
        }
    });

    // Dashboard icon click handlers
    document.getElementById('dashboardHomeIcon').addEventListener('click', function() {
        if (currentActiveContent) {
            // Animate out the current content
            currentActiveContent.style.animation = 'swipeOut 0.4s forwards';
            setTimeout(() => {
                hideFullscreenContent();
                currentActiveContent.style.animation = '';
            }, 400);
        }
    });
    
    document.getElementById('dashboardTeamsIcon').addEventListener('click', function() {
        if (currentActiveContent && currentActiveContent.id === 'teamsContent') {
            currentActiveContent.style.animation = 'swipeOut 0.4s forwards';
            setTimeout(() => {
                hideFullscreenContent();
                currentActiveContent.style.animation = '';
            }, 400);
        } else {
            showFullscreenContent('teamsContent');
            document.getElementById('teamsContent').style.animation = 'swipeIn 0.4s forwards';
        }
    });
    
    document.getElementById('dashboardConnectIcon').addEventListener('click', function() {
        if (currentActiveContent && currentActiveContent.id === 'connectContent') {
            currentActiveContent.style.animation = 'swipeOut 0.4s forwards';
            setTimeout(() => {
                hideFullscreenContent();
                currentActiveContent.style.animation = '';
            }, 400);
        } else {
            showFullscreenContent('connectContent');
            document.getElementById('connectContent').style.animation = 'swipeIn 0.4s forwards';
        }
    });
    
    document.getElementById('dashboardForumsIcon').addEventListener('click', function() {
        if (currentActiveContent && currentActiveContent.id === 'forumsContent') {
            currentActiveContent.style.animation = 'swipeOut 0.4s forwards';
            setTimeout(() => {
                hideFullscreenContent();
                currentActiveContent.style.animation = '';
            }, 400);
        } else {
            showFullscreenContent('forumsContent');
            document.getElementById('forumsContent').style.animation = 'swipeIn 0.4s forwards';
        }
    });

    // Employee search functionality
    const employeeSearchInput = document.getElementById('employeeSearchInput');
    const employeeSearchBtn = document.getElementById('employeeSearchBtn');
    const employeeList = document.getElementById('employeeList');
    
    employeeSearchBtn.addEventListener('click', searchEmployees);
    employeeSearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchEmployees();
        }
    });

    function searchEmployees() {
        const searchTerm = employeeSearchInput.value.trim().toLowerCase();
        employeeList.innerHTML = '<div class="no-employees">Searching employees...</div>';
        
        // Add micro-interaction to search button
        employeeSearchBtn.style.transform = 'scale(0.95)';
        setTimeout(() => {
            employeeSearchBtn.style.transform = 'scale(1)';
        }, 200);
        
        db.collection('employees').get()
            .then(snapshot => {
                if (snapshot.empty) {
                    employeeList.innerHTML = '<div class="no-employees">No employees found</div>';
                    return;
                }
                
                let employees = [];
                
                snapshot.forEach(doc => {
                    const employee = doc.data();
                    employee.id = doc.id;
                    
                    // Check if employee matches search term
                    if (!searchTerm || 
                        employee.id.toLowerCase().includes(searchTerm) ||
                        (employee.firstName && employee.firstName.toLowerCase().includes(searchTerm)) ||
                        (employee.lastName && employee.lastName.toLowerCase().includes(searchTerm))) {
                        employees.push(employee);
                    }
                });
                
                if (employees.length === 0) {
                    employeeList.innerHTML = '<div class="no-employees">No employees match your search</div>';
                } else {
                    displayEmployees(employees);
                }
            })
            .catch(error => {
                console.error('Error searching employees:', error);
                employeeList.innerHTML = '<div class="no-employees">Error searching employees. Please try again.</div>';
            });
    }

    function displayEmployees(employees) {
        employeeList.innerHTML = '';
        
        employees.forEach((employee, index) => {
            const employeeCard = document.createElement('div');
            employeeCard.className = 'employee-card';
            
            const initials = `${employee.firstName?.charAt(0) || ''}${employee.lastName?.charAt(0) || ''}`;
            const avatarUrl = employee.avatarUrl || '';
            
            employeeCard.innerHTML = `
                <div class="employee-avatar" style="${avatarUrl ? `background-image: url('${avatarUrl}')` : ''}">
                    ${avatarUrl ? '' : initials}
                </div>
                <div class="employee-info">
                    <div class="employee-name">${employee.firstName || ''} ${employee.lastName || ''}</div>
                    <div class="employee-id">${employee.id}</div>
                    <div class="employee-position">${employee.position || 'Employee'}</div>
                </div>
                <button class="employee-connect-btn" data-employee-id="${employee.id}">
                    <i class="fas fa-paper-plane"></i> Message
                </button>
            `;
            
            employeeList.appendChild(employeeCard);
            
            // Animate each card with a delay
            setTimeout(() => {
                employeeCard.classList.add('visible');
            }, index * 100);
        });
        
        // Add event listeners to connect buttons
        document.querySelectorAll('.employee-connect-btn').forEach(button => {
            button.addEventListener('click', function() {
                const employeeId = this.getAttribute('data-employee-id');
                startPrivateChat(employeeId);
                
                // Micro-interaction
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 200);
            });
        });
    }

    function startPrivateChat(employeeId) {
        const user = auth.currentUser;
        if (!user) return;
        
        const currentUserId = user.email.split('@')[0];
        
        // Check if a private chat already exists between these users
        const chatId = [currentUserId, employeeId].sort().join('_');
        
        db.collection('privateChats').doc(chatId).get()
            .then(doc => {
                if (!doc.exists) {
                    // Create a new private chat
                    return db.collection('privateChats').doc(chatId).set({
                        participants: [currentUserId, employeeId],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            })
            .then(() => {
                // Open the chat
                openPrivateChat(chatId, employeeId);
                
                // Send push notification to the other user
                sendPushNotification(
                    employeeId,
                    'New Message',
                    `You have a new message from ${currentUserId}`,
                    { 
                        chatId: chatId,
                        type: 'new_message'
                    }
                );
            })
            .catch(error => {
                console.error('Error starting private chat:', error);
                alert('Error starting private chat. Please try again.');
            });
    }

    // Function to send push notifications
    function sendPushNotification(userId, title, message, data = {}) {
        // Send via OneSignal
        OneSignal.push(function() {
            OneSignal.sendTags({
                userId: userId
            }).then(function() {
                OneSignal.push(function() {
                    OneSignal.sendSelfNotification({
                        app_id: "8e997ba2-12d1-4d7b-86f5-608d9bf30a56",
                        headings: { en: title },
                        contents: { en: message },
                        data: data,
                        include_player_ids: [userId]
                    });
                });
            });
        });
        
        // Fallback to Firebase if OneSignal fails
        db.collection('employees').doc(userId).get()
            .then(doc => {
                if (doc.exists) {
                    const fcmToken = doc.data().fcmToken;
                    if (fcmToken) {
                        fetch('https://fcm.googleapis.com/fcm/send', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'key=os_v2_app_r2mxxiqs2fgxxbxvmcgzx4ykkyoyqqjupcoerwvga7cpdam66tnoxcptb2cco4qo7ert4gyu4lak4ggsthudg5ny7wqjykhlg3re7oy'
                            },
                            body: JSON.stringify({
                                to: fcmToken,
                                notification: {
                                    title: title,
                                    body: message
                                },
                                data: data
                            })
                        });
                    }
                }
            });
    }

    function openPrivateChat(chatId, employeeId) {
        currentForumId = chatId;
        
        // Get the employee's name for the chat title
        db.collection('employees').doc(employeeId).get()
            .then(doc => {
                if (doc.exists) {
                    const employee = doc.data();
                    chatForumTitle.textContent = `${employee.firstName || ''} ${employee.lastName || ''}`;
                    chatModal.classList.add('active');
                    chatMessages.innerHTML = '<div class="no-messages">Loading messages...</div>';
                    
                    // Load messages for this private chat
                    loadPrivateMessages(chatId);
                }
            });
    }

    function loadPrivateMessages(chatId) {
        if (unsubscribeMessages) {
            unsubscribeMessages();
        }

        const messagesQuery = db.collection('privateChats').doc(chatId)
            .collection('messages')
            .orderBy('timestamp', 'asc')
            .limit(100);

        unsubscribeMessages = messagesQuery.onSnapshot(snapshot => {
            if (snapshot.empty) {
                chatMessages.innerHTML = '<div class="no-messages">No messages yet. Start the conversation!</div>';
                return;
            }

            chatMessages.innerHTML = '';
            const user = auth.currentUser;
            const currentUser = user ? user.email.split('@')[0] : null;

            snapshot.forEach(doc => {
                const message = doc.data();
                const messageElement = createMessageElement(message, currentUser, doc.id);
                chatMessages.appendChild(messageElement);
            });

            // Scroll to bottom with smooth behavior
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }, error => {
            console.error('Error loading private messages:', error);
            chatMessages.innerHTML = '<div class="no-messages">Error loading messages. Please try again.</div>';
        });
    }

    // Load announcements for dashboard
    function loadAnnouncements() {
        const announcementsBody = document.getElementById('announcementsBody');
        announcementsBody.innerHTML = '<div class="no-announcements">Loading announcements...</div>';
        
        db.collection('announcements')
            .orderBy('date', 'desc')
            .limit(5) // Show only 5 most recent announcements on dashboard
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    announcementsBody.innerHTML = '<div class="no-announcements">No announcements found.</div>';
                    return;
                }
                
                announcementsBody.innerHTML = '';
                
                snapshot.forEach((doc, index) => {
                    const announcement = doc.data();
                    const date = announcement.date.toDate();
                    const formattedDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const announcementItem = document.createElement('div');
                    announcementItem.className = 'announcement-item';
                    
                    let announcementContent = `
                        <div class="announcement-header">
                            <div class="announcement-title">${announcement.title}</div>
                            <div class="announcement-date">${formattedDate}</div>
                        </div>
                        <div class="announcement-content" style="display: none;">
                            ${announcement.content}
                    `;
                    
                    // Add image if available
                    if (announcement.imageUrl) {
                        announcementContent += `
                            <img src="${announcement.imageUrl}" alt="Announcement Image" class="announcement-image">
                        `;
                    }
                    
                    announcementContent += `
                            <div class="announcement-author">Posted by: ${announcement.author || 'Management'}</div>
                        </div>
                    `;
                    
                    announcementItem.innerHTML = announcementContent;
                    announcementsBody.appendChild(announcementItem);
                    
                    // Add click event to toggle content
                    announcementItem.addEventListener('click', function() {
                        this.classList.toggle('expanded');
                        const content = this.querySelector('.announcement-content');
                        if (this.classList.contains('expanded')) {
                            content.style.display = 'block';
                        } else {
                            content.style.display = 'none';
                        }
                    });
                    
                    // Animate each item with a delay
                    setTimeout(() => {
                        announcementItem.classList.add('visible');
                    }, index * 150);
                });
            })
            .catch(error => {
                console.error('Error loading announcements:', error);
                announcementsBody.innerHTML = '<div class="no-announcements">Error loading announcements. Please try again later.</div>';
            });
    }

    // Load employee's teams for dashboard
    function loadEmployeeTeams(employeeId) {
        const teamsList = document.getElementById('teamsList');
        teamsList.innerHTML = '<div class="no-teams">Loading your team assignments...</div>';
        
        // Get current date
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Query teams where this employee is a member
        db.collection('teams')
            .where('date', '>=', today.toISOString().split('T')[0])
            .orderBy('date')
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    teamsList.innerHTML = '<div class="no-teams">You have no upcoming team assignments.</div>';
                    return;
                }
                
                teams = []; // Reset teams array
                
                snapshot.forEach(doc => {
                    const team = doc.data();
                    team.id = doc.id;
                    
                    // Check if employee is in this team
                    if (isEmployeeInTeam(employeeId, team)) {
                        teams.push(team);
                    }
                });
                
                if (teams.length === 0) {
                    teamsList.innerHTML = '<div class="no-teams">You have no upcoming team assignments.</div>';
                } else {
                    displayTeams(teams, teamsList);
                }
                
                // Start checking for break times
                startBreakCheck();
            })
            .catch(error => {
                console.error('Error loading teams:', error);
                teamsList.innerHTML = '<div class="no-teams">Error loading your team assignments. Please try again later.</div>';
            });
    }

    // Load employee's teams for modal
    function loadEmployeeTeamsForModal(employeeId) {
        const teamsModalBody = document.getElementById('teamsModalBody');
        teamsModalBody.innerHTML = '<div class="no-teams">Loading your team assignments...</div>';
        
        // Get all teams (past and future)
        db.collection('teams')
            .orderBy('date')
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    teamsModalBody.innerHTML = '<div class="no-teams">You have no team assignments.</div>';
                    return;
                }
                
                let modalTeams = [];
                
                snapshot.forEach(doc => {
                    const team = doc.data();
                    team.id = doc.id;
                    
                    // Check if employee is in this team
                    if (isEmployeeInTeam(employeeId, team)) {
                        modalTeams.push(team);
                    }
                });
                
                if (modalTeams.length === 0) {
                    teamsModalBody.innerHTML = '<div class="no-teams">You have no team assignments.</div>';
                } else {
                    displayTeams(modalTeams, teamsModalBody);
                }
            })
            .catch(error => {
                console.error('Error loading teams:', error);
                teamsModalBody.innerHTML = '<div class="no-teams">Error loading your team assignments. Please try again later.</div>';
            });
    }

    // Check if employee is in a team
    function isEmployeeInTeam(employeeId, team) {
        // Check supervisor
        if (team.supervisor && team.supervisor.id === employeeId) {
            return true;
        }
        
        // Check staff (handles both single staff and array)
        if (team.staff) {
            if (Array.isArray(team.staff)) {
                if (team.staff.some(staff => staff.id === employeeId)) {
                    return true;
                }
            } else if (team.staff.id === employeeId) {
                return true;
            }
        }
        
        // Check porters
        if (team.porters && team.porters.some(porter => porter.id === employeeId)) {
            return true;
        }
        
        // Check forklift operators (handles both single and array)
        if (team.forkliftOperator && team.forkliftOperator.id === employeeId) {
            return true;
        }
        
        if (team.forkliftOperators && team.forkliftOperators.some(forklift => forklift.id === employeeId)) {
            return true;
        }
        
        return false;
    }

    // Display teams in the specified container
    function displayTeams(teamsToDisplay, container) {
        container.innerHTML = '';
        
        teamsToDisplay.forEach((team, index) => {
            const teamCard = document.createElement('div');
            teamCard.className = 'team-card';
            
            // Format date
            const date = new Date(team.date);
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Format shift
            const shift = team.shift === 'morning' ? 'Morning (6:00 AM - 6:00 PM)' : 'Night (6:00 PM - 6:00 AM)';
            
            // Determine if this is a past team
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isPastTeam = date < today;
            
            // Format breaks information
            let breaksHTML = '';
            if (team.breaks && (team.breaks.teamBreaks || team.breaks.individualBreaks)) {
                const teamBreaks = team.breaks.teamBreaks || [];
                const individualBreaks = team.breaks.individualBreaks || [];
                
                if (teamBreaks.length > 0 || individualBreaks.length > 0) {
                    breaksHTML = `
                        <div class="break-schedule">
                            <div class="break-title">
                                <i class="fas fa-clock"></i> Break Schedule
                            </div>
                            ${teamBreaks.slice(0, 2).map(breakItem => `
                                <div class="break-item">
                                    <div class="break-time">Team: ${formatTime(breakItem.start)} - ${formatTime(breakItem.end)}</div>
                                    <div class="break-duration">${calculateDuration(breakItem.start, breakItem.end)}</div>
                                </div>
                            `).join('')}
                            ${individualBreaks.length > 0 ? `
                                <div class="break-item">
                                    <div class="break-time">${individualBreaks.length} individual breaks</div>
                                </div>
                            ` : ''}
                            ${teamBreaks.length > 2 ? `
                                <div class="break-item">
                                    <div class="break-time">+${teamBreaks.length - 2} more team breaks</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            }
            
            teamCard.innerHTML = `
                <div class="team-header">
                    <div class="team-name">${team.name} ${isPastTeam ? '<span style="color: var(--gray); font-size: 0.8rem;">(Completed)</span>' : ''}</div>
                    <div class="team-date">${formattedDate}</div>
                </div>
                <div class="team-details">
                    <div class="team-detail">
                        <div class="team-label">Shift:</div>
                        <div class="team-value">${shift}</div>
                    </div>
                    <div class="team-detail">
                        <div class="team-label">Location:</div>
                        <div class="team-value">${team.location || 'Not specified'}</div>
                    </div>
                    <div class="team-detail">
                        <div class="team-label">Area:</div>
                        <div class="team-value">${team.area || 'Not specified'}</div>
                    </div>
                </div>
                ${breaksHTML}
                <div class="team-members">
                    <h4>Team Members</h4>
                    ${team.supervisor ? `
                        <div class="member-item">
                            <div class="member-role">Supervisor:</div>
                            <div class="member-name">${team.supervisor.name} <span class="supervisor-badge">Team Leader</span></div>
                        </div>
                    ` : ''}
                    ${team.staff ? 
                        (Array.isArray(team.staff) ? 
                            team.staff.map(staff => `
                                <div class="member-item">
                                    <div class="member-role">Staff:</div>
                                    <div class="member-name">${staff.name}</div>
                                </div>
                            `).join('') : `
                            <div class="member-item">
                                <div class="member-role">Staff:</div>
                                <div class="member-name">${team.staff.name}</div>
                            </div>
                            `) : ''}
                    ${team.porters ? team.porters.map(porter => `
                        <div class="member-item">
                            <div class="member-role">Porter:</div>
                            <div class="member-name">${porter.name}</div>
                        </div>
                    `).join('') : ''}
                    ${team.forkliftOperator ? `
                        <div class="member-item">
                            <div class="member-role">Forklift Operator:</div>
                            <div class="member-name">${team.forkliftOperator.name}</div>
                        </div>
                    ` : ''}
                    ${team.forkliftOperators ? team.forkliftOperators.map(forklift => `
                        <div class="member-item">
                            <div class="member-role">Forklift Operator:</div>
                            <div class="member-name">${forklift.name}</div>
                        </div>
                    `).join('') : ''}
                </div>
            `;
            
            container.appendChild(teamCard);
            
            // Animate each card with a delay
            setTimeout(() => {
                teamCard.classList.add('visible');
            }, index * 100);
        });
    }

    // Format time for display (HH:MM AM/PM)
    function formatTime(timeString) {
        if (!timeString) return '';
        
        const [hours, minutes] = timeString.split(':');
        const hourNum = parseInt(hours, 10);
        const period = hourNum >= 12 ? 'PM' : 'AM';
        const displayHour = hourNum % 12 || 12;
        
        return `${displayHour}:${minutes} ${period}`;
    }

    // Calculate duration between two times
    function calculateDuration(startTime, endTime) {
        if (!startTime || !endTime) return '';
        
        const [startHours, startMinutes] = startTime.split(':').map(Number);
        const [endHours, endMinutes] = endTime.split(':').map(Number);
        
        let totalMinutes = (endHours * 60 + endMinutes) - (startHours * 60 + startMinutes);
        
        if (totalMinutes < 0) {
            totalMinutes += 24 * 60; // Handle overnight breaks
        }
        
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        
        return `${hours > 0 ? hours + 'h ' : ''}${minutes}m`;
    }

    // Start checking for break times
    function startBreakCheck() {
        if (breakCheckInterval) {
            clearInterval(breakCheckInterval);
        }
        
        // Check every minute
        breakCheckInterval = setInterval(checkBreakTimes, 60000);
        
        // Initial check
        checkBreakTimes();
    }

    // Check if any breaks are starting or ending soon
    function checkBreakTimes() {
        const now = new Date();
        const currentHours = now.getHours().toString().padStart(2, '0');
        const currentMinutes = now.getMinutes().toString().padStart(2, '0');
        const currentTime = `${currentHours}:${currentMinutes}`;
        
        const user = auth.currentUser;
        if (!user) return;
        
        const currentUserId = user.email.split('@')[0];
        
        // Get all teams where the current user is a member
        const userTeams = teams.filter(team => isEmployeeInTeam(currentUserId, team));
        
        userTeams.forEach(team => {
            if (!team.breaks) return;
            
            // Check team breaks
            if (team.breaks.teamBreaks) {
                team.breaks.teamBreaks.forEach((breakItem, index) => {
                    const breakKey = `team-${team.id}-${index}`;
                    
                    // Check if break is starting within 5 minutes
                    if (isTimeWithinRange(currentTime, breakItem.start, 5) && !alertedBreaks.has(`start-${breakKey}`)) {
                        alertedBreaks.add(`start-${breakKey}`);
                        const notificationTitle = `Team Break Starting Soon`;
                        const notificationMessage = `Team ${team.name}'s break starts at ${formatTime(breakItem.start)}`;
                        
                        showBreakAlert(notificationTitle, notificationMessage, 'team');
                        
                        // Send push notification
                        sendPushNotification(
                            currentUserId,
                            notificationTitle,
                            notificationMessage,
                            {
                                type: 'break_alert',
                                breakType: 'team',
                                teamId: team.id,
                                action: 'starting'
                            }
                        );
                    }
                    
                    // Check if break has just started
                    if (isTimeWithinRange(currentTime, breakItem.start, 1) && !alertedBreaks.has(`started-${breakKey}`)) {
                        alertedBreaks.add(`started-${breakKey}`);
                        const notificationTitle = `Team Break Started`;
                        const notificationMessage = `Team ${team.name}'s break has started! Enjoy your break until ${formatTime(breakItem.end)}`;
                        
                        showBreakAlert(notificationTitle, notificationMessage, 'team');
                        
                        // Send push notification
                        sendPushNotification(
                            currentUserId,
                            notificationTitle,
                            notificationMessage,
                            {
                                type: 'break_alert',
                                breakType: 'team',
                                teamId: team.id,
                                action: 'started'
                            }
                        );
                    }
                    
                    // Check if break is ending within 5 minutes
                    if (isTimeWithinRange(currentTime, breakItem.end, 5) && !alertedBreaks.has(`end-${breakKey}`)) {
                        alertedBreaks.add(`end-${breakKey}`);
                        const notificationTitle = `Team Break Ending Soon`;
                        const notificationMessage = `Team ${team.name}'s break ends at ${formatTime(breakItem.end)}`;
                        
                        showBreakAlert(notificationTitle, notificationMessage, 'team');
                        
                        // Send push notification
                        sendPushNotification(
                            currentUserId,
                            notificationTitle,
                            notificationMessage,
                            {
                                type: 'break_alert',
                                breakType: 'team',
                                teamId: team.id,
                                action: 'ending'
                            }
                        );
                    }
                });
            }
            
            // Check individual breaks for this user
            if (team.breaks.individualBreaks) {
                team.breaks.individualBreaks.forEach((breakItem, index) => {
                    if (breakItem.employeeId === currentUserId) {
                        const breakKey = `individual-${team.id}-${index}`;
                        
                        // Check if break is starting within 5 minutes
                        if (isTimeWithinRange(currentTime, breakItem.start, 5) && !alertedBreaks.has(`start-${breakKey}`)) {
                            alertedBreaks.add(`start-${breakKey}`);
                            const notificationTitle = `Your Break Starting Soon`;
                            const notificationMessage = `Your break starts at ${formatTime(breakItem.start)} (Team: ${team.name})`;
                            
                            showBreakAlert(notificationTitle, notificationMessage, 'individual');
                            
                            // Send push notification
                            sendPushNotification(
                                currentUserId,
                                notificationTitle,
                                notificationMessage,
                                {
                                    type: 'break_alert',
                                    breakType: 'individual',
                                    teamId: team.id,
                                    action: 'starting'
                                }
                            );
                        }
                        
                        // Check if break has just started
                        if (isTimeWithinRange(currentTime, breakItem.start, 1) && !alertedBreaks.has(`started-${breakKey}`)) {
                            alertedBreaks.add(`started-${breakKey}`);
                            const notificationTitle = `Your Break Started`;
                            const notificationMessage = `Your break has started! Enjoy your break until ${formatTime(breakItem.end)} (Team: ${team.name})`;
                            
                            showBreakAlert(notificationTitle, notificationMessage, 'individual');
                            
                            // Send push notification
                            sendPushNotification(
                                currentUserId,
                                notificationTitle,
                                notificationMessage,
                                {
                                    type: 'break_alert',
                                    breakType: 'individual',
                                    teamId: team.id,
                                    action: 'started'
                                }
                            );
                        }
                        
                        // Check if break is ending within 5 minutes
                        if (isTimeWithinRange(currentTime, breakItem.end, 5) && !alertedBreaks.has(`end-${breakKey}`)) {
                            alertedBreaks.add(`end-${breakKey}`);
                            const notificationTitle = `Your Break Ending Soon`;
                            const notificationMessage = `Your break ends at ${formatTime(breakItem.end)} (Team: ${team.name})`;
                            
                            showBreakAlert(notificationTitle, notificationMessage, 'individual');
                            
                            // Send push notification
                            sendPushNotification(
                                currentUserId,
                                notificationTitle,
                                notificationMessage,
                                {
                                    type: 'break_alert',
                                    breakType: 'individual',
                                    teamId: team.id,
                                    action: 'ending'
                                }
                            );
                        }
                    }
                });
            }
        });
    }

    // Check if time is within range of target time (in minutes)
    function isTimeWithinRange(currentTime, targetTime, rangeMinutes) {
        const [currentH, currentM] = currentTime.split(':').map(Number);
        const [targetH, targetM] = targetTime.split(':').map(Number);
        
        const currentTotal = currentH * 60 + currentM;
        const targetTotal = targetH * 60 + targetM;
        
        // Check if current time is within rangeMinutes of target time
        return Math.abs(currentTotal - targetTotal) <= rangeMinutes;
    }

    // Show break alert with sound and vibration
    function showBreakAlert(title, message, type) {
        // Close any existing alerts of the same type
        closeBreakAlerts(type);
        
        const breakAlert = document.createElement('div');
        breakAlert.className = `break-alert break-alert-${type}`;
        breakAlert.dataset.type = type;
        
        // Add animation class
        breakAlert.classList.add('break-alert-popup');
        
        breakAlert.innerHTML = `
            <div class="break-alert-content">
                <div class="break-alert-header">
                    <div class="break-alert-icon">
                        <i class="fas ${type === 'team' ? 'fa-users' : 'fa-user'}"></i>
                    </div>
                    <div class="break-alert-title">
                        <h4>${title}</h4>
                        <div class="break-alert-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                    <button class="break-alert-close">&times;</button>
                </div>
                <div class="break-alert-body">
                    ${message}
                </div>
                <div class="break-alert-footer">
                    <button class="break-alert-action" onclick="handleBreakAction('snooze', this)">
                        <i class="fas fa-clock"></i> Snooze (5 min)
                    </button>
                    <button class="break-alert-action" onclick="handleBreakAction('dismiss', this)">
                        <i class="fas fa-check"></i> Dismiss
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(breakAlert);
        activeBreakAlerts.push(breakAlert);
        
        // Play notification sound
        try {
            const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
            audio.play().catch(e => console.log('Audio play failed:', e));
        } catch (e) {
            console.log('Audio error:', e);
        }
        
        // Vibrate device if supported
        try {
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        } catch (e) {
            console.log('Vibration error:', e);
        }
        
        // Auto-remove after 30 seconds if not manually dismissed
        const autoDismissTimer = setTimeout(() => {
            if (breakAlert.parentNode) {
                breakAlert.classList.add('break-alert-fadeout');
                setTimeout(() => {
                    breakAlert.remove();
                    activeBreakAlerts = activeBreakAlerts.filter(alert => alert !== breakAlert);
                }, 300);
            }
        }, 30000);
        
        // Store timer reference for manual dismissal
        breakAlert.dataset.dismissTimer = autoDismissTimer;
        
        // Close button functionality
        breakAlert.querySelector('.break-alert-close').addEventListener('click', () => {
            clearTimeout(autoDismissTimer);
            breakAlert.classList.add('break-alert-fadeout');
            setTimeout(() => {
                breakAlert.remove();
                activeBreakAlerts = activeBreakAlerts.filter(alert => alert !== breakAlert);
            }, 300);
        });
    }

    // Close all break alerts of a specific type
    function closeBreakAlerts(type) {
        activeBreakAlerts.forEach(alert => {
            if (alert.dataset.type === type) {
                clearTimeout(alert.dataset.dismissTimer);
                alert.classList.add('break-alert-fadeout');
                setTimeout(() => {
                    alert.remove();
                }, 300);
            }
        });
        activeBreakAlerts = activeBreakAlerts.filter(alert => alert.dataset.type !== type);
    }

    // Handle break alert actions (snooze or dismiss)
    window.handleBreakAction = function(action, button) {
        const breakAlert = button.closest('.break-alert');
        if (!breakAlert) return;
        
        clearTimeout(breakAlert.dataset.dismissTimer);
        
        if (action === 'snooze') {
            // Change button to show loading state
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Snoozing...';
            button.disabled = true;
            
            // Snooze for 5 minutes
            setTimeout(() => {
                // Reshow the alert
                const title = breakAlert.querySelector('h4').textContent;
                const message = breakAlert.querySelector('.break-alert-body').textContent.trim();
                const type = breakAlert.dataset.type;
                
                breakAlert.classList.add('break-alert-fadeout');
                setTimeout(() => {
                    breakAlert.remove();
                    activeBreakAlerts = activeBreakAlerts.filter(alert => alert !== breakAlert);
                    showBreakAlert(title, message, type);
                }, 300);
            }, 5000);
        } else {
            // Dismiss the alert
            breakAlert.classList.add('break-alert-fadeout');
            setTimeout(() => {
                breakAlert.remove();
                activeBreakAlerts = activeBreakAlerts.filter(alert => alert !== breakAlert);
            }, 300);
        }
    };

    // Chat modal functionality
    const chatModal = document.getElementById('chatModal');
    const chatBackBtn = document.getElementById('chatBackBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatForumTitle = document.getElementById('chatForumTitle');
    const fileUploadBtn = document.getElementById('fileUploadBtn');
    const fileUploadInput = document.getElementById('fileUploadInput');
    const cameraUploadBtn = document.getElementById('cameraUploadBtn');
    const voiceRecordBtn = document.getElementById('voiceRecordBtn');
    const recordingIndicator = document.getElementById('recordingIndicator');
    
    let currentForumId = null;
    let currentForumName = '';
    let unsubscribeMessages = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    // Chat back button functionality
    chatBackBtn.addEventListener('click', function() {
        chatModal.classList.remove('active');
        if (unsubscribeMessages) {
            unsubscribeMessages();
            unsubscribeMessages = null;
        }
    });

    // Camera functionality
    const cameraModal = document.getElementById('cameraModal');
    const cameraVideo = document.getElementById('cameraVideo');
    const cameraCloseBtn = document.getElementById('cameraCloseBtn');
    const cameraCaptureBtn = document.getElementById('cameraCaptureBtn');
    const cameraFlipBtn = document.getElementById('cameraFlipBtn');
    const cameraPreview = document.getElementById('cameraPreview');
    const cameraPreviewImg = document.getElementById('cameraPreviewImg');
    const cameraPreviewRetake = document.getElementById('cameraPreviewRetake');
    const cameraPreviewAccept = document.getElementById('cameraPreviewAccept');
    
    let stream = null;
    let facingMode = "user"; // front camera by default

    // Open camera modal
    cameraUploadBtn.addEventListener('click', async function() {
        try {
            // Stop any existing stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            // Get camera stream
            stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            });
            
            cameraVideo.srcObject = stream;
            cameraModal.classList.add('active');
        } catch (error) {
            console.error('Error accessing camera:', error);
            alert('Could not access camera. Please check permissions.');
        }
    });

    // Close camera modal
    cameraCloseBtn.addEventListener('click', function() {
        cameraModal.classList.remove('active');
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    });

    // Flip camera
    cameraFlipBtn.addEventListener('click', function() {
        facingMode = facingMode === "user" ? "environment" : "user";
        // Restart camera with new facing mode
        cameraUploadBtn.click();
    });

    // Capture photo
    cameraCaptureBtn.addEventListener('click', function() {
        const canvas = document.createElement('canvas');
        canvas.width = cameraVideo.videoWidth;
        canvas.height = cameraVideo.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
        
        cameraPreviewImg.src = canvas.toDataURL('image/jpeg');
        cameraModal.classList.remove('active');
        cameraPreview.classList.add('active');
        
        // Stop camera stream
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    });

    // Retake photo
    cameraPreviewRetake.addEventListener('click', function() {
        cameraPreview.classList.remove('active');
        cameraUploadBtn.click();
    });

    // Accept photo and upload
    cameraPreviewAccept.addEventListener('click', function() {
        cameraPreview.classList.remove('active');
        
        // Convert data URL to blob
        fetch(cameraPreviewImg.src)
            .then(res => res.blob())
            .then(blob => {
                // Create a file from the blob
                const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
                uploadFile(file);
            });
    });

    // Voice recording functionality
    voiceRecordBtn.addEventListener('click', toggleRecording);

    async function toggleRecording() {
        if (isRecording) {
            stopRecording();
        } else {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                startRecording(stream);
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }
    }

    function startRecording(stream) {
        isRecording = true;
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        voiceRecordBtn.classList.add('recording');
        recordingIndicator.style.display = 'flex';
        
        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
            await uploadAudio(audioBlob);
        };
        
        mediaRecorder.start();
        
        // Stop recording after 2 minutes (safety limit)
        setTimeout(() => {
            if (isRecording) {
                stopRecording();
            }
        }, 120000);
    }

    function stopRecording() {
        if (!isRecording) return;
        
        isRecording = false;
        mediaRecorder.stop();
        voiceRecordBtn.classList.remove('recording');
        recordingIndicator.style.display = 'none';
        
        // Stop all tracks in the stream
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
    }

    async function uploadAudio(audioBlob) {
        if (!currentForumId || audioBlob.size === 0) return;
        
        const user = auth.currentUser;
        if (!user) return;
        
        const username = user.email.split('@')[0];
        const timestamp = firebase.firestore.FieldValue.serverTimestamp();
        
        // Create a unique filename
        const uniqueFilename = `audio_${Date.now()}.mp3`;
        const storageRef = storage.ref(`forum_audio/${currentForumId}/${uniqueFilename}`);
        
        try {
            // Show uploading indicator
            const originalBtnText = voiceRecordBtn.innerHTML;
            voiceRecordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            voiceRecordBtn.disabled = true;
            
            // Upload audio file
            const uploadTask = storageRef.put(audioBlob);
            
            await new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    null,
                    error => reject(error),
                    () => resolve()
                );
            });
            
            // Get download URL
            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
            
            // Save audio info to Firestore
            if (currentForumId.includes('_')) {
                // Private chat
                await db.collection('privateChats').doc(currentForumId).collection('messages').add({
                    audio: {
                        url: downloadURL,
                        duration: Math.floor(audioBlob.size / 6000) // Rough estimate in seconds
                    },
                    sender: username,
                    timestamp: timestamp
                });
                
                // Send push notification to the other participant
                const chatParts = currentForumId.split('_');
                const recipientId = chatParts[0] === username ? chatParts[1] : chatParts[0];
                
                sendPushNotification(
                    recipientId,
                    'New Voice Message',
                    `You have a new voice message from ${username}`,
                    {
                        chatId: currentForumId,
                        type: 'new_message'
                    }
                );
            } else {
                // Forum chat
                await db.collection('chatForums').doc(currentForumId).collection('messages').add({
                    audio: {
                        url: downloadURL,
                        duration: Math.floor(audioBlob.size / 6000) // Rough estimate in seconds
                    },
                    sender: username,
                    timestamp: timestamp
                });
                
                // Send push notification to all forum members
                const forumDoc = await db.collection('chatForums').doc(currentForumId).get();
                if (forumDoc.exists) {
                    const forum = forumDoc.data();
                    if (forum.members && forum.members.length > 0) {
                        forum.members.forEach(memberId => {
                            if (memberId !== username) {
                                sendPushNotification(
                                    memberId,
                                    'New Voice Message',
                                    `New voice message in ${forum.name}`,
                                    {
                                        chatId: currentForumId,
                                        type: 'forum_message'
                                    }
                                );
                            }
                        });
                    }
                }
            }
            
        } catch (error) {
            console.error('Error uploading audio:', error);
            alert('Error uploading voice message. Please try again.');
        } finally {
            // Reset button
            voiceRecordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceRecordBtn.disabled = false;
        }
    }

    // File upload functionality
    fileUploadBtn.addEventListener('click', function() {
        fileUploadInput.click();
    });

    fileUploadInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            alert('File size too large. Maximum size is 5MB.');
            return;
        }

        uploadFile(file);
    });

    function uploadFile(file) {
        const user = auth.currentUser;
        if (!user || !currentForumId) return;

        const username = user.email.split('@')[0];
        const timestamp = firebase.firestore.FieldValue.serverTimestamp();
        
        // Create a unique filename to prevent overwrites
        const uniqueFilename = Date.now() + '_' + file.name;
        let storageRef;
        
        if (currentForumId.includes('_')) {
            // Private chat
            storageRef = storage.ref(`private_chat_files/${currentForumId}/${uniqueFilename}`);
        } else {
            // Forum chat
            storageRef = storage.ref(`forum_files/${currentForumId}/${uniqueFilename}`);
        }
        
        const uploadTask = storageRef.put(file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                // Progress monitoring can be added here
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Upload is ' + progress + '% done');
            }, 
            (error) => {
                console.error('Error uploading file:', error);
                alert('Error uploading file. Please try again.');
            }, 
            () => {
                uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                    // Save file info to Firestore
                    let savePromise;
                    
                    if (currentForumId.includes('_')) {
                        savePromise = db.collection('privateChats').doc(currentForumId).collection('messages').add({
                            file: {
                                url: downloadURL,
                                type: file.type,
                                size: file.size
                            },
                            sender: username,
                            timestamp: timestamp
                        });
                        
                        // Send push notification to the other participant
                        const chatParts = currentForumId.split('_');
                        const recipientId = chatParts[0] === username ? chatParts[1] : chatParts[0];
                        
                        sendPushNotification(
                            recipientId,
                            'New File Shared',
                            `${username} shared a file with you`,
                            {
                                chatId: currentForumId,
                                type: 'new_message'
                            }
                        );
                    } else {
                        savePromise = db.collection('chatForums').doc(currentForumId).collection('messages').add({
                            file: {
                                url: downloadURL,
                                type: file.type,
                                size: file.size
                            },
                            sender: username,
                            timestamp: timestamp
                        });
                        
                        // Send push notification to all forum members
                        db.collection('chatForums').doc(currentForumId).get()
                            .then(forumDoc => {
                                if (forumDoc.exists) {
                                    const forum = forumDoc.data();
                                    if (forum.members && forum.members.length > 0) {
                                        forum.members.forEach(memberId => {
                                            if (memberId !== username) {
                                                sendPushNotification(
                                                    memberId,
                                                    'New File Shared',
                                                    `New file shared in ${forum.name}`,
                                                    {
                                                        chatId: currentForumId,
                                                        type: 'forum_message'
                                                    }
                                                );
                                            }
                                        });
                                    }
                                }
                            });
                    }
                    
                    savePromise.then(() => {
                        // Clear the file input
                        fileUploadInput.value = '';
                    })
                    .catch(error => {
                        console.error('Error saving file info:', error);
                        alert('Error saving file information. Please try again.');
                    });
                });
            }
        );
    }

    // Send message functionality
    chatSendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        const messageText = chatInput.value.trim();
        if (!messageText || !currentForumId) return;

        const user = auth.currentUser;
        if (!user) return;

        const username = user.email.split('@')[0];
        const timestamp = firebase.firestore.FieldValue.serverTimestamp();

        let savePromise;
        
        if (currentForumId.includes('_')) {
            savePromise = db.collection('privateChats').doc(currentForumId).collection('messages').add({
                text: messageText,
                sender: username,
                timestamp: timestamp
            });
            
            // Send push notification to the other participant
            const chatParts = currentForumId.split('_');
            const recipientId = chatParts[0] === username ? chatParts[1] : chatParts[0];
            
            sendPushNotification(
                recipientId,
                'New Message',
                `New message from ${username}`,
                {
                    chatId: currentForumId,
                    type: 'new_message'
                }
            );
        } else {
            savePromise = db.collection('chatForums').doc(currentForumId).collection('messages').add({
                text: messageText,
                sender: username,
                timestamp: timestamp
            });
            
            // Send push notification to all forum members
            db.collection('chatForums').doc(currentForumId).get()
                .then(forumDoc => {
                    if (forumDoc.exists) {
                        const forum = forumDoc.data();
                        if (forum.members && forum.members.length > 0) {
                            forum.members.forEach(memberId => {
                                if (memberId !== username) {
                                    sendPushNotification(
                                        memberId,
                                        'New Forum Message',
                                        `New message in ${forum.name}`,
                                        {
                                            chatId: currentForumId,
                                            type: 'forum_message'
                                        }
                                    );
                                }
                            });
                        }
                    }
                });
        }
        
        savePromise.then(() => {
            chatInput.value = '';
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('Error sending message. Please try again.');
        });
    }

    // Open chat forum
    function openChatForum(forumId, forumName) {
        currentForumId = forumId;
        currentForumName = forumName;
        chatForumTitle.textContent = forumName;
        chatModal.classList.add('active');
        chatMessages.innerHTML = '<div class="no-messages">Loading messages...</div>';

        // Load messages
        loadForumMessages(forumId);
    }

    // Load forum messages
    function loadForumMessages(forumId) {
        if (unsubscribeMessages) {
            unsubscribeMessages();
        }

        const messagesQuery = db.collection('chatForums').doc(forumId)
            .collection('messages')
            .orderBy('timestamp', 'asc')
            .limit(100);

        unsubscribeMessages = messagesQuery.onSnapshot(snapshot => {
            if (snapshot.empty) {
                chatMessages.innerHTML = '<div class="no-messages">No messages yet. Be the first to say something!</div>';
                return;
            }

            chatMessages.innerHTML = '';
            const user = auth.currentUser;
            const currentUser = user ? user.email.split('@')[0] : null;

            snapshot.forEach(doc => {
                const message = doc.data();
                const messageElement = createMessageElement(message, currentUser, doc.id);
                chatMessages.appendChild(messageElement);
            });

            // Scroll to bottom with smooth behavior
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }, error => {
            console.error('Error loading messages:', error);
            chatMessages.innerHTML = '<div class="no-messages">Error loading messages. Please try again.</div>';
        });
    }

    // Create message element
    function createMessageElement(message, currentUser, messageId) {
        const isCurrentUser = message.sender === currentUser;
        const messageClass = isCurrentUser ? 'message message-sent' : 'message message-received';
        
        const date = message.timestamp?.toDate() || new Date();
        const formattedTime = date.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });

        const messageElement = document.createElement('div');
        messageElement.className = messageClass;
        
        // Get sender's avatar
        const avatarUrl = getAvatarUrl(message.sender);
        
        let messageContent = '';
        if (message.text) {
            messageContent += `<div class="message-content">${message.text}</div>`;
        }
        
        if (message.file) {
            if (message.file.type.startsWith('image/')) {
                messageContent += `
                    <div class="file-message">
                        <i class="fas fa-image"></i> Image Attachment
                        <img src="${message.file.url}" alt="Image Attachment" class="file-preview">
                        <div class="file-actions">
                            <div class="file-action" onclick="window.open('${message.file.url}', '_blank')">
                                <i class="fas fa-download"></i> Download
                            </div>
                            ${isCurrentUser ? `
                            <div class="file-action" onclick="deleteFileAttachment('${currentForumId}', '${messageId}', '${message.file.url}', ${currentForumId.includes('_')})">
                                <i class="fas fa-trash"></i> Delete
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                messageContent += `
                    <div class="file-message">
                        <i class="fas fa-file"></i> File Attachment
                        <div class="file-actions">
                            <div class="file-action" onclick="window.open('${message.file.url}', '_blank')">
                                <i class="fas fa-download"></i> Download
                            </div>
                            ${isCurrentUser ? `
                            <div class="file-action" onclick="deleteFileAttachment('${currentForumId}', '${messageId}', '${message.file.url}', ${currentForumId.includes('_')})">
                                <i class="fas fa-trash"></i> Delete
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        }
        
        if (message.audio) {
            messageContent += `
                <div class="audio-message">
                    <i class="fas fa-microphone"></i>
                    <audio controls class="audio-player">
                        <source src="${message.audio.url}" type="audio/mp3">
                        Your browser does not support the audio element.
                    </audio>
                    ${isCurrentUser ? `
                    <div class="file-action" onclick="deleteFileAttachment('${currentForumId}', '${messageId}', '${message.audio.url}', ${currentForumId.includes('_')})">
                        <i class="fas fa-trash"></i> Delete
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        messageElement.innerHTML = `
            <div class="message-header">
                <div class="message-avatar" style="background-image: url('${avatarUrl}')"></div>
                <div class="message-info">
                    <div class="message-sender">${message.sender}</div>
                    <div class="message-time">${formattedTime}</div>
                </div>
            </div>
            ${messageContent}
            ${isCurrentUser ? `
            <div class="message-actions">
                <div class="message-action" onclick="editMessage('${currentForumId}', '${messageId}', '${message.text || ''}', ${currentForumId.includes('_')})">
                    <i class="fas fa-edit"></i>
                </div>
                <div class="message-action" onclick="deleteMessage('${currentForumId}', '${messageId}', ${currentForumId.includes('_')})">
                    <i class="fas fa-trash"></i>
                </div>
            </div>
            ` : ''}
        `;
        
        return messageElement;
    }

    // Delete message
    window.deleteMessage = async function(forumId, messageId, isPrivateChat) {
        const result = await customConfirm('Are you sure you want to delete this message?', {
            type: 'danger',
            icon: 'fa-trash',
            title: 'Delete Message',
            confirmText: 'Delete',
            danger: true
        });
        
        if (result) {
            let deletePromise;
            
            if (isPrivateChat) {
                deletePromise = db.collection('privateChats').doc(forumId).collection('messages').doc(messageId).delete();
            } else {
                deletePromise = db.collection('chatForums').doc(forumId).collection('messages').doc(messageId).delete();
            }
            
            deletePromise.then(() => {
                console.log('Message deleted successfully');
            })
            .catch(error => {
                console.error('Error deleting message:', error);
                alert('Error deleting message. Please try again.');
            });
        }
    };

    // Edit message
    window.editMessage = async function(forumId, messageId, currentText, isPrivateChat) {
        const newText = await customPrompt('Edit your message:', currentText, {
            title: 'Edit Message',
            confirmText: 'Save',
            icon: 'fa-edit'
        });
        
        if (newText !== null && newText !== currentText) {
            let updatePromise;
            
            if (isPrivateChat) {
                updatePromise = db.collection('privateChats').doc(forumId).collection('messages').doc(messageId).update({
                    text: newText,
                    edited: true
                });
            } else {
                updatePromise = db.collection('chatForums').doc(forumId).collection('messages').doc(messageId).update({
                    text: newText,
                    edited: true
                });
            }
            
            updatePromise.then(() => {
                console.log('Message updated successfully');
            })
            .catch(error => {
                console.error('Error updating message:', error);
                alert('Error updating message. Please try again.');
            });
        }
    };

    // Delete file attachment
    window.deleteFileAttachment = async function(forumId, messageId, fileUrl, isPrivateChat) {
        const result = await customConfirm('Are you sure you want to delete this attachment?', {
            type: 'danger',
            icon: 'fa-trash',
            title: 'Delete Attachment',
            confirmText: 'Delete',
            danger: true
        });
        
        if (result) {
            // Delete from storage first
            const fileRef = storage.refFromURL(fileUrl);
            
            fileRef.delete().then(() => {
                // Then delete the message or update it in Firestore
                let deletePromise;
                
                if (isPrivateChat) {
                    deletePromise = db.collection('privateChats').doc(forumId).collection('messages').doc(messageId).delete();
                } else {
                    deletePromise = db.collection('chatForums').doc(forumId).collection('messages').doc(messageId).delete();
                }
                
                return deletePromise;
            })
            .then(() => {
                console.log('File attachment deleted successfully');
            })
            .catch(error => {
                console.error('Error deleting file attachment:', error);
                alert('Error deleting file attachment. Please try again.');
            });
        }
    };

    // Get avatar URL for a user
    function getAvatarUrl(username) {
        // In a real app, you would fetch this from the user's profile in Firestore
        // For now, we'll use a placeholder or check if we have it in localStorage
        const cachedAvatar = localStorage.getItem(`avatar_${username}`);
        return cachedAvatar || 'https://via.placeholder.com/150?text=' + username.charAt(0);
    }

    // Load chat forums
    function loadChatForums() {
        const forumsBody = document.getElementById('forumsBody');
        forumsBody.innerHTML = '<div class="no-teams">Loading chat forums...</div>';
        
        const user = auth.currentUser;
        if (!user) return;
        
        const username = user.email.split('@')[0];
        
        db.collection('chatForums')
            .orderBy('createdAt', 'desc')
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    forumsBody.innerHTML = '<div class="no-teams">No chat forums available.</div>';
                    return;
                }
                
                forumsBody.innerHTML = '';
                
                snapshot.forEach((doc, index) => {
                    const forum = doc.data();
                    const forumId = doc.id;
                    const isMember = forum.members && forum.members.includes(username);
                    
                    const forumCard = document.createElement('div');
                    forumCard.className = 'forum-card';
                    forumCard.innerHTML = `
                        <div class="forum-header">
                            <div class="forum-title">${forum.name}</div>
                            <div class="forum-members">
                                <i class="fas fa-users"></i> ${forum.memberCount || 0} members
                            </div>
                        </div>
                        <div class="forum-description">${forum.description || 'Join this forum to connect with colleagues'}</div>
                        <div class="forum-footer">
                            <div class="forum-category">${forum.category || 'General'}</div>
                            ${isMember ? 
                                `<button class="forum-join-btn" data-forum-id="${forumId}" data-forum-name="${forum.name}" style="background-color: var(--success);">Open Chat</button>
                                 <button class="forum-exit-btn" data-forum-id="${forumId}">Exit Forum</button>` : 
                                `<button class="forum-join-btn" data-forum-id="${forumId}">Join Forum</button>`}
                        </div>
                    `;
                    
                    forumsBody.appendChild(forumCard);
                    
                    // Animate each card with a delay
                    setTimeout(() => {
                        forumCard.classList.add('visible');
                    }, index * 100);
                });
                
                // Add event listeners to join buttons
                document.querySelectorAll('.forum-join-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const forumId = this.getAttribute('data-forum-id');
                        const forumName = this.getAttribute('data-forum-name');
                        
                        if (this.textContent === 'Open Chat') {
                            openChatForum(forumId, forumName);
                        } else {
                            joinChatForum(forumId);
                        }
                        
                        // Micro-interaction
                        this.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.style.transform = 'scale(1)';
                        }, 200);
                    });
                });
                
                // Add event listeners to exit buttons
                document.querySelectorAll('.forum-exit-btn').forEach(button => {
                    button.addEventListener('click', async function() {
                        const forumId = this.getAttribute('data-forum-id');
                        const result = await customConfirm('Are you sure you want to exit this forum?', {
                            type: 'warning',
                            icon: 'fa-sign-out-alt',
                            title: 'Exit Forum',
                            confirmText: 'Exit'
                        });
                        
                        if (result) {
                            exitChatForum(forumId);
                        }
                        
                        // Micro-interaction
                        this.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.style.transform = 'scale(1)';
                        }, 200);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading forums:', error);
                forumsBody.innerHTML = '<div class="no-teams">Error loading chat forums. Please try again later.</div>';
            });
    }

    // Join a chat forum
    function joinChatForum(forumId) {
        const user = auth.currentUser;
        if (!user) return;
        
        const username = user.email.split('@')[0];
        
        // Add user to forum members
        db.collection('chatForums').doc(forumId).update({
            members: firebase.firestore.FieldValue.arrayUnion(username),
            memberCount: firebase.firestore.FieldValue.increment(1)
        })
        .then(() => {
            // Show success animation
            const joinBtn = document.querySelector(`.forum-join-btn[data-forum-id="${forumId}"]`);
            if (joinBtn) {
                joinBtn.innerHTML = '<i class="fas fa-check"></i> Joined';
                joinBtn.style.backgroundColor = 'var(--success)';
                
                setTimeout(() => {
                    joinBtn.innerHTML = 'Open Chat';
                    loadChatForums(); // Refresh the list
                }, 1000);
            }
        })
        .catch(error => {
            console.error('Error joining forum:', error);
            alert('Error joining forum. Please try again.');
        });
    }

    // Exit a chat forum
    function exitChatForum(forumId) {
        const user = auth.currentUser;
        if (!user) return;
        
        const username = user.email.split('@')[0];
        
        // Remove user from forum members
        db.collection('chatForums').doc(forumId).update({
            members: firebase.firestore.FieldValue.arrayRemove(username),
            memberCount: firebase.firestore.FieldValue.increment(-1)
        })
        .then(() => {
            loadChatForums(); // Refresh the list
        })
        .catch(error => {
            console.error('Error exiting forum:', error);
            alert('Error exiting forum. Please try again.');
        });
    }

    // Profile avatar upload
    const profileAvatar = document.getElementById('profileAvatar');
    const profileAvatarEdit = document.getElementById('profileAvatarEdit');
    const profileAvatarInput = document.getElementById('profileAvatarInput');
    
    profileAvatarEdit.addEventListener('click', function() {
        profileAvatarInput.click();
    });
    
    profileAvatarInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }
        
        const user = auth.currentUser;
        if (!user) return;
        
        const username = user.email.split('@')[0];
        const storageRef = storage.ref(`avatars/${username}`);
        
        // Show loading state
        const originalContent = profileAvatarEdit.innerHTML;
        profileAvatarEdit.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // Upload file
        storageRef.put(file)
            .then(snapshot => {
                return snapshot.ref.getDownloadURL();
            })
            .then(downloadURL => {
                // Update user's avatar in Firestore
                return db.collection('employees').doc(username).update({
                    avatarUrl: downloadURL
                });
            })
            .then(() => {
                // Update avatar display
                profileAvatar.style.backgroundImage = `url('${URL.createObjectURL(file)}')`;
                
                // Cache the avatar URL locally
                localStorage.setItem(`avatar_${username}`, URL.createObjectURL(file));
                
                // Update avatar in dashboard
                document.getElementById('userAvatar').style.backgroundImage = `url('${URL.createObjectURL(file)}')`;
                headerUserAvatar.style.backgroundImage = `url('${URL.createObjectURL(file)}')`;
                headerUserAvatar.textContent = '';
            })
            .catch(error => {
                console.error('Error uploading avatar:', error);
                alert('Error uploading avatar. Please try again.');
            })
            .finally(() => {
                profileAvatarEdit.innerHTML = originalContent;
            });
    });

    // Login form submission
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    const temporaryPasswordAlert = document.getElementById('temporaryPasswordAlert');
    const disabledAccountAlert = document.getElementById('disabledAccountAlert');
    const loginContainer = document.getElementById('loginContainer');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const logoutBtn = document.getElementById('logoutBtn');
    const userAvatar = document.getElementById('userAvatar');
    const teamsList = document.getElementById('teamsList');
    const announcementsBody = document.getElementById('announcementsBody');
    const dashboardIconsContainer = document.getElementById('dashboardIconsContainer');
    
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        // Show loading state
        btnText.textContent = 'Authenticating...';
        btnSpinner.style.display = 'inline-block';
        loginBtn.disabled = true;
        temporaryPasswordAlert.style.display = 'none';
        disabledAccountAlert.style.display = 'none';
        
        // Sign in with email and password
        auth.signInWithEmailAndPassword(`${username}@dnata.com`, password)
            .then((userCredential) => {
                // Check if account is disabled
                if (userCredential.user.disabled) {
                    auth.signOut();
                    disabledAccountAlert.style.display = 'flex';
                    return;
                }
                
                // Check if this is the first login (temporary password)
                return db.collection('employees').doc(username).get()
                    .then((doc) => {
                        if (doc.exists && doc.data().passwordChanged === false) {
                            // Show temporary password alert
                            temporaryPasswordAlert.style.display = 'flex';
                            
                            // Show change password modal
                            modal.classList.add('active');
                        } else {
                            // Successful login - show dashboard
                            showDashboard(userCredential.user);
                        }
                    });
            })
            .catch((error) => {
                // Handle errors
                const errorCode = error.code;
                const errorMessage = error.message;
                
                if (errorCode === 'auth/user-not-found') {
                    alert('Employee ID not found. Please check your ID and try again.');
                } else if (errorCode === 'auth/wrong-password') {
                    alert('Incorrect password. Please try again.');
                } else if (errorCode === 'auth/user-disabled') {
                    disabledAccountAlert.style.display = 'flex';
                } else {
                    alert('Login error: ' + errorMessage);
                }
            })
            .finally(() => {
                // Reset button state
                btnText.textContent = 'Sign In';
                btnSpinner.style.display = 'none';
                loginBtn.disabled = false;
            });
    });

    // Show dashboard after successful login
    function showDashboard(user) {
        // Animate login container out
        loginContainer.classList.add('hidden');
        
        // After animation completes, show dashboard
        setTimeout(() => {
            loginContainer.style.display = 'none';
            dashboardContainer.classList.add('active');
            dashboardIconsContainer.classList.remove('hidden');
            
            // Show fixed header with glass effect
            fixedHeader.classList.add('visible');
            
            // Set user avatar initials
            const email = user.email.split('@')[0];
            db.collection('employees').doc(email).get()
                .then(doc => {
                    if (doc.exists) {
                        const employee = doc.data();
                        const initials = `${employee.firstName?.charAt(0) || ''}${employee.lastName?.charAt(0) || ''}`;
                        userAvatar.textContent = initials;
                        headerUserAvatar.textContent = initials;
                        
                        // Load avatar if available
                        if (employee.avatarUrl) {
                            userAvatar.style.backgroundImage = `url('${employee.avatarUrl}')`;
                            userAvatar.textContent = '';
                            headerUserAvatar.style.backgroundImage = `url('${employee.avatarUrl}')`;
                            headerUserAvatar.textContent = '';
                            localStorage.setItem(`avatar_${email}`, employee.avatarUrl);
                        }
                        
                        // Load profile info
                        document.getElementById('profileEmployeeId').textContent = email;
                        document.getElementById('profileName').textContent = `${employee.firstName || ''} ${employee.lastName || ''}`;
                        document.getElementById('profileDepartment').textContent = employee.department || 'Not specified';
                        document.getElementById('profilePosition').textContent = employee.position || 'Not specified';
                        
                        if (employee.avatarUrl) {
                            profileAvatar.style.backgroundImage = `url('${employee.avatarUrl}')`;
                            profileAvatar.textContent = '';
                        } else {
                            profileAvatar.style.backgroundImage = '';
                            profileAvatar.textContent = initials;
                        }
                        
                        // Load employee's teams and announcements
                        loadEmployeeTeams(email);
                        loadAnnouncements();
                    }
                });
                
            // Make user avatar clickable to show profile
            userAvatar.addEventListener('click', function() {
                profileModal.classList.add('active');
            });

            // Make header avatar clickable to show profile
            headerUserAvatar.addEventListener('click', function() {
                profileModal.classList.add('active');
            });
            
            // Animate dashboard sections in
            const sections = document.querySelectorAll('.dashboard-section');
            sections.forEach((section, index) => {
                setTimeout(() => {
                    section.classList.add('visible');
                }, index * 150);
            });
        }, 400);
    }

    // Logout functionality
    function logoutUser() {
        // Clear break check interval
        if (breakCheckInterval) {
            clearInterval(breakCheckInterval);
            breakCheckInterval = null;
        }
        
        // Clear alerted breaks
        alertedBreaks = new Set();
        
        // Close any active break alerts
        activeBreakAlerts.forEach(alert => {
            clearTimeout(alert.dataset.dismissTimer);
            alert.remove();
        });
        activeBreakAlerts = [];
        
        // Animate dashboard out
        dashboardContainer.classList.remove('active');
        dashboardIconsContainer.classList.add('hidden');
        
        // Hide fixed header
        fixedHeader.classList.remove('visible');
        
        // After animation completes, show login
        setTimeout(() => {
            auth.signOut().then(() => {
                dashboardContainer.style.display = 'none';
                loginContainer.style.display = 'block';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                // Hide any open fullscreen content
                hideFullscreenContent();
                
                // Hide chat modal if open
                chatModal.classList.remove('active');
                if (unsubscribeMessages) {
                    unsubscribeMessages();
                    unsubscribeMessages = null;
                }
                
                // Animate login container back in
                setTimeout(() => {
                    loginContainer.classList.remove('hidden');
                }, 50);
            }).catch(error => {
                console.error('Error signing out:', error);
                alert('Error signing out. Please try again.');
            });
        }, 400);
    }

    // Logout button click handlers
    logoutBtn.addEventListener('click', logoutUser);
    headerLogoutBtn.addEventListener('click', logoutUser);

    // Change password form submission
    const changePasswordForm = document.getElementById('changePasswordForm');
    const submitNewPassword = document.getElementById('submitNewPassword');
    
    submitNewPassword.addEventListener('click', function() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const username = document.getElementById('username').value;
        
        // Validate inputs
        if (newPassword !== confirmPassword) {
            alert('New passwords do not match');
            return;
        }
        
        if (newPassword.length < 8) {
            alert('Password must be at least 8 characters long');
            return;
        }
        
        // Get current user
        const user = auth.currentUser;
        
        if (user) {
            // Reauthenticate with current password
            const credential = firebase.auth.EmailAuthProvider.credential(
                `${username}@dnata.com`,
                currentPassword
            );
            
            user.reauthenticateWithCredential(credential)
                .then(() => {
                    // Update password
                    return user.updatePassword(newPassword);
                })
                .then(() => {
                    // Password updated successfully
                    alert('Password changed successfully!');
                    modal.classList.remove('active');
                    temporaryPasswordAlert.style.display = 'none';
                    
                    // Update user in Firestore
                    return db.collection('employees').doc(username).update({
                        passwordChanged: true,
                        lastPasswordChange: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    // Show dashboard after password change
                    showDashboard(user);
                })
                .catch((error) => {
                    console.error('Error changing password:', error);
                    alert('Error changing password. Please try again.');
                });
        } else {
            alert('No user is currently signed in');
        }
    });

    // Forgot password link
    document.getElementById('forgotPassword').addEventListener('click', function(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        
        if (!username) {
            alert('Please enter your Employee ID first');
            return;
        }
        
        const email = `${username}@dnata.com`;
        
        auth.sendPasswordResetEmail(email)
            .then(() => {
                alert('Password reset email sent. Please check your inbox.');
            })
            .catch((error) => {
                console.error('Error sending password reset email:', error);
                if (error.code === 'auth/user-not-found') {
                    alert('Employee ID not found. Please check your ID and try again.');
                } else if (error.code === 'auth/user-disabled') {
                    alert('Your account has been disabled. Please contact HR.');
                } else {
                    alert('Error sending password reset email. Please try again.');
                }
            });
    });

    // Tooltip functionality for floating icons
    const floatingIcons = document.querySelectorAll('.floating-icon');
    floatingIcons.forEach(icon => {
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.textContent = icon.getAttribute('data-tooltip');
        icon.appendChild(tooltip);
        
        icon.addEventListener('mouseenter', function() {
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
        });
        
        icon.addEventListener('mouseleave', function() {
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';
        });
    });

    // Tooltip functionality for dashboard icons
    const dashboardIcons = document.querySelectorAll('.dashboard-icon');
    dashboardIcons.forEach(icon => {
        const tooltip = icon.querySelector('.dashboard-icon-tooltip');
        
        icon.addEventListener('mouseenter', function() {
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
        });
        
        icon.addEventListener('mouseleave', function() {
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';
        });
    });

    // Check if user is already logged in
    auth.onAuthStateChanged((user) => {
        if (user) {
            // Check if account is disabled
            if (user.disabled) {
                disabledAccountAlert.style.display = 'flex';
                auth.signOut();
                return;
            }
            
            // User is signed in, check if password needs to be changed
            const username = user.email.split('@')[0];
            db.collection('employees').doc(username).get()
                .then((doc) => {
                    if (doc.exists) {
                        const employeeData = doc.data();
                        if (employeeData.passwordChanged === false) {
                            // Show password change modal
                            document.getElementById('username').value = username;
                            temporaryPasswordAlert.style.display = 'flex';
                            modal.classList.add('active');
                        } else {
                            // Show dashboard
                            showDashboard(user);
                        }
                    }
                });
        } else {
            // Hide dashboard floating icons when logged out
            hideFullscreenContent();
        }
    });

    // Initially hide the fixed header
    fixedHeader.style.display = 'none';
    globalBackButton.style.display = 'none';
});
</script>
</body>
</html>
