<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShiftMaster Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add this in the head section -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        #animated-logo {
  /* Basic styling (adjust as needed) */
  width: 150px;
  height: 80px;
  border: 2px solid #333;
  border-radius: 8px;
  
  /* Bouncing animation */
  animation: 
    bounce 70.0s infinite alternate,
    shake 120.3s infinite alternate;
}

/* Bounce effect */
@keyframes bounce {
  from {
    transform: translateY(0);
  }
  to {
    transform: translateY(-20px);
  }
}

        /* Floating Report Button */
.fab-report {
    position: fixed;
    bottom: 110px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #4bc0c0; /* Teal color */
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    transition: all 0.3s ease;
}

.fab-report:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
    background: #3aa8a8;
}

.fab-report:active {
    transform: translateY(0) scale(0.98);
}

/* Floating Chat Button */
.fab-chat {
    position: fixed;
    bottom: 180px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #e91e63; /* Pink color */
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    transition: all 0.3s ease;
}

.fab-chat:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
    background: #d81b60;
}

.fab-chat:active {
    transform: translateY(0) scale(0.98);
}

/* Adjust announcement button position */
.fab-announcement {
    bottom: 40px; /* Changed from 30px to 40px to make space for the new buttons */
}
        /* Add this to your existing CSS */
#download-assignments-btn {
    background-color: var(--success-color);
}

#download-assignments-btn:hover {
    background-color: #7ab436;
}
    .ripple-effect {
        position: absolute;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.4);
        transform: scale(0);
        animation: ripple 0.6s linear;
        pointer-events: none;
        width: 20px;
        height: 20px;
        margin-top: -10px;
        margin-left: -10px;
    }

    @keyframes ripple {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }
          /* Enhanced Close Button Styles */
    .modal-close {
        background: none;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        color: #888;
        font-size: 20px;
    }

    .modal-close:hover {
        background-color: rgba(0, 0, 0, 0.05);
        color: #555;
        transform: rotate(90deg);
    }

    .modal-close:active {
        transform: rotate(90deg) scale(0.95);
    }

    .modal-close::before, 
    .modal-close::after {
        content: '';
        position: absolute;
        width: 18px;
        height: 2px;
        background-color: currentColor;
        border-radius: 1px;
        transition: all 0.3s ease;
    }

    .modal-close::before {
        transform: rotate(45deg);
    }

    .modal-close::after {
        transform: rotate(-45deg);
    }

    .modal-close:hover::before,
    .modal-close:hover::after {
        background-color: var(--danger-color);
    }

    /* Advanced Action Buttons */
    .action-btn {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .action-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
    }

    .action-btn i {
        font-size: 14px;
    }

    /* Enhanced Cancel Buttons */
    .btn-outline {
        background: transparent;
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .btn-outline:hover {
        background: rgba(74, 137, 220, 0.1);
        box-shadow: 0 4px 12px rgba(74, 137, 220, 0.2);
    }

    .btn-outline::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(74, 137, 220, 0.2);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%, -50%);
        transform-origin: 50% 50%;
    }

    .btn-outline:focus:not(:active)::after {
        animation: ripple 0.6s ease-out;
    }

    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 0.5;
        }
        100% {
            transform: scale(20, 20);
            opacity: 0;
        }
    }

    /* Delete Button Enhancements */
    .delete-btn {
        background: rgba(233, 87, 63, 0.1);
        color: var(--danger-color);
        border: 1px solid rgba(233, 87, 63, 0.2);
    }

    .delete-btn:hover {
        background: rgba(233, 87, 63, 0.2);
        color: #d62c1a;
    }

    /* Edit Button Enhancements */
    .edit-btn {
        background: rgba(75, 192, 192, 0.1);
        color: #4bc0c0;
        border: 1px solid rgba(75, 192, 192, 0.2);
    }

    .edit-btn:hover {
        background: rgba(75, 192, 192, 0.2);
        color: #3aa8a8;
    }

    /* Floating Action Button for Mobile */
    @media (max-width: 768px) {
        .fab-close {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fab-close:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        .fab-close:active {
            transform: translateY(0) scale(0.98);
        }

        .fab-close i {
            font-size: 24px;
        }
    }
        /* Add these styles to your existing CSS */

/* Search bar styles */
.search-container {
    position: relative;
    margin-bottom: 20px;
    width: 300px;
}

.search-input {
    width: 100%;
    padding: 10px 15px 10px 40px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.2s ease;
}

.search-input:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(74, 137, 220, 0.2);
}

.search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #888;
}

/* Bulk assign modal scrollable area */
.bulk-assign-modal .modal-body {
    max-height: 60vh;
    overflow-y: auto;
    padding-bottom: 80px; /* Space for fixed buttons */
}

.bulk-assign-modal .modal-footer {
    position: sticky;
    bottom: 0;
    background: white;
    z-index: 10;
    border-top: 1px solid #eee;
}
        :root {
            --primary-color: #4a89dc;
            --secondary-color: #5d9cec;
            --accent-color: #3bafda;
            --light-color: #f5f7fa;
            --dark-color: #434a54;
            --success-color: #8cc152;
            --warning-color: #f6bb42;
            --danger-color: #e9573f;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --sidebar-width: 80px;
            --sidebar-expanded-width: 250px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #f5f7fa 100%);
            color: var(--dark-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            transition: all 0.3s ease;
            box-shadow: 5px 0 15px var(--shadow-color);
            overflow: hidden;
            border-radius: 0 20px 20px 0;
        }

        .sidebar:hover {
            width: var(--sidebar-expanded-width);
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .logo {
            width: 80px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .logo-text {
            margin-left: 15px;
            font-weight: 600;
            color: var(--dark-color);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar:hover .logo-text {
            opacity: 1;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .menu-item:hover {
            background: rgba(74, 137, 220, 0.1);
        }

        .menu-item.active {
            background: rgba(74, 137, 220, 0.2);
            border-left: 3px solid var(--primary-color);
        }

        .menu-icon {
            font-size: 20px;
            color: var(--dark-color);
            min-width: 40px;
            display: flex;
            justify-content: center;
        }

        .menu-text {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar:hover .menu-text {
            opacity: 1;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease;
            padding: 20px;
        }

        .sidebar:hover ~ .main-content {
            margin-left: var(--sidebar-expanded-width);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 20px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .card-icon.blue {
            background: var(--primary-color);
        }

        .card-icon.green {
            background: var(--success-color);
        }

        .card-icon.orange {
            background: var(--warning-color);
        }

        .card-icon.red {
            background: var(--danger-color);
        }

        .card-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .card-description {
            font-size: 14px;
            color: #777;
        }

        /* Shift Management Section */
        .shift-section {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px var(--shadow-color);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #3a6fc8;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background: rgba(74, 137, 220, 0.1);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            position: relative;
        }

        .tab.active {
            color: var(--primary-color);
            font-weight: 500;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary-color);
        }

        .shift-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .shift-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .shift-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .shift-title {
            font-weight: 600;
            font-size: 18px;
        }

        .shift-time {
            background: rgba(74, 137, 220, 0.1);
            color: var(--primary-color);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .team-list {
            margin-top: 15px;
        }

        .team-item {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .team-name {
            font-weight: 600;
            color: var(--primary-color);
        }

        .team-members {
            font-size: 14px;
            color: #666;
        }

        .member-list {
            margin-top: 10px;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }

        .member-role {
            width: 100px;
            font-size: 13px;
            color: #888;
        }

        .member-name {
            flex: 1;
            font-weight: 500;
        }

        .member-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background: rgba(75, 192, 192, 0.1);
            color: #4bc0c0;
        }

        .edit-btn:hover {
            background: rgba(75, 192, 192, 0.2);
        }

        .delete-btn {
            background: rgba(255, 99, 132, 0.1);
            color: #ff6384;
        }

        .delete-btn:hover {
            background: rgba(255, 99, 132, 0.2);
        }

        /* Employee Management Styles */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .employee-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .employee-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .employee-info {
            flex: 1;
        }

        .employee-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .employee-role {
            font-size: 14px;
            color: #666;
            padding: 3px 8px;
            background: #f0f0f0;
            border-radius: 4px;
            display: inline-block;
            margin-right: 5px;
        }

        .employee-employer {
            font-size: 12px;
            color: #888;
            padding: 3px 8px;
            background: #f0f0f0;
            border-radius: 4px;
            display: inline-block;
        }

        .employee-actions {
            display: flex;
            gap: 10px;
        }

        /* Date Picker Styles */
        .date-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #888;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 137, 220, 0.2);
        }

        .select-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 15px;
        }

        .select-multiple {
            height: auto;
            min-height: 100px;
            padding: 8px;
        }

        .select-multiple option {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Section Content Styles */
        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
        }

        /* Assign section styles */
        .assign-section {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px var(--shadow-color);
            margin-bottom: 30px;
        }

        .assign-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .assign-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .assign-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .assign-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .assign-title {
            font-weight: 600;
            font-size: 18px;
        }

        .assign-details {
            margin-top: 15px;
        }

        .assign-detail {
            display: flex;
            margin-bottom: 10px;
        }

        .assign-label {
            font-weight: 500;
            width: 100px;
            color: #666;
        }

        .assign-value {
            flex: 1;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-primary {
            background: rgba(74, 137, 220, 0.1);
            color: var(--primary-color);
        }

        .badge-success {
            background: rgba(140, 193, 82, 0.1);
            color: var(--success-color);
        }

        .badge-warning {
            background: rgba(246, 187, 66, 0.1);
            color: var(--warning-color);
        }

        .badge-danger {
            background: rgba(233, 87, 63, 0.1);
            color: var(--danger-color);
        }

        /* Multi-select styles */
        .multi-select-container {
            width: 100%;
        }

        .multi-select-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .multi-select-options {
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .multi-select-option {
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .multi-select-option:hover {
            background-color: #f5f5f5;
        }

        .multi-select-option.selected {
            background-color: rgba(74, 137, 220, 0.1);
        }

        .multi-select-option input {
            margin-right: 10px;
        }

        /* Bulk assignment styles */
        .bulk-assign-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .selected-employees {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .selected-employee {
            background: rgba(74, 137, 220, 0.1);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .remove-employee {
            cursor: pointer;
            color: var(--danger-color);
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                width: 0;
            }
            
            .sidebar:hover {
                width: var(--sidebar-expanded-width);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar:hover ~ .main-content {
                margin-left: 0;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .shift-grid, .employee-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }

        /* Auto-generate modal styles */
        .auto-generate-modal {
            max-width: 600px;
        }

        .generate-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .generate-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .incomplete-members {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .incomplete-list {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }

        .incomplete-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .incomplete-item:last-child {
            border-bottom: none;
        }

        /* Outsources section styles */
        .outsources-section {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px var(--shadow-color);
            margin-bottom: 30px;
            height: calc(100vh - 800px);
        }

        .outsources-iframe {
            width: 100%;
            height: 800px;
            border: none;
            border-radius: 10px;
        }

        /* Employers section styles */
        .employers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .employer-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .employer-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .employer-info {
            flex: 1;
        }

        .employer-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .employer-employees {
            font-size: 14px;
            color: #666;
        }

        .employer-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background-color: var(--success-color);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(200%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        .notification.warning {
            background-color: var(--warning-color);
        }

        /* Team rules styles */
        .team-rules-container {
            margin-top: 20px;
        }

        .team-rules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .team-rules-list {
            border: 1px solid #eee;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .team-rule-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-rule-item:last-child {
            border-bottom: none;
        }

        .team-rule-details {
            flex: 1;
        }

        .team-rule-date {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .team-rule-location {
            font-size: 14px;
            color: #666;
        }

        .team-rule-requirements {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .team-rule-requirement {
            font-size: 12px;
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .team-rule-actions {
            display: flex;
            gap: 5px;
        }

        /* Add rule modal styles */
        .add-rule-modal {
            max-width: 600px;
        }

        .rule-requirements {
            margin-top: 15px;
        }

        .rule-requirement {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .rule-requirement-label {
            width: 120px;
        }

        .rule-requirement-input {
            flex: 1;
        }

        /* Supervisor badge */
        .supervisor-badge {
            background: rgba(233, 30, 99, 0.1);
            color: #e91e63;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        /* Floating Announcement Button */
.fab-announcement {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    transition: all 0.3s ease;
}

.fab-announcement:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
}

.fab-announcement:active {
    transform: translateY(0) scale(0.98);
}

/* Editor Styles */
.editor-toolbar {
    display: flex;
    gap: 5px;
    padding: 8px;
    background: #f5f5f5;
    border-radius: 8px 8px 0 0;
    border: 1px solid #ddd;
    border-bottom: none;
    flex-wrap: wrap;
}

.editor-btn {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    background: white;
    border: 1px solid #ddd;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.editor-btn:hover {
    background: #f0f0f0;
}

.editor-content {
    min-height: 200px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 0 0 8px 8px;
    outline: none;
    background: white;
}

.editor-content:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(74, 137, 220, 0.2);
}

/* Filter Options */
.filter-options {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.filter-options label {
    font-size: 14px;
    color: #666;
}
/* Scrollable Modal */
.modal {
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}

.modal-body {
    overflow-y: auto;
    flex: 1;
}

/* Select All Checkbox */
.select-all-container {
    display: flex;
    align-items: center;
    padding: 5px;
    background: #f5f5f5;
    border-radius: 4px;
    margin-bottom: 5px;
}

.select-all-container input {
    margin-right: 5px;
}

/* Scrollable Recipients List */
.multi-select-container {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
}

.multi-select-options {
    padding: 5px;
}
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo"> <img 
  id="animated-logo" 
  src="logo.jpg" 
  alt="A beautiful landscape"
></div>
                <div class="logo-text">ShiftMaster</div>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" data-section="dashboard">
                    <div class="menu-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="menu-text">Shift Schedule</div>
                </div>
                <div class="menu-item" data-section="assign">
                    <div class="menu-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="menu-text">Assign</div>
                </div>
                <div class="menu-item" data-section="employees">
                    <div class="menu-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="menu-text">Employees</div>
                </div>
                <!--<div class="menu-item" data-section="employers">
                    <div class="menu-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="menu-text">Employers</div>
                </div>-->
               <!-- <div class="menu-item" data-section="teams">
                    <div class="menu-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="menu-text">Teams</div>
                </div>-->
                 <div class="menu-item" data-section="analysis">
        <div class="menu-icon">
            <i class="fas fa-layer-group"></i>
        </div>
        <div class="menu-text">Teams</div>
    </div>
       <div class="menu-item" data-section="supply">
        <div class="menu-icon">
            <i class="fas fa-truck"></i>
        </div>
        <div class="menu-text">Outsources</div>
    </div>        
               
    <div class="menu-item" data-section="automation">
        <div class="menu-icon">
            <i class="fas fa-robot"></i>
        </div>
        <div class="menu-text">Automation</div>
    </div>
    <div class="menu-item" data-section="feed">
    <div class="menu-icon">
        <i class="fas fa-rss"></i>  <!-- RSS feed icon -->
    </div>
    <div class="menu-text">Feed</div>
</div>
                <div class="menu-item" data-section="settings">
                    <div class="menu-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="menu-text">Settings</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div class="dashboard-section section-content active">
                <div class="header">
                    <h1 class="page-title">Shift Management Dashboard</h1>
                    <div class="user-profile">
                        <div class="user-avatar">
                          <div class="user-avatar">AD</div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Cards -->
                <div class="dashboard-cards">
                    <div class="card fade-in" style="animation-delay: 0.1s;">
                        <div class="card-header">
                            <div class="card-title">Total Employees</div>
                            <div class="card-icon blue">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-value" id="total-employees">0</div>
                        <div class="card-description">Active employees in system</div>
                    </div>
                    <div class="card fade-in" style="animation-delay: 0.2s;">
                        <div class="card-header">
                            <div class="card-title">Teams Today</div>
                            <div class="card-icon green">
                                <i class="fas fa-layer-group"></i>
                            </div>
                        </div>
                        <div class="card-value" id="total-teams">0</div>
                        <div class="card-description">Teams scheduled today</div>
                    </div>
                    <div class="card fade-in" style="animation-delay: 0.3s;">
                        <div class="card-header">
                            <div class="card-title">Morning Shift</div>
                            <div class="card-icon orange">
                                <i class="fas fa-sun"></i>
                            </div>
                        </div>
                        <div class="card-value" id="morning-count">0</div>
                        <div class="card-description">6:00 AM - 6:00 PM</div>
                    </div>
                    <div class="card fade-in" style="animation-delay: 0.4s;">
                        <div class="card-header">
                            <div class="card-title">Night Shift</div>
                            <div class="card-icon red">
                                <i class="fas fa-moon"></i>
                            </div>
                        </div>
                        <div class="card-value" id="night-count">0</div>
                        <div class="card-description">6:00 PM - 6:00 AM</div>
                    </div>
                </div>

                <!-- Shift Management Section -->
                <div class="shift-section fade-in" style="animation-delay: 0.5s;">
                    <div class="section-header">
                        <h2 class="section-title">Shifts</h2>
                        <div>
                            <div class="date-picker">
                                <input type="date" id="shift-date" class="date-input">
                                <button class="btn btn-primary" id="add-team-btn">
                                    <i class="fas fa-plus"></i> Add Team
                                </button>
                                <button class="btn btn-outline" id="auto-generate-btn">
                                    <i class="fas fa-random"></i> Auto Generate
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-shift="all">All Shifts</div>
                        <div class="tab" data-shift="morning">Morning (6AM-6PM)</div>
                        <div class="tab" data-shift="night">Night (6PM-6AM)</div>
                    </div>
                    
                    <div class="shift-grid" id="shifts-container">
                        <!-- Shifts will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Assign Section -->
            <div class="assign-section section-content">
                <div class="header">
                    <h1 class="page-title">Employee Assignment</h1>
                    <div class="user-profile">
                        <button class="btn btn-primary" id="add-assignment-btn">
                            <i class="fas fa-plus"></i> Add Assignment
                        </button>
                        <button class="btn btn-primary" id="bulk-assign-btn">
                            <i class="fas fa-users"></i> Bulk Assign
                        </button>
                        <button class="btn btn-primary" id="download-assignments-btn">
                <i class="fas fa-download"></i> Download PDF
            </button>
                        <div class="user-avatar">AD</div>
                    </div>
                </div>

                <div class="assign-filters">
                    <input type="date" id="assign-date" class="date-input">
                    <select id="assign-location" class="select-control">
                        <option value="">All Locations</option>
                        <option value="FG5">FG5</option>
                        <option value="FG4">FG4</option>
                        <option value="FG">FG</option>
                        <option value="FG2">FG2</option>
                    </select>
                    <select id="assign-area" class="select-control">
                        <option value="">All Areas</option>
                        <option value="Breakdown">Breakdown</option>
                        <option value="Delivery">Delivery</option>
                        <option value="Acceptance">Acceptance</option>
                        <option value="Buildup">Buildup</option>
                    </select>
                    <select id="assign-shift" class="select-control">
                        <option value="">All Shifts</option>
                        <option value="morning">Morning</option>
                        <option value="night">Night</option>
                    </select>
                    <button class="btn btn-primary" id="apply-filters-btn">
                        <i class="fas fa-filter"></i> Apply
                    </button>
                </div>

                <div class="assign-grid" id="assign-container">
                    <!-- Assignments will be loaded here -->
                </div>
            </div>
<!-- Find the employees-section div and update the section-header to include search -->
<div class="employees-section section-content">
    <div class="header">
        <h1 class="page-title">Employee Management</h1>
        <div class="user-profile">
            <button class="btn btn-primary" id="add-employee-btn">
                <i class="fas fa-plus"></i> Add Employee
            </button>
            <div class="user-avatar">AD</div>
        </div>
    </div>

    <div class="shift-section fade-in">
        <div class="section-header">
            <h2 class="section-title">All Employees</h2>
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="employee-search" placeholder="Search employees...">
            </div>
            <div class="tabs">
                <div class="tab active" data-role="all">All</div>
                <div class="tab" data-role="staff">Staff</div>
                <div class="tab" data-role="porter">Porters</div>
                <div class="tab" data-role="forklift">Forklift</div>
            </div>
        </div>
        
        <div class="employee-grid" id="employees-container">
            <!-- Employees will be loaded here -->
        </div>
    </div>
</div>
            <!-- Employers Section -->
            <div class="employers-section section-content">
                <div class="header">
                    <h1 class="page-title">Employer Management</h1>
                    <div class="user-profile">
                        <button class="btn btn-primary" id="add-employer-btn">
                            <i class="fas fa-plus"></i> Add Employer
                        </button>
                        <div class="user-avatar">AD</div>
                    </div>
                </div>

                <div class="shift-section fade-in">
                    <div class="section-header">
                        <h2 class="section-title">All Employers</h2>
                    </div>
                    
                    <div class="employers-grid" id="employers-container">
                        <!-- Employers will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Teams Section -->
            <!-- Find the teams-section div and update the section-header -->
<div class="teams-section section-content">
    <div class="header">
        <h1 class="page-title">Team Management</h1>
        <div class="user-profile">
            <div class="user-avatar">AD</div>
        </div>
    </div>

    <div class="shift-section fade-in">
        <div class="section-header">
            <h2 class="section-title">All Teams</h2>
            <div class="date-picker">
                <input type="date" id="teams-date" class="date-input">
                <select id="teams-location" class="select-control">
                    <option value="">All Locations</option>
                    <option value="FG5">FG5</option>
                    <option value="FG4">FG4</option>
                    <option value="FG">FG</option>
                    <option value="FG2">FG2</option>
                </select>
                <select id="teams-area" class="select-control">
                    <option value="">All Areas</option>
                    <option value="Breakdown">Breakdown</option>
                    <option value="Delivery">Delivery</option>
                    <option value="Acceptance">Acceptance</option>
                    <option value="Buildup">Buildup</option>
                </select>
                <select id="teams-shift" class="select-control">
                    <option value="">All Shifts</option>
                    <option value="morning">Morning</option>
                    <option value="night">Night</option>
                </select>
                <button class="btn btn-primary" id="apply-teams-filters-btn">
                    <i class="fas fa-filter"></i> Apply
                </button>
            </div>
        </div>
        
        <div class="shift-grid" id="teams-container">
            <!-- Teams will be loaded here -->
        </div>
    </div>
</div>

            <!-- Outsources Section -->
             <div class="feed-section section-content">
    <iframe src="feedfix.html" class="outsources-iframe" id="feed-iframe"></iframe>
</div>
            <div class="supply-section section-content">
    <iframe src="outsource.html" class="outsources-iframe" id="supply-iframe"></iframe>
</div>
<div class="analysis-section section-content">
    <iframe src="break.html" class="outsources-iframe" id="analysis-iframe"></iframe>
</div>
 <div class="automation-section section-content">
    <iframe src="automation.html" class="outsources-iframe" id="automation-iframe"></iframe>
</div>         
<!-- Settings Section -->
            <div class="settings-section section-content">
                <div class="header">
                    <h1 class="page-title">Settings</h1>
                    <div class="user-profile">
                        <div class="user-avatar">AD</div>
                    </div>
                </div>

            

                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <div class="card-title">Team Creation Rules</div>
                            <button class="btn btn-primary" id="add-rule-btn">
                                <i class="fas fa-plus"></i> Add Rule
                            </button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="team-rules-container">
                                <div class="team-rules-list" id="team-rules-list">
                                    <!-- Team rules will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-message">Operation completed successfully</span>
    </div>

    <!-- Add Team Modal -->
    <div class="modal-overlay" id="team-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Team</h3>
                <button class="modal-close" id="close-team-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Shift Date</label>
                    <input type="date" class="form-control" id="team-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Shift</label>
                    <select class="select-control" id="team-shift">
                        <option value="morning">Morning (6:00 AM - 6:00 PM)</option>
                        <option value="night">Night (6:00 PM - 6:00 AM)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <select class="select-control" id="team-location">
                        <option value="FG5">FG5</option>
                        <option value="FG4">FG4</option>
                        <option value="FG">FG</option>
                        <option value="FG2">FG2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Area</label>
                    <select class="select-control" id="team-area">
                        <option value="Breakdown">Breakdown</option>
                        <option value="Delivery">Delivery</option>
                        <option value="Acceptance">Acceptance</option>
                        <option value="Buildup">Buildup</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Supervisor (Optional)</label>
                    <select class="select-control" id="team-supervisor">
                        <option value="">No Supervisor</option>
                        <!-- Supervisors will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Staff Member</label>
                    <select class="select-control" id="staff-member">
                        <!-- Staff members will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Porters (Select 2)</label>
                    <select class="select-control" id="porters" multiple>
                        <!-- Porters will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Forklift Operator</label>
                    <select class="select-control" id="forklift-operator">
                        <!-- Forklift operators will be loaded here -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-team-modal">Cancel</button>
                <button class="btn btn-primary" id="save-team">Save Team</button>
            </div>
        </div>
    </div>

    <!-- Auto Generate Teams Modal -->
    <div class="modal-overlay" id="auto-generate-modal">
        <div class="modal auto-generate-modal">
            <div class="modal-header">
                <h3 class="modal-title">Auto Generate Teams</h3>
                <button class="modal-close" id="close-auto-generate-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Shift Date</label>
                    <input type="date" class="form-control" id="auto-generate-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Shift Type</label>
                    <select class="select-control" id="auto-generate-shift">
                        <option value="morning">Morning (6:00 AM - 6:00 PM)</option>
                        <option value="night">Night (6:00 PM - 6:00 AM)</option>
                    </select>
                </div>
                <div class="generate-options">
                    <div class="generate-option">
                        <input type="checkbox" id="generate-location" checked>
                        <label for="generate-location">Group by Location</label>
                    </div>
                    <div class="generate-option">
                        <input type="checkbox" id="generate-area" checked>
                        <label for="generate-area">Group by Area</label>
                    </div>
                </div>
                <div class="incomplete-members">
                    <h4>Incomplete Team Members</h4>
                    <div class="incomplete-list" id="incomplete-members-list">
                        <!-- Incomplete members will be shown here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-auto-generate-modal">Cancel</button>
                <button class="btn btn-primary" id="confirm-auto-generate">Generate Teams</button>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal-overlay" id="employee-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Employee</h3>
                <button class="modal-close" id="close-employee-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-control" id="employee-first-name" placeholder="Enter first name">
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-control" id="employee-last-name" placeholder="Enter last name">
                </div>
                <div class="form-group">
                    <label class="form-label">Employee ID</label>
                    <input type="text" class="form-control" id="employee-id" placeholder="Enter employee ID">
                </div>
                <div class="form-group">
                    <label class="form-label">Employer</label>
                    <select class="select-control" id="employee-employer">
                        <!-- Employers will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="select-control" id="employee-role">
                        <option value="staff">Staff Member</option>
                        <option value="porter">Porter</option>
                        <option value="forklift">Forklift Operator</option>
                        <option value="supervisor">Supervisor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="employee-email" placeholder="Enter email address">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-employee-modal">Cancel</button>
                <button class="btn btn-primary" id="save-employee">Save Employee</button>
            </div>
        </div>
    </div>

    <!-- Add Employer Modal -->
    <div class="modal-overlay" id="employer-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Employer</h3>
                <button class="modal-close" id="close-employer-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Employer Name</label>
                    <input type="text" class="form-control" id="employer-name" placeholder="Enter employer name">
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Email</label>
                    <input type="email" class="form-control" id="employer-email" placeholder="Enter contact email">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-employer-modal">Cancel</button>
                <button class="btn btn-primary" id="save-employer">Save Employer</button>
            </div>
        </div>
    </div>

    <!-- Assign Employee Modal -->
    <div class="modal-overlay" id="assign-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Assign Employee to Shift</h3>
                <button class="modal-close" id="close-assign-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control" id="assign-employee-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Shift</label>
                    <select class="select-control" id="assign-employee-shift">
                        <option value="morning">Morning (6:00 AM - 6:00 PM)</option>
                        <option value="night">Night (6:00 PM - 6:00 AM)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <select class="select-control" id="assign-employee-location">
                        <option value="FG5">FG5</option>
                        <option value="FG4">FG4</option>
                        <option value="FG">FG</option>
                        <option value="FG2">FG2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Area</label>
                    <select class="select-control" id="assign-employee-area">
                        <option value="Breakdown">Breakdown</option>
                        <option value="Delivery">Delivery</option>
                        <option value="Acceptance">Acceptance</option>
                        <option value="Buildup">Buildup</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Employee</label>
                    <select class="select-control" id="assign-employee">
                        <!-- Employees will be loaded here -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-assign-modal">Cancel</button>
                <button class="btn btn-primary" id="save-assignment">Save Assignment</button>
            </div>
        </div>
    </div>

    <!-- Bulk Assign Modal -->
    <div class="modal-overlay" id="bulk-assign-modal">
        <div class="modal bulk-assign-modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Bulk Assign Employees</h3>
                <button class="modal-close" id="close-bulk-assign-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control" id="bulk-assign-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Shift</label>
                    <select class="select-control" id="bulk-assign-shift">
                        <option value="morning">Morning (6:00 AM - 6:00 PM)</option>
                        <option value="night">Night (6:00 PM - 6:00 AM)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <select class="select-control" id="bulk-assign-location">
                        <option value="FG5">FG5</option>
                        <option value="FG4">FG4</option>
                        <option value="FG">FG</option>
                        <option value="FG2">FG2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Area</label>
                    <select class="select-control" id="bulk-assign-area">
                        <option value="Breakdown">Breakdown</option>
                        <option value="Delivery">Delivery</option>
                        <option value="Acceptance">Acceptance</option>
                        <option value="Buildup">Buildup</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Employees</label>
                    <div class="multi-select-container">
                        <div class="multi-select-options" id="bulk-employees-list">
                            <!-- Employees will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="bulk-assign-section">
                    <label class="form-label">Selected Employees</label>
                    <div class="selected-employees" id="selected-employees-list">
                        <!-- Selected employees will appear here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-bulk-assign-modal">Cancel</button>
                <button class="btn btn-primary" id="save-bulk-assignment">Save Assignments</button>
            </div>
        </div>
    </div>

    <!-- Add Team Rule Modal -->
    <div class="modal-overlay" id="add-rule-modal">
        <div class="modal add-rule-modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Team Creation Rule</h3>
                <button class="modal-close" id="close-add-rule-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control" id="rule-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <select class="select-control" id="rule-location">
                        <option value="FG5">FG5</option>
                        <option value="FG4">FG4</option>
                        <option value="FG">FG</option>
                        <option value="FG2">FG2</option>
                        <option value="all">All Locations</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Area</label>
                    <select class="select-control" id="rule-area">
                        <option value="Breakdown">Breakdown</option>
                        <option value="Delivery">Delivery</option>
                        <option value="Acceptance">Acceptance</option>
                        <option value="Buildup">Buildup</option>
                        <option value="all">All Areas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Shift</label>
                    <select class="select-control" id="rule-shift">
                        <option value="morning">Morning (6:00 AM - 6:00 PM)</option>
                        <option value="night">Night (6:00 PM - 6:00 AM)</option>
                        <option value="all">All Shifts</option>
                    </select>
                </div>
                
                <div class="rule-requirements">
                    <h4>Team Requirements</h4>
                    <div class="rule-requirement">
                        <div class="rule-requirement-label">Staff Members:</div>
                        <div class="rule-requirement-input">
                            <input type="number" class="form-control" id="rule-staff" min="0" value="1">
                        </div>
                    </div>
                    <div class="rule-requirement">
                        <div class="rule-requirement-label">Porters:</div>
                        <div class="rule-requirement-input">
                            <input type="number" class="form-control" id="rule-porters" min="0" value="2">
                        </div>
                    </div>
                    <div class="rule-requirement">
                        <div class="rule-requirement-label">Forklift Operators:</div>
                        <div class="rule-requirement-input">
                            <input type="number" class="form-control" id="rule-forklifts" min="0" value="1">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-add-rule-modal">Cancel</button>
                <button class="btn btn-primary" id="save-rule">Save Rule</button>
            </div>
        </div>
    </div>
    <!-- Floating Announcement Button -->
     <!-- Floating Report Button -->
<div class="fab-report" id="report-fab">
    <i class="fas fa-chart-line"></i>
</div>

<!-- Floating Chat Button -->
<div class="fab-chat" id="chat-fab">
    <i class="fas fa-comments"></i>
</div>
<div class="fab-announcement" id="announcement-fab">
    <i class="fas fa-envelope"></i>
</div>
<!-- Announcement Modal -->
<div class="modal-overlay" id="announcement-modal">
    <div class="modal" style="max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h3 class="modal-title">Create Announcement</h3>
            <button class="modal-close" id="close-announcement-modal">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y: auto; flex: 1;">
            <div class="form-group">
                <label class="form-label">Subject</label>
                <input type="text" class="form-control" id="announcement-subject" placeholder="Enter announcement subject">
            </div>
            
            <div class="form-group">
                <label class="form-label">Recipients</label>
                <div class="filter-options" style="margin-bottom: 10px;">
                    <label style="margin-right: 10px;">Filter by:</label>
                    <select id="announcement-filter-role" class="select-control" style="width: auto;">
                        <option value="all">All Roles</option>
                        <option value="staff">Staff</option>
                        <option value="porter">Porters</option>
                        <option value="forklift">Forklift Operators</option>
                        <option value="supervisor">Supervisors</option>
                    </select>
                    <select id="announcement-filter-employer" class="select-control" style="width: auto; margin-left: 10px;">
                        <option value="all">All Employers</option>
                        <!-- Employers will be loaded here -->
                    </select>
                </div>
                <div class="select-all-container" style="margin-bottom: 5px;">
                    <input type="checkbox" id="select-all-employees">
                    <label for="select-all-employees" style="margin-left: 5px;">Select All Visible Employees</label>
                </div>
                <div class="multi-select-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                    <div class="multi-select-options" id="announcement-recipients">
                        <!-- Employees will be loaded here -->
                    </div>
                </div>
                <div class="selected-employees" id="announcement-selected-recipients" style="margin-top: 10px;">
                    <!-- Selected recipients will appear here -->
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Message</label>
                <div class="editor-toolbar">
                    <button type="button" class="editor-btn" data-command="bold"><i class="fas fa-bold"></i></button>
                    <button type="button" class="editor-btn" data-command="italic"><i class="fas fa-italic"></i></button>
                    <button type="button" class="editor-btn" data-command="underline"><i class="fas fa-underline"></i></button>
                    <button type="button" class="editor-btn" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                    <button type="button" class="editor-btn" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                    <button type="button" class="editor-btn" data-command="createLink"><i class="fas fa-link"></i></button>
                    <select class="editor-btn" id="font-size" style="width: auto;">
                        <option value="">Font Size</option>
                        <option value="1">Small</option>
                        <option value="3">Normal</option>
                        <option value="5">Large</option>
                        <option value="7">Extra Large</option>
                    </select>
                    <select class="editor-btn" id="font-family" style="width: auto;">
                        <option value="">Font Family</option>
                        <option value="Arial">Arial</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Verdana">Verdana</option>
                    </select>
                    <input type="color" class="editor-btn" id="font-color" style="width: 30px; height: 30px; padding: 0;">
                </div>
                <div id="announcement-editor" contenteditable="true" class="editor-content"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Attachment (Optional)</label>
                <input type="file" class="form-control" id="announcement-attachment">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" id="cancel-announcement-modal">Cancel</button>
            <button class="btn btn-primary" id="send-announcement">Send Announcement</button>
        </div>
    </div>
</div>
<!-- Report Modal -->
<div class="modal-overlay" id="report-modal">
    <div class="modal" style="width: 700px; height: 90vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h3 class="modal-title">Reports</h3>
            <button class="modal-close" id="close-report-modal">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y: auto; flex: 1;">
            <iframe src="report.html" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" id="cancel-report-modal">Close</button>
        </div>
    </div>
</div>

<!-- Chat Modal -->
<div class="modal-overlay" id="chat-modal">
    <div class="modal" style="width: 700px; height: 90vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h3 class="modal-title">Team Chat</h3>
            <button class="modal-close" id="close-chat-modal">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y: auto; flex: 1;">
            <iframe src="chat.html" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" id="cancel-chat-modal">Close</button>
        </div>
    </div>
</div>
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, orderBy, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-analytics.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDQfo8qILskxClJy52_19tFdx6xMsiQD2M",
        authDomain: "dnata-e2569.firebaseapp.com",
        databaseURL: "https://dnata-e2569-default-rtdb.firebaseio.com",
        projectId: "dnata-e2569",
        storageBucket: "dnata-e2569.firebasestorage.app",
        messagingSenderId: "693382423789",
        appId: "1:693382423789:web:8aa14672c6ef34ee59d8e4",
        measurementId: "G-B6F7CHPM2Y"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // Brevo API Key
    const BREVO_API_KEY = "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";

    // OneSignal App ID
    const ONE_SIGNAL_APP_ID = "8e997ba2-12d1-4d7b-86f5-608d9bf30a56";

    // Initialize OneSignal
    function initializeOneSignal() {
        // Check if OneSignal is already initialized
        if (window.OneSignal) {
            window.OneSignal.init({
                appId: ONE_SIGNAL_APP_ID,
                safari_web_id: "web.onesignal.auto.8e997ba2-12d1-4d7b-86f5-608d9bf30a56",
                notifyButton: {
                    enable: true,
                },
                allowLocalhostAsSecureOrigin: true,
            }).then(() => {
                console.log("OneSignal initialized successfully");
                
                // Check if the user is subscribed
                window.OneSignal.isPushNotificationsEnabled((isEnabled) => {
                    if (!isEnabled) {
                        // Show the push notification prompt
                        window.OneSignal.showSlidedownPrompt();
                    }
                });
            });
        } else {
            console.error("OneSignal not loaded");
        }
    }

    // Send push notification via OneSignal
    async function sendPushNotification(playerIds, title, message, data = {}) {
        try {
            const response = await fetch('https://onesignal.com/api/v1/notifications', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'os_v2_app_r2mxxiqs2fgxxbxvmcgzx4ykkyoyqqjupcoerwvga7cpdam66tnoxcptb2cco4qo7ert4gyu4lak4ggsthudg5ny7wqjykhlg3re7oy' // Replace with your OneSignal REST API key
                },
                body: JSON.stringify({
                    app_id: ONE_SIGNAL_APP_ID,
                    include_player_ids: playerIds,
                    headings: { en: title },
                    contents: { en: message },
                    data: data,
                    ios_badgeType: 'Increase',
                    ios_badgeCount: 1
                })
            });

            const result = await response.json();
            if (result.errors) {
                console.error('Error sending push notification:', result.errors);
                return false;
            }
            return true;
        } catch (error) {
            console.error('Error sending push notification:', error);
            return false;
        }
    }

    // Send push notification to all subscribed users
    async function sendPushNotificationToAll(title, message, data = {}) {
        try {
            // Get all subscribed users from OneSignal (this requires a server-side implementation)
            // For demo purposes, we'll just log this
            console.log(`Sending push notification to all users: ${title} - ${message}`);
            
            // In a real implementation, you would:
            // 1. Get all player IDs from your database or OneSignal API
            // 2. Call sendPushNotification with those IDs
            
            return true;
        } catch (error) {
            console.error('Error sending push notification to all:', error);
            return false;
        }
    }

    // Send break notification to specific user
    async function sendBreakNotification(userId, breakType, duration) {
        try {
            // Get the user's OneSignal player ID from your database
            // For demo purposes, we'll just log this
            console.log(`Sending break notification to user ${userId}: ${breakType} break for ${duration} minutes`);
            
            // In a real implementation, you would:
            // 1. Look up the user's player ID in your database
            // 2. Call sendPushNotification with that ID
            
            return true;
        } catch (error) {
            console.error('Error sending break notification:', error);
            return false;
        }
    }

    // Send chat notification to specific user
    async function sendChatNotification(userId, senderName, message) {
        try {
            // Get the user's OneSignal player ID from your database
            // For demo purposes, we'll just log this
            console.log(`Sending chat notification to user ${userId}: New message from ${senderName}`);
            
            // In a real implementation, you would:
            // 1. Look up the user's player ID in your database
            // 2. Call sendPushNotification with that ID
            
            return true;
        } catch (error) {
            console.error('Error sending chat notification:', error);
            return false;
        }
    }

    // Report Modal Elements
    const reportFab = document.getElementById('report-fab');
    const reportModal = document.getElementById('report-modal');
    const closeReportModalBtn = document.getElementById('close-report-modal');
    const cancelReportModalBtn = document.getElementById('cancel-report-modal');

    // Chat Modal Elements
    const chatFab = document.getElementById('chat-fab');
    const chatModal = document.getElementById('chat-modal');
    const closeChatModalBtn = document.getElementById('close-chat-modal');
    const cancelChatModalBtn = document.getElementById('cancel-chat-modal');

    // Open report modal
    function openReportModal() {
        reportModal.classList.add('active');
    }

    // Close report modal
    function closeReportModal() {
        reportModal.classList.remove('active');
    }

    // Open chat modal
    function openChatModal() {
        chatModal.classList.add('active');
    }

    // Close chat modal
    function closeChatModal() {
        chatModal.classList.remove('active');
    }

    // Add event listeners for report and chat functionality
    function initReportChatFunctionality() {
        // Report button
        reportFab.addEventListener('click', openReportModal);
        closeReportModalBtn.addEventListener('click', closeReportModal);
        cancelReportModalBtn.addEventListener('click', closeReportModal);
        
        // Chat button
        chatFab.addEventListener('click', openChatModal);
        closeChatModalBtn.addEventListener('click', closeChatModal);
        cancelChatModalBtn.addEventListener('click', closeChatModal);
    }

    // Add this function to your existing JavaScript
    async function downloadAssignmentsAsPDF() {
        try {
            // Get current filter values
            const selectedDate = assignDateInput.value;
            const location = assignLocationSelect.value;
            const area = assignAreaSelect.value;
            const shift = assignShiftSelect.value;
            
            // Get assignments based on current filters
            let q = query(collection(db, 'assignments'), where('date', '==', selectedDate));
            
            const snapshot = await getDocs(q);
            const assignments = [];
            
            snapshot.forEach(doc => {
                const assignment = doc.data();
                
                // Apply filters (same as in loadAssignments)
                if (location && assignment.location !== location) return;
                if (area && assignment.area !== area) return;
                if (shift && assignment.shift !== shift) return;
                
                assignments.push(assignment);
            });
            
            if (assignments.length === 0) {
                showNotification('No assignments found to download', 'warning');
                return;
            }
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(18);
            doc.text('Shift Assignments Report', 105, 15, { align: 'center' });
            
            // Add filters info
            doc.setFontSize(12);
            doc.text(`Date: ${selectedDate}`, 14, 25);
            doc.text(`Location: ${location || 'All'}`, 14, 30);
            doc.text(`Area: ${area || 'All'}`, 14, 35);
            doc.text(`Shift: ${shift || 'All'}`, 14, 40);
            
            // Prepare table data
            const tableData = assignments.map(assignment => [
                assignment.employeeName,
                assignment.employeeRole,
                assignment.shift === 'morning' ? 'Morning (6AM-6PM)' : 'Night (6PM-6AM)',
                assignment.location,
                assignment.area
            ]);
            
            // Add table
            doc.autoTable({
                startY: 45,
                head: [['Employee', 'Role', 'Shift', 'Location', 'Area']],
                body: tableData,
                theme: 'grid',
                headStyles: {
                    fillColor: [74, 137, 220], // Primary color
                    textColor: 255
                },
                alternateRowStyles: {
                    fillColor: [240, 240, 240]
                },
                margin: { top: 45 }
            });
            
            // Add footer
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.text(`Page ${i} of ${pageCount}`, 105, doc.internal.pageSize.height - 10, { align: 'center' });
                doc.text(`Generated on ${new Date().toLocaleDateString()}`, 105, doc.internal.pageSize.height - 5, { align: 'center' });
            }
            
            // Save the PDF
            const fileName = `Assignments_${selectedDate}_${new Date().getTime()}.pdf`;
            doc.save(fileName);
            
            showNotification('Assignments downloaded as PDF successfully!');
        } catch (error) {
            console.error('Error generating PDF:', error);
            showNotification('Error generating PDF. Please try again.', 'error');
        }
    }

    // DOM Elements
    const shiftsContainer = document.getElementById('shifts-container');
    const employeesContainer = document.getElementById('employees-container');
    const employersContainer = document.getElementById('employers-container');
    const teamsContainer = document.getElementById('teams-container');
    const assignContainer = document.getElementById('assign-container');
    const outsourcesIframe = document.getElementById('outsources-iframe');
    const teamRulesList = document.getElementById('team-rules-list');
    const addTeamBtn = document.getElementById('add-team-btn');
    const addEmployeeBtn = document.getElementById('add-employee-btn');
    const addEmployerBtn = document.getElementById('add-employer-btn');
    const addAssignmentBtn = document.getElementById('add-assignment-btn');
    const bulkAssignBtn = document.getElementById('bulk-assign-btn');
    const autoGenerateBtn = document.getElementById('auto-generate-btn');
    const applyFiltersBtn = document.getElementById('apply-filters-btn');
    const addRuleBtn = document.getElementById('add-rule-btn');
    const shiftDateInput = document.getElementById('shift-date');
    const teamsDateInput = document.getElementById('teams-date');
    const assignDateInput = document.getElementById('assign-date');
    const assignLocationSelect = document.getElementById('assign-location');
    const assignAreaSelect = document.getElementById('assign-area');
    const assignShiftSelect = document.getElementById('assign-shift');
    
    // Notification elements
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notification-message');
    
    // Modals
    const teamModal = document.getElementById('team-modal');
    const closeTeamModalBtn = document.getElementById('close-team-modal');
    const cancelTeamModalBtn = document.getElementById('cancel-team-modal');
    const saveTeamBtn = document.getElementById('save-team');
    
    const autoGenerateModal = document.getElementById('auto-generate-modal');
    const closeAutoGenerateModalBtn = document.getElementById('close-auto-generate-modal');
    const cancelAutoGenerateModalBtn = document.getElementById('cancel-auto-generate-modal');
    const confirmAutoGenerateBtn = document.getElementById('confirm-auto-generate');
    const autoGenerateDateInput = document.getElementById('auto-generate-date');
    const autoGenerateShiftSelect = document.getElementById('auto-generate-shift');
    const incompleteMembersList = document.getElementById('incomplete-members-list');
    
    const employeeModal = document.getElementById('employee-modal');
    const closeEmployeeModalBtn = document.getElementById('close-employee-modal');
    const cancelEmployeeModalBtn = document.getElementById('cancel-employee-modal');
    const saveEmployeeBtn = document.getElementById('save-employee');
    
    const employerModal = document.getElementById('employer-modal');
    const closeEmployerModalBtn = document.getElementById('close-employer-modal');
    const cancelEmployerModalBtn = document.getElementById('cancel-employer-modal');
    const saveEmployerBtn = document.getElementById('save-employer');
    
    const assignModal = document.getElementById('assign-modal');
    const closeAssignModalBtn = document.getElementById('close-assign-modal');
    const cancelAssignModalBtn = document.getElementById('cancel-assign-modal');
    const saveAssignmentBtn = document.getElementById('save-assignment');
    
    const bulkAssignModal = document.getElementById('bulk-assign-modal');
    const closeBulkAssignModalBtn = document.getElementById('close-bulk-assign-modal');
    const cancelBulkAssignModalBtn = document.getElementById('cancel-bulk-assign-modal');
    const saveBulkAssignmentBtn = document.getElementById('save-bulk-assignment');
    const bulkEmployeesList = document.getElementById('bulk-employees-list');
    const selectedEmployeesList = document.getElementById('selected-employees-list');
    
    const addRuleModal = document.getElementById('add-rule-modal');
    const closeAddRuleModalBtn = document.getElementById('close-add-rule-modal');
    const cancelAddRuleModalBtn = document.getElementById('cancel-add-rule-modal');
    const saveRuleBtn = document.getElementById('save-rule');
    const ruleDateInput = document.getElementById('rule-date');
    const ruleLocationSelect = document.getElementById('rule-location');
    const ruleAreaSelect = document.getElementById('rule-area');
    const ruleShiftSelect = document.getElementById('rule-shift');
    const ruleStaffInput = document.getElementById('rule-staff');
    const rulePortersInput = document.getElementById('rule-porters');
    const ruleForkliftsInput = document.getElementById('rule-forklifts');
    
    // Team form elements
    const teamDateInput = document.getElementById('team-date');
    const teamShiftSelect = document.getElementById('team-shift');
    const teamLocationSelect = document.getElementById('team-location');
    const teamAreaSelect = document.getElementById('team-area');
    const teamSupervisorSelect = document.getElementById('team-supervisor');
    const staffMemberSelect = document.getElementById('staff-member');
    const portersSelect = document.getElementById('porters');
    const forkliftOperatorSelect = document.getElementById('forklift-operator');
   
    // Assign form elements
    const assignEmployeeDateInput = document.getElementById('assign-employee-date');
    const assignEmployeeShiftSelect = document.getElementById('assign-employee-shift');
    const assignEmployeeLocationSelect = document.getElementById('assign-employee-location');
    const assignEmployeeAreaSelect = document.getElementById('assign-employee-area');
    const assignEmployeeSelect = document.getElementById('assign-employee');
    
    // Bulk assign form elements
    const bulkAssignDateInput = document.getElementById('bulk-assign-date');
    const bulkAssignShiftSelect = document.getElementById('bulk-assign-shift');
    const bulkAssignLocationSelect = document.getElementById('bulk-assign-location');
    const bulkAssignAreaSelect = document.getElementById('bulk-assign-area');
   
    // Add this with the other DOM element declarations
    const downloadAssignmentsBtn = document.getElementById('download-assignments-btn');

    // Employee form elements
    const employeeFirstNameInput = document.getElementById('employee-first-name');
    const employeeLastNameInput = document.getElementById('employee-last-name');
    const employeeIdInput = document.getElementById('employee-id');
    const employeeEmployerSelect = document.getElementById('employee-employer');
    const employeeRoleSelect = document.getElementById('employee-role');
    const employeeEmailInput = document.getElementById('employee-email');
    
    // Employer form elements
    const employerNameInput = document.getElementById('employer-name');
    const employerEmailInput = document.getElementById('employer-email');
    
    // Dashboard elements
    const totalEmployeesEl = document.getElementById('total-employees');
    const totalTeamsEl = document.getElementById('total-teams');
    const morningCountEl = document.getElementById('morning-count');
    const nightCountEl = document.getElementById('night-count');
    
    // Navigation
    const menuItems = document.querySelectorAll('.menu-item');
    const sectionContents = document.querySelectorAll('.section-content');
    const shiftTabs = document.querySelectorAll('.shift-section .tab');
    const employeeTabs = document.querySelectorAll('.employees-section .tab');

    // DOM Elements for team filters
    const teamsLocationSelect = document.getElementById('teams-location');
    const teamsAreaSelect = document.getElementById('teams-area');
    const teamsShiftSelect = document.getElementById('teams-shift');
    const applyTeamsFiltersBtn = document.getElementById('apply-teams-filters-btn');
    // Selected employees for bulk assignment
    let selectedEmployees = [];

    // Show notification
    function showNotification(message, type = 'success') {
        notificationMessage.textContent = message;
        notification.className = `notification ${type} show`;
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 5000);
        
        // Also send a push notification for important messages
        if (type === 'success' || type === 'error') {
            sendPushNotificationToAll('ShiftMaster Notification', message);
        }
    }

    // Send email using Brevo API
    async function sendEmail(to, subject, htmlContent) {
        try {
            const response = await fetch('https://api.brevo.com/v3/smtp/email', {
                method: 'POST',
                headers: {
                    'accept': 'application/json',
                    'api-key': BREVO_API_KEY,
                    'content-type': 'application/json'
                },
                body: JSON.stringify({
                    sender: {
                        name: "ShiftMaster Pro",
                        email: "noreply@shiftmaster.com"
                    },
                    to: [{ email: to }],
                    subject: subject,
                    htmlContent: htmlContent
                })
            });
            
            const data = await response.json();
            if (!response.ok) {
                console.error('Error sending email:', data);
                return false;
            }
            
            return true;
        } catch (error) {
            console.error('Error sending email:', error);
            return false;
        }
    }

    // Send team notification emails to all team members
    async function sendTeamNotificationEmails(team) {
        try {
            // Get all employee details
            const employeesSnapshot = await getDocs(collection(db, 'employees'));
            const employeesData = {};
            employeesSnapshot.forEach(doc => {
                employeesData[doc.id] = doc.data();
            });
            
            if (!employeesData) return;
            
            // Get all team member emails
            const teamMembers = [];
            
            // Add supervisor if exists
            if (team.supervisor && team.supervisor.id) {
                teamMembers.push({ 
                    id: team.supervisor.id, 
                    role: 'Supervisor',
                    name: team.supervisor.name
                });
            }
            
            // Add staff members (both single staff and staff array)
            if (team.staff) {
                if (Array.isArray(team.staff)) {
                    team.staff.forEach(staff => {
                        teamMembers.push({
                            id: staff.id,
                            role: 'Staff Member',
                            name: staff.name
                        });
                    });
                } else if (team.staff.id) {
                    teamMembers.push({
                        id: team.staff.id,
                        role: 'Staff Member',
                        name: team.staff.name
                    });
                }
            }
            
            // Add porters
            if (team.porters && team.porters.length > 0) {
                team.porters.forEach(porter => {
                    teamMembers.push({
                        id: porter.id,
                        role: 'Porter',
                        name: porter.name
                    });
                });
            }
            
            // Add forklift operators (both single operator and operators array)
            if (team.forkliftOperator && team.forkliftOperator.id) {
                teamMembers.push({
                    id: team.forkliftOperator.id,
                    role: 'Forklift Operator',
                    name: team.forkliftOperator.name
                });
            }
            
            if (team.forkliftOperators && team.forkliftOperators.length > 0) {
                team.forkliftOperators.forEach(forklift => {
                    teamMembers.push({
                        id: forklift.id,
                        role: 'Forklift Operator',
                        name: forklift.name
                    });
                });
            }
            
            // Prepare email content
            const shiftTime = team.shift === 'morning' ? '6:00 AM - 6:00 PM' : '6:00 PM - 6:00 AM';
            const locationInfo = team.location ? ` at ${team.location}` : '';
            const areaInfo = team.area ? ` (${team.area})` : '';
            
            // Send email to each team member
            const emailPromises = teamMembers.map(async (member) => {
                const employee = employeesData[member.id];
                if (!employee || !employee.email) {
                    console.log(`No email found for employee ${member.id}`);
                    return;
                }
                
                const subject = `Your Team Assignment for ${team.date}`;
                
                const htmlContent = `
                    <h2>Team Assignment Notification</h2>
                    <p>Hello ${employee.firstName},</p>
                    <p>You have been assigned to a team for your upcoming shift:</p>
                    
                    <h3>Team Details</h3>
                    <ul>
                        <li><strong>Team Name:</strong> ${team.name}</li>
                        <li><strong>Date:</strong> ${team.date}</li>
                        <li><strong>Shift:</strong> ${shiftTime}</li>
                        <li><strong>Location:</strong> ${team.location || 'Not specified'}</li>
                        <li><strong>Area:</strong> ${team.area || 'Not specified'}</li>
                        <li><strong>Your Role:</strong> ${member.role} ${member.role === 'Supervisor' ? '(Team Leader)' : ''}</li>
                    </ul>
                    
                    <h3>Team Members</h3>
                    <ul>
                        ${team.supervisor && team.supervisor.id ? `<li><strong>Supervisor:</strong> ${team.supervisor.name} (Team Leader)</li>` : ''}
                        ${team.staff ? 
                            (Array.isArray(team.staff) ? 
                                team.staff.map(staff => `<li><strong>Staff Member:</strong> ${staff.name}</li>`).join('') : 
                                `<li><strong>Staff Member:</strong> ${team.staff.name}</li>`) : ''}
                        ${team.porters ? team.porters.map(porter => `<li><strong>Porter:</strong> ${porter.name}</li>`).join('') : ''}
                        ${team.forkliftOperator ? `<li><strong>Forklift Operator:</strong> ${team.forkliftOperator.name}</li>` : ''}
                        ${team.forkliftOperators ? team.forkliftOperators.map(forklift => `<li><strong>Forklift Operator:</strong> ${forklift.name}</li>`).join('') : ''}
                    </ul>
                    
                    <p>Please arrive on time and coordinate with your team members.</p>
                    <p>Thank you,</p>
                    <p>The ShiftMaster Team</p>
                `;
                
                // Send email and push notification
                await sendEmail(employee.email, subject, htmlContent);
                await sendPushNotification([employee.id], 'Team Assignment', `You've been assigned to ${team.name} for ${team.date}`);
            });
            
            await Promise.all(emailPromises);
            console.log('Team notification emails and push notifications sent successfully');
        } catch (error) {
            console.error('Error sending team notifications:', error);
        }
    }

    // Initialize the app
    function initApp() {
        // Initialize OneSignal
        initializeOneSignal();
        
        // Set current date
        const today = new Date().toISOString().split('T')[0];
        shiftDateInput.value = today;
        teamsDateInput.value = today;
        teamDateInput.value = today;
        assignDateInput.value = today;
        assignEmployeeDateInput.value = today;
        bulkAssignDateInput.value = today;
        autoGenerateDateInput.value = today;
        ruleDateInput.value = today;
        initAnnouncementFunctionality();
        
        // Set up event listeners
        addTeamBtn.addEventListener('click', openTeamModal);
        closeTeamModalBtn.addEventListener('click', closeTeamModal);
        cancelTeamModalBtn.addEventListener('click', closeTeamModal);
        saveTeamBtn.addEventListener('click', saveTeam);
        
        autoGenerateBtn.addEventListener('click', openAutoGenerateModal);
        closeAutoGenerateModalBtn.addEventListener('click', closeAutoGenerateModal);
        cancelAutoGenerateModalBtn.addEventListener('click', closeAutoGenerateModal);
        confirmAutoGenerateBtn.addEventListener('click', confirmAutoGenerate);
        
        addEmployeeBtn.addEventListener('click', openEmployeeModal);
        closeEmployeeModalBtn.addEventListener('click', closeEmployeeModal);
        cancelEmployeeModalBtn.addEventListener('click', closeEmployeeModal);
        saveEmployeeBtn.addEventListener('click', saveEmployee);
        
        addEmployerBtn.addEventListener('click', openEmployerModal);
        closeEmployerModalBtn.addEventListener('click', closeEmployerModal);
        cancelEmployerModalBtn.addEventListener('click', closeEmployerModal);
        saveEmployerBtn.addEventListener('click', saveEmployer);
        
        addAssignmentBtn.addEventListener('click', openAssignModal);
        bulkAssignBtn.addEventListener('click', openBulkAssignModal);
        applyFiltersBtn.addEventListener('click', loadAssignments);
        closeAssignModalBtn.addEventListener('click', closeAssignModal);
        cancelAssignModalBtn.addEventListener('click', closeAssignModal);
        saveAssignmentBtn.addEventListener('click', saveAssignment);
        
        closeBulkAssignModalBtn.addEventListener('click', closeBulkAssignModal);
        cancelBulkAssignModalBtn.addEventListener('click', closeBulkAssignModal);
        saveBulkAssignmentBtn.addEventListener('click', saveBulkAssignment);
        
        addRuleBtn.addEventListener('click', openAddRuleModal);
        closeAddRuleModalBtn.addEventListener('click', closeAddRuleModal);
        cancelAddRuleModalBtn.addEventListener('click', closeAddRuleModal);
        saveRuleBtn.addEventListener('click', saveTeamRule);
        downloadAssignmentsBtn.addEventListener('click', downloadAssignmentsAsPDF);
        
        // Employee search functionality
        const employeeSearchInput = document.getElementById('employee-search');
        employeeSearchInput.addEventListener('input', filterEmployees);
        
        // Date change listeners
        shiftDateInput.addEventListener('change', loadShiftsForDate);
        teamsDateInput.addEventListener('change', loadTeamsForDate);
        assignDateInput.addEventListener('change', loadAssignments);
        
        // Shift tab listeners
        shiftTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                shiftTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                loadShiftsForDate();
            });
        });
        
        // Employee tab listeners
        employeeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                employeeTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                loadEmployees();
            });
        });
        
        // Set up navigation
        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const section = item.getAttribute('data-section');
                if (section) {
                    switchSection(section);
                }
            });
        });
        
        // Team filters event listeners
        applyTeamsFiltersBtn.addEventListener('click', loadTeamsForDate);
        teamsDateInput.addEventListener('change', loadTeamsForDate);
        teamsLocationSelect.addEventListener('change', loadTeamsForDate);
        teamsAreaSelect.addEventListener('change', loadTeamsForDate);
        teamsShiftSelect.addEventListener('change', loadTeamsForDate);
        
        // Load initial data
        loadEmployers();
        loadEmployees();
        loadShiftsForDate();
        loadTeamsForDate();
        loadAssignments();
        loadTeamRules();
        updateDashboardCounts();
        
        // Initialize report and chat functionality
        initReportChatFunctionality();
    }

    function filterEmployees() {
        const searchTerm = document.getElementById('employee-search').value.toLowerCase();
        const employeeCards = document.querySelectorAll('.employee-card');
        
        employeeCards.forEach(card => {
            const name = card.querySelector('.employee-name').textContent.toLowerCase();
            const role = card.querySelector('.employee-role').textContent.toLowerCase();
            const employer = card.querySelector('.employee-employer').textContent.toLowerCase();
            const id = card.textContent.toLowerCase(); // Includes ID if present
            
            if (name.includes(searchTerm) || 
                role.includes(searchTerm) || 
                employer.includes(searchTerm) ||
                id.includes(searchTerm)) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Switch between sections
    function switchSection(section) {
        // Update menu items
        menuItems.forEach(item => {
            if (item.getAttribute('data-section') === section) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
        
        // Update content sections
        sectionContents.forEach(content => {
            if (content.classList.contains(`${section}-section`)) {
                content.classList.add('active');
            } else {
                content.classList.remove('active');
            }
        });
        
        // Load specific section data
        if (section === 'dashboard') {
            loadShiftsForDate();
        } else if (section === 'employees') {
            loadEmployees();
        } else if (section === 'employers') {
            loadEmployers();
        } else if (section === 'teams') {
            loadTeamsForDate();
        } else if (section === 'assign') {
            loadAssignments();
        } else if (section === 'outsources') {
            // Ensure iframe is reloaded when switching to outsources section
            outsourcesIframe.contentWindow.location.reload();
        } else if (section === 'settings') {
            loadTeamRules();
        }
    }

    // Load team rules from Firestore
    function loadTeamRules() {
        const q = query(collection(db, 'teamRules'), orderBy('createdAt', 'desc'));
        
        onSnapshot(q, (snapshot) => {
            teamRulesList.innerHTML = '';
            
            if (snapshot.empty) {
                teamRulesList.innerHTML = '<div class="team-rule-item">No team rules defined yet.</div>';
                return;
            }
            
            snapshot.forEach(doc => {
                createTeamRuleCard(doc.id, doc.data());
            });
        });
    }

    // Create team rule card
    function createTeamRuleCard(id, rule) {
        const ruleItem = document.createElement('div');
        ruleItem.className = 'team-rule-item';
        
        ruleItem.innerHTML = `
            <div class="team-rule-details">
                <div class="team-rule-date">${rule.date} - ${rule.shift === 'all' ? 'All Shifts' : (rule.shift === 'morning' ? 'Morning' : 'Night')}</div>
                <div class="team-rule-location">${rule.location === 'all' ? 'All Locations' : rule.location} - ${rule.area === 'all' ? 'All Areas' : rule.area}</div>
                <div class="team-rule-requirements">
                    <span class="team-rule-requirement">${rule.staff} Staff</span>
                    <span class="team-rule-requirement">${rule.porters} Porters</span>
                    <span class="team-rule-requirement">${rule.forklifts} Forklifts</span>
                </div>
            </div>
            <div class="team-rule-actions">
                <div class="action-btn edit-btn" data-id="${id}">
                    <i class="fas fa-edit"></i>
                </div>
                <div class="action-btn delete-btn" data-id="${id}">
                    <i class="fas fa-trash"></i>
                </div>
            </div>
        `;
        
        // Add event listeners to action buttons
        ruleItem.querySelector('.edit-btn').addEventListener('click', () => editTeamRule(id, rule));
        ruleItem.querySelector('.delete-btn').addEventListener('click', () => deleteTeamRule(id));
        
        teamRulesList.appendChild(ruleItem);
    }

    // Open add rule modal
    function openAddRuleModal() {
        // Set the date to the selected shift date
        ruleDateInput.value = new Date().toISOString().split('T')[0];
        ruleLocationSelect.value = 'all';
        ruleAreaSelect.value = 'all';
        ruleShiftSelect.value = 'all';
        ruleStaffInput.value = '1';
        rulePortersInput.value = '2';
        ruleForkliftsInput.value = '1';
        
        addRuleModal.classList.add('active');
    }

    // Close add rule modal
    function closeAddRuleModal() {
        addRuleModal.classList.remove('active');
    }

    // Check if a rule already exists for the same date, location, area and shift
    async function ruleExists(date, location, area, shift) {
        try {
            // Query for rules with the same parameters
            const q = query(
                collection(db, 'teamRules'),
                where('date', '==', date),
                where('location', '==', location),
                where('area', '==', area),
                where('shift', '==', shift)
            );
            
            const snapshot = await getDocs(q);
            return !snapshot.empty;
        } catch (error) {
            console.error('Error checking for existing rule:', error);
            return false;
        }
    }

    // Save team rule to Firestore
    async function saveTeamRule() {
        const date = ruleDateInput.value;
        const location = ruleLocationSelect.value;
        const area = ruleAreaSelect.value;
        const shift = ruleShiftSelect.value;
        const staff = parseInt(ruleStaffInput.value);
        const porters = parseInt(rulePortersInput.value);
        const forklifts = parseInt(ruleForkliftsInput.value);
        
        // Validate inputs
        if (!date || isNaN(staff) || isNaN(porters) || isNaN(forklifts)) {
            showNotification('Please fill all fields with valid numbers', 'error');
            return;
        }
        
        // Check if a rule already exists for this combination
        const exists = await ruleExists(date, location, area, shift);
        if (exists) {
            showNotification('A rule already exists for this date, location, area and shift combination.', 'error');
            return;
        }
        
        // Create rule object
        const rule = {
            date,
            location,
            area,
            shift,
            staff,
            porters,
            forklifts,
            createdAt: new Date().toISOString()
        };
        
        // Save to Firestore
        try {
            await addDoc(collection(db, 'teamRules'), rule);
            showNotification('Team rule saved successfully!');
            closeAddRuleModal();
        } catch (error) {
            console.error('Error saving team rule:', error);
            showNotification('Error saving team rule. Please try again.', 'error');
        }
    }

    // Edit team rule
    async function editTeamRule(id, rule) {
        // Open modal and set the form values
        openAddRuleModal();
        
        ruleDateInput.value = rule.date;
        ruleLocationSelect.value = rule.location;
        ruleAreaSelect.value = rule.area;
        ruleShiftSelect.value = rule.shift;
        ruleStaffInput.value = rule.staff;
        rulePortersInput.value = rule.porters;
        ruleForkliftsInput.value = rule.forklifts;
        
        // Change save button to update
        saveRuleBtn.textContent = 'Update Rule';
        saveRuleBtn.onclick = async function() {
            // First delete the old rule
            try {
                await deleteDoc(doc(db, 'teamRules', id));
                
                // Then create a new rule with updated values
                const updatedRule = {
                    date: ruleDateInput.value,
                    location: ruleLocationSelect.value,
                    area: ruleAreaSelect.value,
                    shift: ruleShiftSelect.value,
                    staff: parseInt(ruleStaffInput.value),
                    porters: parseInt(rulePortersInput.value),
                    forklifts: parseInt(ruleForkliftsInput.value),
                    createdAt: new Date().toISOString()
                };
                
                // Validate inputs
                if (!updatedRule.date || isNaN(updatedRule.staff) || isNaN(updatedRule.porters) || isNaN(updatedRule.forklifts)) {
                    showNotification('Please fill all fields with valid numbers', 'error');
                    return;
                }
                
                // Check if a rule already exists for this combination
                const exists = await ruleExists(updatedRule.date, updatedRule.location, updatedRule.area, updatedRule.shift);
                if (exists) {
                    showNotification('A rule already exists for this date, location, area and shift combination.', 'error');
                    return;
                }
                
                await addDoc(collection(db, 'teamRules'), updatedRule);
                showNotification('Team rule updated successfully!');
                closeAddRuleModal();
                loadTeamRules(); // Reload the rules to reflect changes
            } catch (error) {
                console.error('Error updating team rule:', error);
                showNotification('Error updating team rule. Please try again.', 'error');
            }
        };
    }

    // Delete team rule
    async function deleteTeamRule(id) {
        if (confirm('Are you sure you want to delete this team rule?')) {
            try {
                await deleteDoc(doc(db, 'teamRules', id));
                showNotification('Team rule deleted successfully!');
            } catch (error) {
                console.error('Error deleting team rule:', error);
                showNotification('Error deleting team rule. Please try again.', 'error');
            }
        }
    }

    // Get team requirements for a specific date, location, area and shift
    async function getTeamRequirements(date, location, area, shift) {
        try {
            // First try to find exact match for location/area/shift
            const exactQuery = query(
                collection(db, 'teamRules'),
                where('date', '==', date),
                where('location', '==', location),
                where('area', '==', area),
                where('shift', '==', shift)
            );
            
            const exactSnapshot = await getDocs(exactQuery);
            
            if (!exactSnapshot.empty) {
                const rule = exactSnapshot.docs[0].data();
                return {
                    staff: rule.staff,
                    porters: rule.porters,
                    forklifts: rule.forklifts
                };
            }
            
            // If no exact match, try to find rules with 'all' for some fields
            const possibleRules = [];
            
            // Try with 'all' for area
            const areaAllQuery = query(
                collection(db, 'teamRules'),
                where('date', '==', date),
                where('location', '==', location),
                where('area', '==', 'all'),
                where('shift', '==', shift)
            );
            
            const areaAllSnapshot = await getDocs(areaAllQuery);
            areaAllSnapshot.forEach(doc => possibleRules.push(doc.data()));
            
            // Try with 'all' for location
            const locationAllQuery = query(
                collection(db, 'teamRules'),
                where('date', '==', date),
                where('location', '==', 'all'),
                where('area', '==', area),
                where('shift', '==', shift)
            );
            
            const locationAllSnapshot = await getDocs(locationAllQuery);
            locationAllSnapshot.forEach(doc => possibleRules.push(doc.data()));
            
            // Try with 'all' for both location and area
            const locationAreaAllQuery = query(
                collection(db, 'teamRules'),
                where('date', '==', date),
                where('location', '==', 'all'),
                where('area', '==', 'all'),
                where('shift', '==', shift)
            );
            
            const locationAreaAllSnapshot = await getDocs(locationAreaAllQuery);
            locationAreaAllSnapshot.forEach(doc => possibleRules.push(doc.data()));
            
            // Try with 'all' for shift
            const shiftAllQuery = query(
                collection(db, 'teamRules'),
                where('date', '==', date),
                where('location', '==', location),
                where('area', '==', area),
                where('shift', '==', 'all')
            );
            
            const shiftAllSnapshot = await getDocs(shiftAllQuery);
            shiftAllSnapshot.forEach(doc => possibleRules.push(doc.data()));
            
            // Try with 'all' for shift and area
            const shiftAreaAllQuery = query(
                collection(db, 'teamRules'),
                where('date', '==', date),
                where('location', '==', location),
                where('area', '==', 'all'),
                where('shift', '==', 'all')
            );
            
            const shiftAreaAllSnapshot = await getDocs(shiftAreaAllQuery);
            shiftAreaAllSnapshot.forEach(doc => possibleRules.push(doc.data()));
            
            // Try with 'all' for shift and location
            const shiftLocationAllQuery = query(
                collection(db, 'teamRules'),
                where('date', '==', date),
                where('location', '==', 'all'),
                where('area', '==', area),
                where('shift', '==', 'all')
            );
            
            const shiftLocationAllSnapshot = await getDocs(shiftLocationAllQuery);
            shiftLocationAllSnapshot.forEach(doc => possibleRules.push(doc.data()));
            
            // Try with 'all' for shift, location and area
            const allAllQuery = query(
                collection(db, 'teamRules'),
                where('date', '==', date),
                where('location', '==', 'all'),
                where('area', '==', 'all'),
                where('shift', '==', 'all')
            );
            
            const allAllSnapshot = await getDocs(allAllQuery);
            allAllSnapshot.forEach(doc => possibleRules.push(doc.data()));
            
            // If we found any rules, return the most specific one
            if (possibleRules.length > 0) {
                // Sort by specificity (count of non-'all' fields)
                possibleRules.sort((a, b) => {
                    const aScore = (a.location === 'all' ? 0 : 1) + (a.area === 'all' ? 0 : 1) + (a.shift === 'all' ? 0 : 1);
                    const bScore = (b.location === 'all' ? 0 : 1) + (b.area === 'all' ? 0 : 1) + (b.shift === 'all' ? 0 : 1);
                    return bScore - aScore;
                });
                
                return {
                    staff: possibleRules[0].staff,
                    porters: possibleRules[0].porters,
                    forklifts: possibleRules[0].forklifts
                };
            }
            
            // No matching rules found
            return null;
        } catch (error) {
            console.error('Error getting team requirements:', error);
            return null;
        }
    }

    // Load employers from Firestore
    function loadEmployers() {
        const q = query(collection(db, 'employers'), orderBy('createdAt', 'desc'));
        
        onSnapshot(q, (snapshot) => {
            employersContainer.innerHTML = '';
            
            if (snapshot.empty) {
                employersContainer.innerHTML = '<p>No employers found. Add your first employer!</p>';
                createDefaultEmployer();
                return;
            }
            
            snapshot.forEach(doc => {
                createEmployerCard(doc.id, doc.data());
            });
            
            // Update employee form select
            updateEmployeeFormSelects();
        });
    }

    // Create default employer (DNATA)
    async function createDefaultEmployer() {
        const defaultEmployer = {
            name: 'DNATA',
            email: 'info@dnata.com',
            createdAt: new Date().toISOString()
        };
        
        try {
            await addDoc(collection(db, 'employers'), defaultEmployer);
        } catch (error) {
            console.error('Error creating default employer:', error);
        }
    }

    // Create employer card
    function createEmployerCard(id, employer) {
        const employerCard = document.createElement('div');
        employerCard.className = 'employer-card fade-in';
        
        // Get initials for avatar
        const initials = employer.name.split(' ').map(n => n[0]).join('').substring(0, 2);
        
        employerCard.innerHTML = `
            <div class="employer-avatar">${initials}</div>
            <div class="employer-info">
                <div class="employer-name">${employer.name}</div>
                <div class="employer-employees">${employer.email}</div>
            </div>
            <div class="employer-actions">
                <div class="action-btn edit-btn" data-id="${id}">
                    <i class="fas fa-edit"></i>
                </div>
                <div class="action-btn delete-btn" data-id="${id}">
                    <i class="fas fa-trash"></i>
                </div>
            </div>
        `;
        
        // Add event listeners to action buttons
        employerCard.querySelector('.edit-btn').addEventListener('click', () => editEmployer(id, employer));
        employerCard.querySelector('.delete-btn').addEventListener('click', () => deleteEmployer(id));
        
        employersContainer.appendChild(employerCard);
    }

    // Load employees from Firestore
    function loadEmployees() {
        const q = query(collection(db, 'employees'), orderBy('createdAt', 'desc'));
        
        onSnapshot(q, (snapshot) => {
            employeesContainer.innerHTML = '';
            
            if (snapshot.empty) {
                employeesContainer.innerHTML = '<p>No employees found. Add your first employee!</p>';
                updateDashboardCounts();
                updateTeamFormSelects();
                updateAssignFormSelects();
                updateBulkAssignFormSelects();
                return;
            }
            
            const activeTab = document.querySelector('.employees-section .tab.active');
            const roleFilter = activeTab.getAttribute('data-role');
            
            snapshot.forEach(doc => {
                const employee = doc.data();
                
                // Apply role filter if not "all"
                if (roleFilter !== 'all' && employee.role !== roleFilter) {
                    return;
                }
                
                createEmployeeCard(doc.id, employee);
            });
            
            // Update dashboard counts
            updateDashboardCounts();
            
            // Update team form selects
            updateTeamFormSelects();
            
            // Update assign form selects
            updateAssignFormSelects();
            
            // Update bulk assign form selects
            updateBulkAssignFormSelects();
        });
    }

    // Create employee card
    function createEmployeeCard(id, employee) {
        const employeeCard = document.createElement('div');
        employeeCard.className = 'employee-card fade-in';
        
        // Get initials for avatar
        const initials = `${employee.firstName.charAt(0)}${employee.lastName.charAt(0)}`;
        
        // Determine role display text and color
        let roleText = '';
        let roleColor = '';
        
        switch(employee.role) {
            case 'staff':
                roleText = 'Staff Member';
                roleColor = 'var(--primary-color)';
                break;
            case 'porter':
                roleText = 'Porter';
                roleColor = 'var(--success-color)';
                break;
            case 'forklift':
                roleText = 'Forklift Operator';
                roleColor = 'var(--accent-color)';
                break;
            case 'supervisor':
                roleText = 'Supervisor';
                roleColor = '#e91e63';
                break;
        }
        
        employeeCard.innerHTML = `
            <div class="employee-avatar" style="background: ${roleColor}">${initials}</div>
            <div class="employee-info">
                <div class="employee-name">${employee.firstName} ${employee.lastName}</div>
                <div>
                    <span class="employee-role">${roleText}</span>
                    <span class="employee-employer">${employee.employerName || 'No employer'}</span>
                </div>
                ${employee.id ? `<div style="font-size: 12px; color: #888; margin-top: 5px;">ID: ${employee.id}</div>` : ''}
                ${employee.email ? `<div style="font-size: 12px; color: #888; margin-top: 5px;">${employee.email}</div>` : ''}
            </div>
            <div class="employee-actions">
                <div class="action-btn edit-btn" data-id="${id}">
                    <i class="fas fa-edit"></i>
                </div>
                <div class="action-btn delete-btn" data-id="${id}">
                    <i class="fas fa-trash"></i>
                </div>
            </div>
        `;
        
        // Add event listeners to action buttons
        employeeCard.querySelector('.edit-btn').addEventListener('click', () => editEmployee(id, employee));
        employeeCard.querySelector('.delete-btn').addEventListener('click', () => deleteEmployee(id));
        
        employeesContainer.appendChild(employeeCard);
    }

    // Load shifts for selected date with filter
    function loadShiftsForDate() {
        const selectedDate = shiftDateInput.value;
        const q = query(collection(db, 'teams'), where('date', '==', selectedDate));
        
        // Get active tab
        const activeTab = document.querySelector('.shift-section .tab.active');
        const shiftFilter = activeTab.getAttribute('data-shift');
        
        onSnapshot(q, (snapshot) => {
            shiftsContainer.innerHTML = '';
            
            let morningTeams = [];
            let nightTeams = [];
            
            if (snapshot.empty) {
                shiftsContainer.innerHTML = '<p>No teams scheduled for this date. Add your first team!</p>';
                updateDashboardCounts();
                return;
            }
            
            snapshot.forEach(doc => {
                const team = doc.data();
                team.id = doc.id;
                
                // Apply shift filter if not "all"
                if (shiftFilter === 'all' || team.shift === shiftFilter) {
                    if (team.shift === 'morning') {
                        morningTeams.push(team);
                    } else {
                        nightTeams.push(team);
                    }
                }
            });
            
            // Sort teams by creation date (newest first)
            morningTeams.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            nightTeams.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Create morning shift card if we have morning teams or no filter
            if (shiftFilter === 'all' || shiftFilter === 'morning') {
                createShiftCard('morning', `Morning Shift (6:00 AM - 6:00 PM) - ${selectedDate}`, morningTeams);
            }
            
            // Create night shift card if we have night teams or no filter
            if (shiftFilter === 'all' || shiftFilter === 'night') {
                createShiftCard('night', `Night Shift (6:00 PM - 6:00 AM) - ${selectedDate}`, nightTeams);
            }
            
            // Update dashboard counts
            updateDashboardCounts();
        });
    }

    // Load all teams for selected date with filters
    function loadTeamsForDate() {
        const selectedDate = teamsDateInput.value;
        const location = teamsLocationSelect.value;
        const area = teamsAreaSelect.value;
        const shift = teamsShiftSelect.value;
        
        let q = query(collection(db, 'teams'), where('date', '==', selectedDate), orderBy('createdAt', 'desc'));
        
        onSnapshot(q, (snapshot) => {
            teamsContainer.innerHTML = '';
            
            if (snapshot.empty) {
                teamsContainer.innerHTML = '<p>No teams created for this date. Add your first team!</p>';
                return;
            }
            
            snapshot.forEach(doc => {
                const team = doc.data();
                
                // Apply filters
                if (location && location !== 'all' && team.location !== location) return;
                if (area && area !== 'all' && team.area !== area) return;
                if (shift && shift !== 'all' && team.shift !== shift) return;
                
                createTeamCard(doc.id, team);
            });
        });
    }

    // Load assignments based on filters
    function loadAssignments() {
        const selectedDate = assignDateInput.value;
        const location = assignLocationSelect.value;
        const area = assignAreaSelect.value;
        const shift = assignShiftSelect.value;
        
        let q = query(collection(db, 'assignments'), where('date', '==', selectedDate));
        
        onSnapshot(q, (snapshot) => {
            assignContainer.innerHTML = '';
            
            if (snapshot.empty) {
                assignContainer.innerHTML = '<p>No assignments found for the selected filters.</p>';
                return;
            }
            
            snapshot.forEach(doc => {
                const assignment = doc.data();
                
                // Apply filters
                if (location && assignment.location !== location) return;
                if (area && assignment.area !== area) return;
                if (shift && assignment.shift !== shift) return;
                
                createAssignmentCard(doc.id, assignment);
            });
        });
    }

    // Create assignment card
    function createAssignmentCard(id, assignment) {
        const assignCard = document.createElement('div');
        assignCard.className = 'assign-card fade-in';
        
        // Get shift color
        const shiftColor = assignment.shift === 'morning' ? 'orange' : 'red';
        
        assignCard.innerHTML = `
            <div class="assign-header">
                <div class="assign-title">${assignment.employeeName}</div>
                <div class="member-actions">
                    <div class="action-btn edit-btn" data-id="${id}">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="action-btn delete-btn" data-id="${id}">
                        <i class="fas fa-trash"></i>
                    </div>
                </div>
            </div>
            <div class="assign-details">
                <div class="assign-detail">
                    <div class="assign-label">Date:</div>
                    <div class="assign-value">${assignment.date}</div>
                </div>
                <div class="assign-detail">
                    <div class="assign-label">Shift:</div>
                    <div class="assign-value">
                        <span class="badge badge-${shiftColor}">
                            ${assignment.shift === 'morning' ? 'Morning (6AM-6PM)' : 'Night (6PM-6AM)'}
                        </span>
                    </div>
                </div>
                <div class="assign-detail">
                    <div class="assign-label">Location:</div>
                    <div class="assign-value">${assignment.location}</div>
                </div>
                <div class="assign-detail">
                    <div class="assign-label">Area:</div>
                    <div class="assign-value">${assignment.area}</div>
                </div>
            </div>
        `;
        
        // Add event listeners to action buttons
        assignCard.querySelector('.edit-btn').addEventListener('click', () => editAssignment(id, assignment));
        assignCard.querySelector('.delete-btn').addEventListener('click', () => deleteAssignment(id));
        
        assignContainer.appendChild(assignCard);
    }

    // Create a shift card with teams
    function createShiftCard(shiftType, shiftTitle, teams) {
        const shiftCard = document.createElement('div');
        shiftCard.className = 'shift-card';
        
        const shiftHeader = document.createElement('div');
        shiftHeader.className = 'shift-header';
        
        const shiftTitleEl = document.createElement('div');
        shiftTitleEl.className = 'shift-title';
        shiftTitleEl.textContent = shiftTitle;
        
        const shiftTimeEl = document.createElement('div');
        shiftTimeEl.className = 'shift-time';
        shiftTimeEl.textContent = `${teams.length} Teams`;
        
        shiftHeader.appendChild(shiftTitleEl);
        shiftHeader.appendChild(shiftTimeEl);
        shiftCard.appendChild(shiftHeader);
        
        const teamList = document.createElement('div');
        teamList.className = 'team-list';
        
        if (teams.length === 0) {
            const emptyMsg = document.createElement('p');
            emptyMsg.textContent = 'No teams scheduled for this shift';
            emptyMsg.style.textAlign = 'center';
            emptyMsg.style.padding = '20px 0';
            emptyMsg.style.color = '#888';
            teamList.appendChild(emptyMsg);
        } else {
            teams.forEach(team => {
                const teamItem = document.createElement('div');
                teamItem.className = 'team-item';
                
                const teamHeader = document.createElement('div');
                teamHeader.className = 'team-header';
                
                const teamNameEl = document.createElement('div');
                teamNameEl.className = 'team-name';
                teamNameEl.textContent = team.name;
                
                const teamActions = document.createElement('div');
                teamActions.className = 'member-actions';
                
                const editBtn = document.createElement('div');
                editBtn.className = 'action-btn edit-btn';
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.addEventListener('click', () => editTeam(team.id));
                
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'action-btn delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', () => deleteTeam(team.id));
                
                teamActions.appendChild(editBtn);
                teamActions.appendChild(deleteBtn);
                teamHeader.appendChild(teamNameEl);
                teamHeader.appendChild(teamActions);
                
                const memberList = document.createElement('div');
                memberList.className = 'member-list';
                
                // Add supervisor if exists
                if (team.supervisor && team.supervisor.id) {
                    const supervisorMember = document.createElement('div');
                    supervisorMember.className = 'member-item';
                    supervisorMember.innerHTML = `
                        <div class="member-role">Supervisor:</div>
                        <div class="member-name">${team.supervisor.name} <span class="supervisor-badge">Team Leader</span></div>
                    `;
                    memberList.appendChild(supervisorMember);
                }
                
                // Add all staff members (handle both single staff and staff array)
                if (team.staff) {
                    if (Array.isArray(team.staff)) {
                        team.staff.forEach(staff => {
                            const staffMember = document.createElement('div');
                            staffMember.className = 'member-item';
                            staffMember.innerHTML = `
                                <div class="member-role">Staff:</div>
                                <div class="member-name">${staff.name}</div>
                            `;
                            memberList.appendChild(staffMember);
                        });
                    } else {
                        const staffMember = document.createElement('div');
                        staffMember.className = 'member-item';
                        staffMember.innerHTML = `
                            <div class="member-role">Staff:</div>
                            <div class="member-name">${team.staff.name}</div>
                        `;
                        memberList.appendChild(staffMember);
                    }
                }
                
                // Add porters
                if (team.porters && team.porters.length > 0) {
                    team.porters.forEach(porter => {
                        const porterEl = document.createElement('div');
                        porterEl.className = 'member-item';
                        porterEl.innerHTML = `
                            <div class="member-role">Porter:</div>
                            <div class="member-name">${porter.name}</div>
                        `;
                        memberList.appendChild(porterEl);
                    });
                }
                
                // Add all forklift operators (handle both single operator and operators array)
                if (team.forkliftOperator) {
                    const forkliftEl = document.createElement('div');
                    forkliftEl.className = 'member-item';
                    forkliftEl.innerHTML = `
                        <div class="member-role">Forklift:</div>
                        <div class="member-name">${team.forkliftOperator.name}</div>
                    `;
                    memberList.appendChild(forkliftEl);
                }
                
                if (team.forkliftOperators && team.forkliftOperators.length > 0) {
                    team.forkliftOperators.forEach(forklift => {
                        const forkliftEl = document.createElement('div');
                        forkliftEl.className = 'member-item';
                        forkliftEl.innerHTML = `
                            <div class="member-role">Forklift:</div>
                            <div class="member-name">${forklift.name}</div>
                        `;
                        memberList.appendChild(forkliftEl);
                    });
                }
                
                teamItem.appendChild(teamHeader);
                teamItem.appendChild(memberList);
                teamList.appendChild(teamItem);
            });
        }
        
        shiftCard.appendChild(teamList);
        shiftsContainer.appendChild(shiftCard);
    }

    // Create team card for teams section
    function createTeamCard(teamId, team) {
        const teamCard = document.createElement('div');
        teamCard.className = 'shift-card fade-in';
        
        const shiftType = team.shift === 'morning' ? 'Morning Shift' : 'Night Shift';
        
        teamCard.innerHTML = `
            <div class="shift-header">
                <div class="shift-title">${team.name} - ${shiftType}</div>
                <div class="shift-time">${team.date}</div>
            </div>
            <div class="team-list">
                <div class="team-item">
                    <div class="team-header">
                        <div class="team-name">Team Members</div>
                        <div class="member-actions">
                            <div class="action-btn edit-btn" data-id="${teamId}">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-btn delete-btn" data-id="${teamId}">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </div>
                    <div class="member-list">
                        ${team.supervisor && team.supervisor.id ? `
                            <div class="member-item">
                                <div class="member-role">Supervisor:</div>
                                <div class="member-name">${team.supervisor.name} <span class="supervisor-badge">Team Leader</span></div>
                            </div>
                        ` : ''}
                        ${team.staff ? 
                            (Array.isArray(team.staff) ? 
                                team.staff.map(staff => `
                                    <div class="member-item">
                                        <div class="member-role">Staff:</div>
                                        <div class="member-name">${staff.name}</div>
                                    </div>
                                `).join('') : `
                                <div class="member-item">
                                    <div class="member-role">Staff:</div>
                                    <div class="member-name">${team.staff.name}</div>
                                </div>
                                `) : ''}
                        ${team.porters ? team.porters.map(porter => `
                            <div class="member-item">
                                <div class="member-role">Porter:</div>
                                <div class="member-name">${porter.name}</div>
                            </div>
                        `).join('') : ''}
                        ${team.forkliftOperator ? `
                            <div class="member-item">
                                <div class="member-role">Forklift:</div>
                                <div class="member-name">${team.forkliftOperator.name}</div>
                            </div>
                        ` : ''}
                        ${team.forkliftOperators ? team.forkliftOperators.map(forklift => `
                            <div class="member-item">
                                <div class="member-role">Forklift:</div>
                                <div class="member-name">${forklift.name}</div>
                            </div>
                        `).join('') : ''}
                    </div>
                </div>
                <div class="team-item">
                    <div class="team-header">
                        <div class="team-name">Location & Area</div>
                    </div>
                    <div class="member-list">
                        <div class="member-item">
                            <div class="member-role">Location:</div>
                            <div class="member-name">${team.location || 'Not specified'}</div>
                        </div>
                        <div class="member-item">
                            <div class="member-role">Area:</div>
                            <div class="member-name">${team.area || 'Not specified'}</div>
                        </div>
                        <div class="member-item">
                            <div class="member-role">Shift:</div>
                            <div class="member-name">${shiftType}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
            
        // Add event listeners to action buttons
        teamCard.querySelector('.edit-btn').addEventListener('click', () => editTeam(teamId));
        teamCard.querySelector('.delete-btn').addEventListener('click', () => deleteTeam(teamId));
        
        teamsContainer.appendChild(teamCard);
    }
  
    // Update employee form selects with current employers
    function updateEmployeeFormSelects() {
        const q = query(collection(db, 'employers'), orderBy('name'));
        
        getDocs(q).then((snapshot) => {
            employeeEmployerSelect.innerHTML = '';
            
            if (snapshot.empty) {
                employeeEmployerSelect.innerHTML = '<option value="">No employers found</option>';
                return;
            }
            
            snapshot.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = doc.data().name;
                employeeEmployerSelect.appendChild(option);
            });
        });
    }

    // Update team form selects with current employees
    async function updateTeamFormSelects() {
        const selectedDate = teamDateInput.value;
        const selectedShift = teamShiftSelect.value;
        
        // Get assignments for the selected date
        const assignmentsQuery = query(
            collection(db, 'assignments'),
            where('date', '==', selectedDate)
        );
        
        const assignmentsSnapshot = await getDocs(assignmentsQuery);
        const assignedEmployeeIds = [];
        
        assignmentsSnapshot.forEach(doc => {
            assignedEmployeeIds.push(doc.data().employeeId);
        });
        
        // Get teams for the selected date and shift to check for duplicates
        const teamsQuery = query(
            collection(db, 'teams'),
            where('date', '==', selectedDate)
        );
        
        const teamsSnapshot = await getDocs(teamsQuery);
        const assignedInTeams = [];
        
        teamsSnapshot.forEach(doc => {
            const team = doc.data();
            if (team.shift === selectedShift) {
                if (team.staff) {
                    if (Array.isArray(team.staff)) {
                        team.staff.forEach(staff => assignedInTeams.push(staff.id));
                    } else {
                        assignedInTeams.push(team.staff.id);
                    }
                }
                if (team.porters) {
                    team.porters.forEach(porter => assignedInTeams.push(porter.id));
                }
                if (team.forkliftOperator) {
                    assignedInTeams.push(team.forkliftOperator.id);
                }
                if (team.forkliftOperators) {
                    team.forkliftOperators.forEach(forklift => assignedInTeams.push(forklift.id));
                }
                if (team.supervisor && team.supervisor.id) {
                    assignedInTeams.push(team.supervisor.id);
                }
            }
        });
        
        // Now get employees
        const employeesQuery = query(collection(db, 'employees'));
        const employeesSnapshot = await getDocs(employeesQuery);
        
        // Clear existing options
        staffMemberSelect.innerHTML = '';
        portersSelect.innerHTML = '';
        forkliftOperatorSelect.innerHTML = '';
        teamSupervisorSelect.innerHTML = '<option value="">No Supervisor</option>';
        
        employeesSnapshot.forEach(doc => {
            const employee = doc.data();
            const employeeId = doc.id;
            
            if (!assignedEmployeeIds.includes(employeeId)) return;
            if (assignedInTeams.includes(employeeId)) return;
            
            if (employee.role === 'staff') {
                const option = document.createElement('option');
                option.value = employeeId;
                option.textContent = `${employee.firstName} ${employee.lastName}`;
                staffMemberSelect.appendChild(option);
            }
            
            // Add porters who are assigned for this date and not already in a team
            if (employee.role === 'porter') {
                const option = document.createElement('option');
                option.value = employeeId;
                option.textContent = `${employee.firstName} ${employee.lastName}`;
                portersSelect.appendChild(option);
            }
            
            // Add forklift operators who are assigned for this date and not already in a team
            if (employee.role === 'forklift') {
                const option = document.createElement('option');
                option.value = employeeId;
                option.textContent = `${employee.firstName} ${employee.lastName}`;
                forkliftOperatorSelect.appendChild(option);
            }
            
            // Add supervisors to supervisor select
            if (employee.role === 'supervisor') {
                const option = document.createElement('option');
                option.value = employeeId;
                option.textContent = `${employee.firstName} ${employee.lastName}`;
                teamSupervisorSelect.appendChild(option);
            }
        });
        
        // Show message if no assigned employees found
        if (staffMemberSelect.options.length === 0 && 
            portersSelect.options.length === 0 && 
            forkliftOperatorSelect.options.length === 0) {
            staffMemberSelect.innerHTML = '<option value="">No available staff members</option>';
            portersSelect.innerHTML = '<option value="">No available porters</option>';
            forkliftOperatorSelect.innerHTML = '<option value="">No available forklift operators</option>';
        }
    }

    // Update assign form selects with current employees
    function updateAssignFormSelects() {
        const q = query(collection(db, 'employees'), orderBy('firstName'));
        
        getDocs(q).then((snapshot) => {
            // Clear existing options
            assignEmployeeSelect.innerHTML = '';
            
            if (snapshot.empty) return;
            
            // Add all employees
            snapshot.forEach(doc => {
                const employee = doc.data();
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = `${employee.firstName} ${employee.lastName}`;
                option.setAttribute('data-role', employee.role);
                assignEmployeeSelect.appendChild(option);
            });
        });
    }

    // Update bulk assign form selects with current employees
    async function updateBulkAssignFormSelects() {
        const q = query(collection(db, 'employees'), orderBy('firstName'));
        
        const snapshot = await getDocs(q);
        
        // Clear existing options
        bulkEmployeesList.innerHTML = '';
        selectedEmployees = [];
        selectedEmployeesList.innerHTML = '';
        
        if (snapshot.empty) {
            bulkEmployeesList.innerHTML = '<div class="multi-select-option">No employees found</div>';
            return;
        }
        
        // Add all employees
        snapshot.forEach(doc => {
            const employee = doc.data();
            const employeeDiv = document.createElement('div');
            employeeDiv.className = 'multi-select-option';
            employeeDiv.innerHTML = `
                <input type="checkbox" id="emp-${doc.id}" data-id="${doc.id}" data-name="${employee.firstName} ${employee.lastName}">
                <label for="emp-${doc.id}">${employee.firstName} ${employee.lastName} (${employee.role})</label>
            `;
            
            // Add event listener to checkbox
            const checkbox = employeeDiv.querySelector('input');
            checkbox.addEventListener('change', (e) => {
                const employeeId = e.target.getAttribute('data-id');
                const employeeName = e.target.getAttribute('data-name');
                
                if (e.target.checked) {
                    selectedEmployees.push({ id: employeeId, name: employeeName });
                } else {
                    selectedEmployees = selectedEmployees.filter(emp => emp.id !== employeeId);
                }
                
                updateSelectedEmployeesList();
            });
            
            bulkEmployeesList.appendChild(employeeDiv);
        });
    }

    // Update the selected employees list in bulk assign modal
    function updateSelectedEmployeesList() {
        selectedEmployeesList.innerHTML = '';
        
        selectedEmployees.forEach(employee => {
            const employeeBadge = document.createElement('div');
            employeeBadge.className = 'selected-employee';
            employeeBadge.innerHTML = `
                ${employee.name}
                <span class="remove-employee" data-id="${employee.id}">&times;</span>
            `;
            
            // Add event listener to remove button
            employeeBadge.querySelector('.remove-employee').addEventListener('click', (e) => {
                const employeeId = e.target.getAttribute('data-id');
                selectedEmployees = selectedEmployees.filter(emp => emp.id !== employeeId);
                
                // Uncheck the checkbox
                const checkbox = document.querySelector(`#emp-${employeeId}`);
                if (checkbox) checkbox.checked = false;
                
                updateSelectedEmployeesList();
            });
            
            selectedEmployeesList.appendChild(employeeBadge);
        });
    }

    // Open the team modal
    function openTeamModal() {
        // Set the date to the selected shift date
        teamDateInput.value = shiftDateInput.value;
        teamModal.classList.add('active');
        
        // Update the select options based on assignments
        updateTeamFormSelects();
    }

    // Close the team modal
    function closeTeamModal() {
        teamModal.classList.remove('active');
    }

    // Open the auto generate modal
    function openAutoGenerateModal() {
        // Set the date to the selected shift date
        autoGenerateDateInput.value = shiftDateInput.value;
        autoGenerateModal.classList.add('active');
        
        // Clear previous incomplete members list
        incompleteMembersList.innerHTML = '';
    }

    // Close the auto generate modal
    function closeAutoGenerateModal() {
        autoGenerateModal.classList.remove('active');
    }

    // Open the employee modal
    function openEmployeeModal() {
        // Clear form
        employeeFirstNameInput.value = '';
        employeeLastNameInput.value = '';
        employeeIdInput.value = '';
        employeeEmailInput.value = '';
        employeeRoleSelect.value = 'staff';
        
        // Update employer select
        updateEmployeeFormSelects();
        
        employeeModal.classList.add('active');
    }

    // Close the employee modal
    function closeEmployeeModal() {
        employeeModal.classList.remove('active');
    }

    // Open the employer modal
    function openEmployerModal() {
        // Clear form
        employerNameInput.value = '';
        employerEmailInput.value = '';
        
        employerModal.classList.add('active');
    }

    // Close the employer modal
    function closeEmployerModal() {
        employerModal.classList.remove('active');
    }

    // Open the assign modal
    function openAssignModal() {
        // Set the date to the selected assign date
        assignEmployeeDateInput.value = assignDateInput.value;
        assignModal.classList.add('active');
        
        // Update the employee select options
        updateAssignFormSelects();
    }

    // Close the assign modal
    function closeAssignModal() {
        assignModal.classList.remove('active');
    }

    // Open the bulk assign modal
    function openBulkAssignModal() {
        // Set the date to the selected assign date
        bulkAssignDateInput.value = assignDateInput.value;
        bulkAssignModal.classList.add('active');
        
        // Update the select options with all employees
        updateBulkAssignFormSelects();
    }

    // Close the bulk assign modal
    function closeBulkAssignModal() {
        bulkAssignModal.classList.remove('active');
    }

    // Save employee to Firestore
    async function saveEmployee() {
        const firstName = employeeFirstNameInput.value.trim();
        const lastName = employeeLastNameInput.value.trim();
        const employeeId = employeeIdInput.value.trim();
        const employerId = employeeEmployerSelect.value;
        const role = employeeRoleSelect.value;
        const email = employeeEmailInput.value.trim();
        
        // Validate inputs
        if (!firstName || !lastName) {
            showNotification('Please enter both first and last name', 'error');
            return;
        }
        
        if (!employerId) {
            showNotification('Please select an employer', 'error');
            return;
        }
        
        // Get employer name
        const employerDoc = await getDoc(doc(db, 'employers', employerId));
        
        if (!employerDoc.exists()) {
            showNotification('Selected employer not found', 'error');
            return;
        }
        
        const employer = employerDoc.data();
        
        // Create employee object
        const employee = {
            firstName,
            lastName,
            id: employeeId || `${firstName.charAt(0)}${lastName.charAt(0)}${Date.now().toString().slice(-4)}`.toLowerCase(),
            employerId,
            employerName: employer.name,
            role,
            email: email || null,
            createdAt: new Date().toISOString()
        };
        
        // Save to Firestore
        try {
            await setDoc(doc(db, 'employees', employee.id), employee);
            showNotification('Employee added successfully!');
            closeEmployeeModal();
            loadEmployees();
        } catch (error) {
            console.error('Error saving employee:', error);
            showNotification('Error saving employee. Please try again.', 'error');
        }
    }

    // Save employer to Firestore
    async function saveEmployer() {
        const name = employerNameInput.value.trim();
        const email = employerEmailInput.value.trim();
        
        // Validate inputs
        if (!name) {
            showNotification('Please enter employer name', 'error');
            return;
        }
        
        // Create employer object
        const employer = {
            name,
            email,
            createdAt: new Date().toISOString()
        };
        
        // Save to Firestore
        try {
            const newEmployerRef = await addDoc(collection(db, 'employers'), employer);
            showNotification('Employer added successfully!');
            closeEmployerModal();
            loadEmployers();
        } catch (error) {
            console.error('Error saving employer:', error);
            showNotification('Error saving employer. Please try again.', 'error');
        }
    }

    // Confirm auto generation of teams
    async function confirmAutoGenerate() {
        const selectedDate = autoGenerateDateInput.value;
        const selectedShift = autoGenerateShiftSelect.value;
        const groupByLocation = document.getElementById('generate-location').checked;
        const groupByArea = document.getElementById('generate-area').checked;
        
        // Clear previous incomplete members list
        incompleteMembersList.innerHTML = '';
        
        try {
            // Get assignments for the selected date and shift
            const assignmentsQuery = query(
                collection(db, 'assignments'),
                where('date', '==', selectedDate),
                where('shift', '==', selectedShift)
            );
            
            const assignmentsSnapshot = await getDocs(assignmentsQuery);
            const assignedEmployees = [];
            
            assignmentsSnapshot.forEach(doc => {
                const assignment = doc.data();
                assignedEmployees.push({
                    id: assignment.employeeId,
                    name: assignment.employeeName,
                    role: assignment.employeeRole,
                    location: assignment.location,
                    area: assignment.area
                });
            });
            
            if (assignedEmployees.length === 0) {
                showNotification('No employees assigned for this date and shift. Please assign employees first.', 'error');
                return;
            }
            
            // Get all teams for this date and shift to check for duplicates
            const teamsQuery = query(
                collection(db, 'teams'),
                where('date', '==', selectedDate),
                where('shift', '==', selectedShift)
            );
            
            const teamsSnapshot = await getDocs(teamsQuery);
            const assignedInTeams = [];
            
            teamsSnapshot.forEach(doc => {
                const team = doc.data();
                if (team.staff) {
                    if (Array.isArray(team.staff)) {
                        team.staff.forEach(staff => assignedInTeams.push(staff.id));
                    } else {
                        assignedInTeams.push(team.staff.id);
                    }
                }
                if (team.porters) {
                    team.porters.forEach(porter => assignedInTeams.push(porter.id));
                }
                if (team.forkliftOperator) {
                    assignedInTeams.push(team.forkliftOperator.id);
                }
                if (team.forkliftOperators) {
                    team.forkliftOperators.forEach(forklift => assignedInTeams.push(forklift.id));
                }
                if (team.supervisor && team.supervisor.id) {
                    assignedInTeams.push(team.supervisor.id);
                }
            });
            
            // Filter out employees already in teams
            const availableEmployees = assignedEmployees.filter(emp => !assignedInTeams.includes(emp.id));
            
            // Get employee details
            const employeesSnapshot = await getDocs(collection(db, 'employees'));
            const employeesData = {};
            employeesSnapshot.forEach(doc => {
                employeesData[doc.id] = doc.data();
            });
            
            // Categorize available employees by role
            const staffMembers = availableEmployees
                .filter(emp => emp.role === 'staff')
                .map(emp => ({ ...emp, ...employeesData[emp.id] }));
            
            const porters = availableEmployees
                .filter(emp => emp.role === 'porter')
                .map(emp => ({ ...emp, ...employeesData[emp.id] }));
            
            const forkliftOperators = availableEmployees
                .filter(emp => emp.role === 'forklift')
                .map(emp => ({ ...emp, ...employeesData[emp.id] }));
            
            const supervisors = availableEmployees
                .filter(emp => emp.role === 'supervisor')
                .map(emp => ({ ...emp, ...employeesData[emp.id] }));
            
            // Get team requirements based on rules
            let groupedStaff, groupedPorters, groupedForklifts, groupedSupervisors;
            
            if (groupByLocation) {
                // Group employees by location and optionally by area
                groupedStaff = groupByArea ? groupEmployees(staffMembers, 'location', 'area') : groupEmployees(staffMembers, 'location');
                groupedPorters = groupByArea ? groupEmployees(porters, 'location', 'area') : groupEmployees(porters, 'location');
                groupedForklifts = groupByArea ? groupEmployees(forkliftOperators, 'location', 'area') : groupEmployees(forkliftOperators, 'location');
                groupedSupervisors = groupByArea ? groupEmployees(supervisors, 'location', 'area') : groupEmployees(supervisors, 'location');
            } else {
                // No grouping - treat all as one group
                groupedStaff = { 'All|All': staffMembers };
                groupedPorters = { 'All|All': porters };
                groupedForklifts = { 'All|All': forkliftOperators };
                groupedSupervisors = { 'All|All': supervisors };
            }
            
            // Create teams for each group
            const newTeams = [];
            const incompleteMembers = [];
            
            // Process each location/area group
            for (const [groupKey, groupStaff] of Object.entries(groupedStaff)) {
                const [location, area] = groupKey.split('|');
                
                // Get porters and forklifts for this group
                const groupPorters = groupedPorters[groupKey] || [];
                const groupForklifts = groupedForklifts[groupKey] || [];
                const groupSupervisors = groupedSupervisors[groupKey] || [];
                
                // Get team requirements for this group
                const requirements = await getTeamRequirements(selectedDate, location, area, selectedShift);
                
                if (!requirements) {
                    // No rule for this specific location/area combination
                    incompleteMembers.push(...groupStaff, ...groupPorters, ...groupForklifts, ...groupSupervisors);
                    continue;
                }
                
                // Calculate how many teams we can form from this group
                const maxTeams = Math.min(
                    Math.floor(groupStaff.length / requirements.staff),
                    Math.floor(groupPorters.length / requirements.porters),
                    Math.floor(groupForklifts.length / requirements.forklifts)
                );
                
                if (maxTeams > 0) {
                    // Create teams
                    for (let i = 0; i < maxTeams; i++) {
                        // Get all staff members for this team
                        const staffForTeam = groupStaff.slice(
                            i * requirements.staff, 
                            (i + 1) * requirements.staff
                        );
                        
                        // Get all porters for this team
                        const portersForTeam = groupPorters.slice(
                            i * requirements.porters, 
                            (i + 1) * requirements.porters
                        );
                        
                        // Get all forklift operators for this team
                        const forkliftsForTeam = groupForklifts.slice(
                            i * requirements.forklifts, 
                            (i + 1) * requirements.forklifts
                        );
                        
                        // Get supervisor if available
                        const supervisor = groupSupervisors.length > 0 ? groupSupervisors[0] : null;
                        
                        // Use the first staff member's name for the team name
                        const teamName = `${staffForTeam[0].firstName}'s Team`;
                        
                        const team = {
                            shift: selectedShift,
                            date: selectedDate,
                            name: teamName,
                            location: location !== 'All' ? location : null,
                            area: area && area !== 'All' ? area : null,
                            staff: staffForTeam.map(staff => ({
                                id: staff.id,
                                name: `${staff.firstName} ${staff.lastName}`
                            })),
                            porters: portersForTeam.map(porter => ({
                                id: porter.id,
                                name: `${porter.firstName} ${porter.lastName}`
                            })),
                            forkliftOperators: forkliftsForTeam.map(forklift => ({
                                id: forklift.id,
                                name: `${forklift.firstName} ${forklift.lastName}`
                            })),
                            supervisor: supervisor ? {
                                id: supervisor.id,
                                name: `${supervisor.firstName} ${supervisor.lastName}`
                            } : null,
                            createdAt: new Date().toISOString()
                        };
                        
                        newTeams.push(team);
                    }
                }
                
                // Track incomplete members for this group
                const remainingStaff = groupStaff.slice(maxTeams * requirements.staff);
                const remainingPorters = groupPorters.slice(maxTeams * requirements.porters);
                const remainingForklifts = groupForklifts.slice(maxTeams * requirements.forklifts);
                const remainingSupervisors = groupSupervisors.slice(1); // We used the first supervisor
                
                incompleteMembers.push(
                    ...remainingStaff,
                    ...remainingPorters,
                    ...remainingForklifts,
                    ...remainingSupervisors
                );
            }
            
            // Save new teams to Firestore
            if (newTeams.length > 0) {
                const batch = [];
                const teamsCollection = collection(db, 'teams');
                
                newTeams.forEach(team => {
                    batch.push(addDoc(teamsCollection, team));
                });
                
                await Promise.all(batch);
                
                // Send notification emails and push notifications to team members
                const notificationPromises = newTeams.map(team => {
                    return Promise.all([
                        sendTeamNotificationEmails(team),
                        sendPushNotificationToAll('New Team Assignment', `Teams have been created for ${team.date} (${team.shift} shift)`)
                    ]);
                });
                
                await Promise.all(notificationPromises);
                
                // Show success message
                showNotification(`Successfully created ${newTeams.length} teams for ${selectedDate} (${selectedShift} shift)`);
                
                // Reload shifts
                loadShiftsForDate();
                
                // Show incomplete members if any
                if (incompleteMembers.length > 0) {
                    showIncompleteMembers(
                        incompleteMembers.filter(m => m.role === 'staff'),
                        incompleteMembers.filter(m => m.role === 'porter'),
                        incompleteMembers.filter(m => m.role === 'forklift'),
                        incompleteMembers.filter(m => m.role === 'supervisor')
                    );
                } else {
                    closeAutoGenerateModal();
                }
            } else {
                showNotification('No complete teams could be formed with the current assignments.', 'error');
                showIncompleteMembers(staffMembers, porters, forkliftOperators, supervisors);
            }
        } catch (error) {
            console.error('Error generating teams:', error);
            showNotification('An error occurred while generating teams. Please try again.', 'error');
        }
    }

    // Group employees by location and optionally by area
    function groupEmployees(employees, primaryGroup, secondaryGroup = null) {
        const groups = {};
        
        employees.forEach(employee => {
            const primaryValue = employee[primaryGroup] || 'All';
            const secondaryValue = secondaryGroup ? (employee[secondaryGroup] || 'All') : null;
            
            const groupKey = secondaryValue ? `${primaryValue}|${secondaryValue}` : primaryValue;
            
            if (!groups[groupKey]) {
                groups[groupKey] = [];
            }
            
            groups[groupKey].push(employee);
        });
        
        return groups;
    }

    // Show incomplete team members in the modal
    function showIncompleteMembers(staffMembers, porters, forkliftOperators, supervisors = []) {
        incompleteMembersList.innerHTML = '';
        
        if (staffMembers.length > 0) {
            const staffHeader = document.createElement('div');
            staffHeader.className = 'incomplete-item';
            staffHeader.innerHTML = '<strong>Staff Members Without Team:</strong>';
            incompleteMembersList.appendChild(staffHeader);
            
            staffMembers.forEach(staff => {
                const item = document.createElement('div');
                item.className = 'incomplete-item';
                item.textContent = staff.name;
                incompleteMembersList.appendChild(item);
            });
        }
        
        if (porters.length > 0) {
            const portersHeader = document.createElement('div');
            portersHeader.className = 'incomplete-item';
            portersHeader.innerHTML = '<strong>Porters Without Team:</strong>';
            incompleteMembersList.appendChild(portersHeader);
            
            porters.forEach(porter => {
                const item = document.createElement('div');
                item.className = 'incomplete-item';
                item.textContent = porter.name;
                incompleteMembersList.appendChild(item);
            });
        }
        
        if (forkliftOperators.length > 0) {
            const forkliftHeader = document.createElement('div');
            forkliftHeader.className = 'incomplete-item';
            forkliftHeader.innerHTML = '<strong>Forklift Operators Without Team:</strong>';
            incompleteMembersList.appendChild(forkliftHeader);
            
            forkliftOperators.forEach(forklift => {
                const item = document.createElement('div');
                item.className = 'incomplete-item';
                item.textContent = forklift.name;
                incompleteMembersList.appendChild(item);
            });
        }
        
        if (supervisors.length > 0) {
            const supervisorHeader = document.createElement('div');
            supervisorHeader.className = 'incomplete-item';
            supervisorHeader.innerHTML = '<strong>Supervisors Without Team:</strong>';
            incompleteMembersList.appendChild(supervisorHeader);
            
            supervisors.forEach(supervisor => {
                const item = document.createElement('div');
                item.className = 'incomplete-item';
                item.textContent = supervisor.name;
                incompleteMembersList.appendChild(item);
            });
        }
        
        if (incompleteMembersList.children.length === 0) {
            incompleteMembersList.innerHTML = '<div class="incomplete-item">All assigned employees have been placed in teams.</div>';
        }
    }

    // Save team to Firestore
    async function saveTeam() {
        const shiftDate = teamDateInput.value;
        const shiftType = teamShiftSelect.value;
        const location = teamLocationSelect.value;
        const area = teamAreaSelect.value;
        const supervisorId = teamSupervisorSelect.value;
        const staffId = staffMemberSelect.value;
        const porterIds = Array.from(portersSelect.selectedOptions).map(opt => opt.value);
        const forkliftId = forkliftOperatorSelect.value;
        
        // Validate inputs
        if (!shiftDate || !staffId || !porterIds.length || !forkliftId) {
            showNotification('Please select a date, staff member, porters, and forklift operator', 'error');
            return;
        }
        
        // Get team requirements for this location/area/shift
        const requirements = await getTeamRequirements(shiftDate, location, area, shiftType);
        
        if (!requirements) {
            showNotification('No team rules found for this location, area and shift. Please add team rules first.', 'error');
            return;
        }
        
        // Validate porter count
        if (porterIds.length < requirements.porters) {
            showNotification(`This location requires ${requirements.porters} porters per team`, 'error');
            return;
        }
        
        // Check if a team with this location/area/shift already exists
        const teamsQuery = query(
            collection(db, 'teams'),
            where('date', '==', shiftDate),
            where('shift', '==', shiftType),
            where('location', '==', location),
            where('area', '==', area)
        );
        
        const teamsSnapshot = await getDocs(teamsQuery);
        
        if (!teamsSnapshot.empty) {
            showNotification('A team with this location, area, and shift already exists for this date.', 'error');
            return;
        }
        
        // Get employee data
        const employeesSnapshot = await getDocs(collection(db, 'employees'));
        const employeesData = {};
        employeesSnapshot.forEach(doc => {
            employeesData[doc.id] = doc.data();
        });
        
        // Get selected employees
        const staffMember = employeesData[staffId];
        const porters = porterIds.map(id => employeesData[id]);
        const forkliftOperator = employeesData[forkliftId];
        const supervisor = supervisorId ? employeesData[supervisorId] : null;
        
        if (!staffMember || !porters.every(p => p) || !forkliftOperator) {
            showNotification('One or more selected employees not found', 'error');
            return;
        }
        
        // Create team name from staff member's first name
        const teamName = `${staffMember.firstName}'s Team`;
        
        // Create team object
        const team = {
            shift: shiftType,
            date: shiftDate,
            name: teamName,
            location: location,
            area: area,
            staff: {
                id: staffMember.id,
                name: `${staffMember.firstName} ${staffMember.lastName}`
            },
            porters: porters.map(porter => ({
                id: porter.id,
                name: `${porter.firstName} ${porter.lastName}`
            })),
            forkliftOperator: {
                id: forkliftOperator.id,
                name: `${forkliftOperator.firstName} ${forkliftOperator.lastName}`
            },
            supervisor: supervisor ? {
                id: supervisor.id,
                name: `${supervisor.firstName} ${supervisor.lastName}`
            } : null,
            createdAt: new Date().toISOString()
        };
        
        // Save to Firestore
        try {
            await addDoc(collection(db, 'teams'), team);
            
            // Send notification emails and push notifications to team members
            await Promise.all([
                sendTeamNotificationEmails(team),
                sendPushNotificationToAll('New Team Assignment', `You've been assigned to ${teamName} for ${shiftDate}`)
            ]);
            
            showNotification('Team created successfully!');
            closeTeamModal();
            loadShiftsForDate();
        } catch (error) {
            console.error('Error saving team:', error);
            showNotification('Error saving team. Please try again.', 'error');
        }
    }

    // Save assignment to Firestore
    async function saveAssignment() {
        const date = assignEmployeeDateInput.value;
        const shift = assignEmployeeShiftSelect.value;
        const location = assignEmployeeLocationSelect.value;
        const area = assignEmployeeAreaSelect.value;
        const employeeId = assignEmployeeSelect.value;
        
        // Validate inputs
        if (!date || !employeeId) {
            showNotification('Please select a date and employee', 'error');
            return;
        }
        
        // Check if employee is already assigned for this date
        const existingAssignmentQuery = query(
            collection(db, 'assignments'),
            where('date', '==', date),
            where('employeeId', '==', employeeId)
        );
        
        const existingAssignmentSnapshot = await getDocs(existingAssignmentQuery);
        
        if (!existingAssignmentSnapshot.empty) {
            showNotification('This employee is already assigned for this date', 'error');
            return;
        }
        
        // Get employee data
        const employeeDoc = await getDoc(doc(db, 'employees', employeeId));
        
        if (!employeeDoc.exists()) {
            showNotification('Selected employee not found', 'error');
            return;
        }
        
        const employee = employeeDoc.data();
        
        // Create assignment object
        const assignment = {
            date,
            shift,
            location,
            area,
            employeeId,
            employeeName: `${employee.firstName} ${employee.lastName}`,
            employeeRole: employee.role,
            createdAt: new Date().toISOString()
        };
        
        // Save to Firestore
        try {
            await addDoc(collection(db, 'assignments'), assignment);
            
            // Send push notification to the employee
            await sendPushNotification([employeeId], 'New Shift Assignment', 
                `You've been assigned to ${shift} shift on ${date} at ${location}`);
            
            showNotification('Assignment created successfully!');
            closeAssignModal();
            loadAssignments();
        } catch (error) {
            console.error('Error saving assignment:', error);
            showNotification('Error saving assignment. Please try again.', 'error');
        }
    }

    // Save bulk assignments to Firestore
    async function saveBulkAssignment() {
        const date = bulkAssignDateInput.value;
        const shift = bulkAssignShiftSelect.value;
        const location = bulkAssignLocationSelect.value;
        const area = bulkAssignAreaSelect.value;
        
        // Validate inputs
        if (!date || selectedEmployees.length === 0) {
            showNotification('Please select a date and at least one employee', 'error');
            return;
        }
        
        // Check if any employees are already assigned for this date
        const existingAssignmentsQuery = query(
            collection(db, 'assignments'),
            where('date', '==', date),
            where('employeeId', 'in', selectedEmployees.map(e => e.id))
        );
        
        const existingAssignmentsSnapshot = await getDocs(existingAssignmentsQuery);
        const alreadyAssigned = [];
        
        existingAssignmentsSnapshot.forEach(doc => {
            const assignment = doc.data();
            alreadyAssigned.push(assignment.employeeId);
        });
        
        if (alreadyAssigned.length > 0) {
            // Get employee names for the notification
            const employeesSnapshot = await getDocs(collection(db, 'employees'));
            const employeesData = {};
            employeesSnapshot.forEach(doc => {
                employeesData[doc.id] = doc.data();
            });
            
            const assignedNames = alreadyAssigned.map(id => {
                const emp = employeesData[id];
                return emp ? `${emp.firstName} ${emp.lastName}` : id;
            });
            
            showNotification(`These employees are already assigned for this date: ${assignedNames.join(', ')}`, 'error');
            return;
        }
        
        // Get employee data
        const employeesSnapshot = await getDocs(collection(db, 'employees'));
        const employeesData = {};
        employeesSnapshot.forEach(doc => {
            employeesData[doc.id] = doc.data();
        });
        
        if (Object.keys(employeesData).length === 0) {
            showNotification('No employees found', 'error');
            return;
        }
        
        // Create assignments for each selected employee
        const batch = [];
        
        selectedEmployees.forEach(employee => {
            const employeeData = employeesData[employee.id];
            
            if (!employeeData) return;
            
            const assignment = {
                date,
                shift,
                location,
                area,
                employeeId: employee.id,
                employeeName: `${employeeData.firstName} ${employeeData.lastName}`,
                employeeRole: employeeData.role,
                createdAt: new Date().toISOString()
            };
            
            batch.push(addDoc(collection(db, 'assignments'), assignment));
        });
        
        try {
            await Promise.all(batch);
            
            // Send push notifications to all assigned employees
            const notificationPromises = selectedEmployees.map(employee => {
                return sendPushNotification([employee.id], 'New Shift Assignment', 
                    `You've been assigned to ${shift} shift on ${date} at ${location}`);
            });
            
            await Promise.all(notificationPromises);
            
            showNotification(`${selectedEmployees.length} assignments created successfully!`);
            closeBulkAssignModal();
            loadAssignments();
        } catch (error) {
            console.error('Error saving bulk assignments:', error);
            showNotification('Error saving assignments. Please try again.', 'error');
        }
    }

    // Edit team
    async function editTeam(teamId) {
        const teamDoc = await getDoc(doc(db, 'teams', teamId));
        
        if (!teamDoc.exists()) {
            showNotification('Team not found', 'error');
            return;
        }
        
        const team = teamDoc.data();
        
        // Open team modal with existing data
        openTeamModal();
        teamDateInput.value = team.date;
        teamShiftSelect.value = team.shift;
        teamLocationSelect.value = team.location || '';
        teamAreaSelect.value = team.area || '';
        
        // Change save button to update
        saveTeamBtn.textContent = 'Update Team';
        saveTeamBtn.onclick = async function() {
            // First delete the old team
            try {
                await deleteDoc(doc(db, 'teams', teamId));
                
                // Then create a new team with updated values
                const updatedTeam = {
                    shift: teamShiftSelect.value,
                    date: teamDateInput.value,
                    name: team.name, // Keep the same name
                    location: teamLocationSelect.value,
                    area: teamAreaSelect.value,
                    staff: team.staff, // Keep same staff for now
                    porters: team.porters, // Keep same porters for now
                    forkliftOperator: team.forkliftOperator, // Keep same forklift operator for now
                    supervisor: team.supervisor, // Keep same supervisor for now
                    createdAt: new Date().toISOString()
                };
                
                await addDoc(collection(db, 'teams'), updatedTeam);
                
                // Send push notification about team update
                await sendPushNotificationToAll('Team Updated', 
                    `Team ${updatedTeam.name} has been updated for ${updatedTeam.date}`);
                
                showNotification('Team updated successfully!');
                closeTeamModal();
                loadShiftsForDate();
            } catch (error) {
                console.error('Error updating team:', error);
                showNotification('Error updating team. Please try again.', 'error');
            }
        };
    }

    // Delete team
    async function deleteTeam(teamId) {
        if (confirm('Are you sure you want to delete this team?')) {
            try {
                await deleteDoc(doc(db, 'teams', teamId));
                
                // Send push notification about team deletion
                await sendPushNotificationToAll('Team Deleted', 'A team assignment has been removed');
                
                showNotification('Team deleted successfully!');
                loadShiftsForDate();
            } catch (error) {
                console.error('Error deleting team:', error);
                showNotification('Error deleting team. Please try again.', 'error');
            }
        }
    }

    // Edit assignment
    async function editAssignment(assignmentId, assignment) {
        // Open assign modal with existing data
        openAssignModal();
        assignEmployeeDateInput.value = assignment.date;
        assignEmployeeShiftSelect.value = assignment.shift;
        assignEmployeeLocationSelect.value = assignment.location || '';
        assignEmployeeAreaSelect.value = assignment.area || '';
        
        // Set the employee select to the assigned employee
        const employeeDoc = await getDoc(doc(db, 'employees', assignment.employeeId));
        if (employeeDoc.exists()) {
            const employee = employeeDoc.data();
            assignEmployeeSelect.value = assignment.employeeId;
            
            // If the employee is not in the select options, add it
            if (!Array.from(assignEmployeeSelect.options).some(opt => opt.value === assignment.employeeId)) {
                const option = document.createElement('option');
                option.value = assignment.employeeId;
                option.textContent = `${employee.firstName} ${employee.lastName}`;
                assignEmployeeSelect.appendChild(option);
            }
        }
        
        // Change save button to update
        saveAssignmentBtn.textContent = 'Update Assignment';
        saveAssignmentBtn.onclick = async function() {
            // First delete the old assignment
            try {
                await deleteDoc(doc(db, 'assignments', assignmentId));
                
                // Then create a new assignment with updated values
                const updatedAssignment = {
                    date: assignEmployeeDateInput.value,
                    shift: assignEmployeeShiftSelect.value,
                    location: assignEmployeeLocationSelect.value,
                    area: assignEmployeeAreaSelect.value,
                    employeeId: assignEmployeeSelect.value,
                    employeeName: assignment.employeeName, // Will be updated below
                    employeeRole: assignment.employeeRole, // Will be updated below
                    createdAt: new Date().toISOString()
                };
                
                // Get the updated employee details
                const employeeDoc = await getDoc(doc(db, 'employees', updatedAssignment.employeeId));
                if (employeeDoc.exists()) {
                    const employee = employeeDoc.data();
                    updatedAssignment.employeeName = `${employee.firstName} ${employee.lastName}`;
                    updatedAssignment.employeeRole = employee.role;
                }
                
                await addDoc(collection(db, 'assignments'), updatedAssignment);
                
                // Send push notification about assignment update
                await sendPushNotification([updatedAssignment.employeeId], 'Assignment Updated', 
                    `Your shift assignment has been updated for ${updatedAssignment.date}`);
                
                showNotification('Assignment updated successfully!');
                closeAssignModal();
                loadAssignments();
            } catch (error) {
                console.error('Error updating assignment:', error);
                showNotification('Error updating assignment. Please try again.', 'error');
            }
        };
    }

    // Delete assignment
    async function deleteAssignment(assignmentId) {
        if (confirm('Are you sure you want to delete this assignment?')) {
            try {
                const assignmentDoc = await getDoc(doc(db, 'assignments', assignmentId));
                const assignment = assignmentDoc.data();
                
                await deleteDoc(doc(db, 'assignments', assignmentId));
                
                // Send push notification about assignment removal
                await sendPushNotification([assignment.employeeId], 'Assignment Removed', 
                    `Your shift assignment for ${assignment.date} has been removed`);
                
                showNotification('Assignment deleted successfully!');
                loadAssignments();
            } catch (error) {
                console.error('Error deleting assignment:', error);
                showNotification('Error deleting assignment. Please try again.', 'error');
            }
        }
    }

    // Edit employee
    async function editEmployee(employeeId, employee) {
        // Open employee modal with existing data
        openEmployeeModal();
        employeeFirstNameInput.value = employee.firstName;
        employeeLastNameInput.value = employee.lastName;
        employeeIdInput.value = employee.id || '';
        employeeEmailInput.value = employee.email || '';
        employeeRoleSelect.value = employee.role;
        
        // Set the employer select to the current employer
        const employersSnapshot = await getDocs(collection(db, 'employers'));
        employeeEmployerSelect.innerHTML = '';
        
        employersSnapshot.forEach(doc => {
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = doc.data().name;
            if (doc.id === employee.employerId) {
                option.selected = true;
            }
            employeeEmployerSelect.appendChild(option);
        });
        
        // Change save button to update
        saveEmployeeBtn.textContent = 'Update Employee';
        saveEmployeeBtn.onclick = async function() {
            // First delete the old employee
            try {
                await deleteDoc(doc(db, 'employees', employeeId));
                
                // Then create a new employee with updated values
                const firstName = employeeFirstNameInput.value.trim();
                const lastName = employeeLastNameInput.value.trim();
                const newEmployeeId = employeeIdInput.value.trim();
                const employerId = employeeEmployerSelect.value;
                const role = employeeRoleSelect.value;
                const email = employeeEmailInput.value.trim();
                
                // Validate inputs
                if (!firstName || !lastName) {
                    showNotification('Please enter both first and last name', 'error');
                    return;
                }
                
                if (!employerId) {
                    showNotification('Please select an employer', 'error');
                    return;
                }
                
                // Get employer name
                const employerDoc = await getDoc(doc(db, 'employers', employerId));
                
                if (!employerDoc.exists()) {
                    showNotification('Selected employer not found', 'error');
                    return;
                }
                
                const employer = employerDoc.data();
                
                // Create employee object
                const updatedEmployee = {
                    firstName,
                    lastName,
                    id: newEmployeeId || employee.id,
                    employerId,
                    employerName: employer.name,
                    role,
                    email: email || null,
                    createdAt: new Date().toISOString()
                };
                
                await setDoc(doc(db, 'employees', updatedEmployee.id), updatedEmployee);
                
                // Send push notification about profile update
                await sendPushNotification([updatedEmployee.id], 'Profile Updated', 
                    'Your employee profile has been updated');
                
                showNotification('Employee updated successfully!');
                closeEmployeeModal();
                loadEmployees();
            } catch (error) {
                console.error('Error updating employee:', error);
                showNotification('Error updating employee. Please try again.', 'error');
            }
        };
    }

    // Delete employee
    async function deleteEmployee(employeeId) {
        if (confirm('Are you sure you want to delete this employee?')) {
            try {
                await deleteDoc(doc(db, 'employees', employeeId));
                
                // Send push notification about account deletion
                await sendPushNotification([employeeId], 'Account Removed', 
                    'Your employee account has been removed from the system');
                
                showNotification('Employee deleted successfully!');
                loadEmployees();
            } catch (error) {
                console.error('Error deleting employee:', error);
                showNotification('Error deleting employee. Please try again.', 'error');
            }
        }
    }

    // Edit employer
    async function editEmployer(employerId, employer) {
        // Open employer modal with existing data
        openEmployerModal();
        employerNameInput.value = employer.name;
        employerEmailInput.value = employer.email || '';
        
        // Change save button to update
        saveEmployerBtn.textContent = 'Update Employer';
        saveEmployerBtn.onclick = async function() {
            // First delete the old employer
            try {
                await deleteDoc(doc(db, 'employers', employerId));
                
                // Then create a new employer with updated values
                const name = employerNameInput.value.trim();
                const email = employerEmailInput.value.trim();
                
                // Validate inputs
                if (!name) {
                    showNotification('Please enter employer name', 'error');
                    return;
                }
                
                // Create employer object
                const updatedEmployer = {
                    name,
                    email,
                    createdAt: new Date().toISOString()
                };
                
                await addDoc(collection(db, 'employers'), updatedEmployer);
                
                // Send push notification to all employees of this employer
                const employeesQuery = query(
                    collection(db, 'employees'),
                    where('employerId', '==', employerId)
                );
                
                const employeesSnapshot = await getDocs(employeesQuery);
                const employeeIds = employeesSnapshot.docs.map(doc => doc.id);
                
                if (employeeIds.length > 0) {
                    await sendPushNotification(employeeIds, 'Employer Updated', 
                        `Your employer information has been updated to ${updatedEmployer.name}`);
                }
                
                showNotification('Employer updated successfully!');
                closeEmployerModal();
                loadEmployers();
            } catch (error) {
                console.error('Error updating employer:', error);
                showNotification('Error updating employer. Please try again.', 'error');
            }
        };
    }

    // Delete employer
    async function deleteEmployer(employerId) {
        if (confirm('Are you sure you want to delete this employer?')) {
            try {
                await deleteDoc(doc(db, 'employers', employerId));
                
                // Send push notification to all employees of this employer
                const employeesQuery = query(
                    collection(db, 'employees'),
                    where('employerId', '==', employerId)
                );
                
                const employeesSnapshot = await getDocs(employeesQuery);
                const employeeIds = employeesSnapshot.docs.map(doc => doc.id);
                
                if (employeeIds.length > 0) {
                    await sendPushNotification(employeeIds, 'Employer Removed', 
                        'Your employer has been removed from the system');
                }
                
                showNotification('Employer deleted successfully!');
                loadEmployers();
            } catch (error) {
                console.error('Error deleting employer:', error);
                showNotification('Error deleting employer. Please try again.', 'error');
            }
        }
    }

    // Update dashboard counts
    function updateDashboardCounts() {
        // Count employees
        onSnapshot(collection(db, 'employees'), (snapshot) => {
            totalEmployeesEl.textContent = snapshot.size;
        });
        
        // Count teams for today
        const today = new Date().toISOString().split('T')[0];
        const todayTeamsQuery = query(collection(db, 'teams'), where('date', '==', today));
        
        onSnapshot(todayTeamsQuery, (snapshot) => {
            let morningTeams = 0;
            let nightTeams = 0;
            
            snapshot.forEach(doc => {
                const team = doc.data();
                if (team.shift === 'morning') {
                    morningTeams++;
                } else {
                    nightTeams++;
                }
            });
            
            // Update UI
            totalTeamsEl.textContent = snapshot.size;
            morningCountEl.textContent = morningTeams;
            nightCountEl.textContent = nightTeams;
        });
    }

    // Announcement elements
    const announcementFab = document.getElementById('announcement-fab');
    const announcementModal = document.getElementById('announcement-modal');
    const closeAnnouncementModalBtn = document.getElementById('close-announcement-modal');
    const cancelAnnouncementModalBtn = document.getElementById('cancel-announcement-modal');
    const sendAnnouncementBtn = document.getElementById('send-announcement');
    const announcementRecipientsList = document.getElementById('announcement-recipients');
    const announcementSelectedRecipients = document.getElementById('announcement-selected-recipients');
    const announcementSubject = document.getElementById('announcement-subject');
    const announcementEditor = document.getElementById('announcement-editor');
    const announcementFilterRole = document.getElementById('announcement-filter-role');
    const announcementFilterEmployer = document.getElementById('announcement-filter-employer');
    const announcementAttachment = document.getElementById('announcement-attachment');
    const selectAllEmployees = document.getElementById('select-all-employees');

    let announcementSelectedEmployees = [];
    let currentFilteredEmployees = [];

    // Open announcement modal
    function openAnnouncementModal() {
        announcementModal.classList.add('active');
        loadAnnouncementRecipients();
        loadEmployersForFilter();
    }

    // Close announcement modal
    function closeAnnouncementModal() {
        announcementModal.classList.remove('active');
        announcementSelectedEmployees = [];
        announcementSelectedRecipients.innerHTML = '';
        announcementSubject.value = '';
        announcementEditor.innerHTML = '';
        announcementAttachment.value = '';
        selectAllEmployees.checked = false;
    }

    // Load employers for filter dropdown
    function loadEmployersForFilter() {
        const q = query(collection(db, 'employers'), orderBy('name'));
        
        getDocs(q).then((snapshot) => {
            announcementFilterEmployer.innerHTML = '<option value="all">All Employers</option>';
            
            if (snapshot.empty) return;
            
            snapshot.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = doc.data().name;
                announcementFilterEmployer.appendChild(option);
            });
        });
    }

    // Load employees for announcement recipients with filtering
    async function loadAnnouncementRecipients() {
        const roleFilter = announcementFilterRole.value;
        const employerFilter = announcementFilterEmployer.value;
        
        let q = query(collection(db, 'employees'), orderBy('firstName'));
        
        const snapshot = await getDocs(q);
        announcementRecipientsList.innerHTML = '';
        currentFilteredEmployees = [];
        
        if (snapshot.empty) {
            announcementRecipientsList.innerHTML = '<div class="multi-select-option">No employees match the filters</div>';
            return;
        }
        
        snapshot.forEach(doc => {
            const employee = doc.data();
            const employeeId = doc.id;
            
            // Apply filters
            if (roleFilter !== 'all' && employee.role !== roleFilter) return;
            if (employerFilter !== 'all' && employee.employerId !== employerFilter) return;
            
            // Skip employees without email
            if (!employee.email) return;
            
            currentFilteredEmployees.push({
                id: employeeId,
                email: employee.email,
                name: `${employee.firstName} ${employee.lastName}`,
                role: employee.role
            });
            
            const employeeDiv = document.createElement('div');
            employeeDiv.className = 'multi-select-option';
            employeeDiv.innerHTML = `
                <input type="checkbox" id="ann-emp-${employeeId}" data-id="${employeeId}" data-email="${employee.email}" 
                       data-name="${employee.firstName} ${employee.lastName}">
                <label for="ann-emp-${employeeId}">${employee.firstName} ${employee.lastName} (${employee.role}) - ${employee.email}</label>
            `;
            
            // Check if already selected
            if (announcementSelectedEmployees.some(emp => emp.id === employeeId)) {
                employeeDiv.querySelector('input').checked = true;
            }
            
            // Add event listener to checkbox
            const checkbox = employeeDiv.querySelector('input');
            checkbox.addEventListener('change', (e) => {
                const employeeId = e.target.getAttribute('data-id');
                const employeeEmail = e.target.getAttribute('data-email');
                const employeeName = e.target.getAttribute('data-name');
                
                if (e.target.checked) {
                    announcementSelectedEmployees.push({ 
                        id: employeeId, 
                        email: employeeEmail,
                        name: employeeName
                    });
                } else {
                    announcementSelectedEmployees = announcementSelectedEmployees.filter(emp => emp.id !== employeeId);
                }
                
                updateSelectAllCheckbox();
                updateAnnouncementSelectedRecipients();
            });
            
            announcementRecipientsList.appendChild(employeeDiv);
        });
        
        if (announcementRecipientsList.children.length === 0) {
            announcementRecipientsList.innerHTML = '<div class="multi-select-option">No employees match the filters</div>';
        }
        
        updateSelectAllCheckbox();
    }

    // Update the "Select All" checkbox state
    function updateSelectAllCheckbox() {
        if (currentFilteredEmployees.length === 0) {
            selectAllEmployees.checked = false;
            selectAllEmployees.disabled = true;
            return;
        }
        
        selectAllEmployees.disabled = false;
        
        // Check if all filtered employees are selected
        const allSelected = currentFilteredEmployees.every(emp => 
            announcementSelectedEmployees.some(selected => selected.id === emp.id)
        );
        
        selectAllEmployees.checked = allSelected;
    }

    // Toggle select all employees
    function toggleSelectAllEmployees() {
        const checkboxes = announcementRecipientsList.querySelectorAll('input[type="checkbox"]');
        
        if (selectAllEmployees.checked) {
            // Add all filtered employees that aren't already selected
            currentFilteredEmployees.forEach(emp => {
                if (!announcementSelectedEmployees.some(selected => selected.id === emp.id)) {
                    announcementSelectedEmployees.push(emp);
                }
            });
            
            // Check all checkboxes
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        } else {
            // Remove only the filtered employees
            announcementSelectedEmployees = announcementSelectedEmployees.filter(selected => 
                !currentFilteredEmployees.some(emp => emp.id === selected.id)
            );
            
            // Uncheck all checkboxes
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        updateAnnouncementSelectedRecipients();
    }

    // Update the selected recipients list in announcement modal
    function updateAnnouncementSelectedRecipients() {
        announcementSelectedRecipients.innerHTML = '';
        
        announcementSelectedEmployees.forEach(employee => {
            const employeeBadge = document.createElement('div');
            employeeBadge.className = 'selected-employee';
            employeeBadge.innerHTML = `
                ${employee.name} (${employee.email})
                <span class="remove-employee" data-id="${employee.id}">&times;</span>
            `;
            
            // Add event listener to remove button
            employeeBadge.querySelector('.remove-employee').addEventListener('click', (e) => {
                const employeeId = e.target.getAttribute('data-id');
                announcementSelectedEmployees = announcementSelectedEmployees.filter(emp => emp.id !== employeeId);
                
                // Uncheck the checkbox
                const checkbox = document.querySelector(`#ann-emp-${employeeId}`);
                if (checkbox) checkbox.checked = false;
                
                updateSelectAllCheckbox();
                updateAnnouncementSelectedRecipients();
            });
            
            announcementSelectedRecipients.appendChild(employeeBadge);
        });
    }

    // Initialize rich text editor functionality
    function initEditor() {
        // Toolbar buttons
        document.querySelectorAll('.editor-btn[data-command]').forEach(btn => {
            btn.addEventListener('click', () => {
                const command = btn.getAttribute('data-command');
                document.execCommand(command, false, null);
                announcementEditor.focus();
            });
        });
        
        // Font size
        document.getElementById('font-size').addEventListener('change', function() {
            if (this.value) {
                document.execCommand('fontSize', false, this.value);
                announcementEditor.focus();
            }
        });
        
        // Font family
        document.getElementById('font-family').addEventListener('change', function() {
            if (this.value) {
                document.execCommand('fontName', false, this.value);
                announcementEditor.focus();
            }
        });
        
        // Font color
        document.getElementById('font-color').addEventListener('input', function() {
            document.execCommand('foreColor', false, this.value);
            announcementEditor.focus();
        });
        
        // Link creation
        document.querySelector('.editor-btn[data-command="createLink"]').addEventListener('click', function() {
            const url = prompt('Enter the URL:');
            if (url) {
                document.execCommand('createLink', false, url);
                announcementEditor.focus();
            }
        });
    }

    // Send announcement email
    async function sendAnnouncement() {
        const subject = announcementSubject.value.trim();
        const htmlContent = announcementEditor.innerHTML;
        
        // Validate inputs
        if (!subject) {
            showNotification('Please enter a subject', 'error');
            return;
        }
        
        if (!htmlContent) {
            showNotification('Please enter a message', 'error');
            return;
        }
        
        if (announcementSelectedEmployees.length === 0) {
            showNotification('Please select at least one recipient', 'error');
            return;
        }
        
        // Prepare email data
        const sender = {
            name: "ShiftMaster Pro",
            email: "noreply@shiftmaster.com"
        };
        
        const to = announcementSelectedEmployees.map(emp => ({
            email: emp.email,
            name: emp.name
        }));
        
        const emailData = {
            sender,
            to,
            subject,
            htmlContent
        };
        
        // Handle attachment if provided
        if (announcementAttachment.files.length > 0) {
            const file = announcementAttachment.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const content = e.target.result.split(',')[1]; // Get base64 content
                const attachment = {
                    name: file.name,
                    content: content
                };
                
                emailData.attachment = [attachment];
                
                try {
                    // Send email with attachment
                    await sendBulkEmail(emailData);
                    
                    // Send push notifications to all recipients
                    const playerIds = announcementSelectedEmployees.map(emp => emp.id);
                    await sendPushNotification(playerIds, subject, 'You have a new announcement');
                    
                    showNotification('Announcement sent successfully!');
                    closeAnnouncementModal();
                } catch (error) {
                    console.error('Error sending announcement:', error);
                    showNotification('Error sending announcement. Please try again.', 'error');
                }
            };
            
            reader.readAsDataURL(file);
        } else {
            try {
                // Send email without attachment
                await sendBulkEmail(emailData);
                
                // Send push notifications to all recipients
                const playerIds = announcementSelectedEmployees.map(emp => emp.id);
                await sendPushNotification(playerIds, subject, 'You have a new announcement');
                
                showNotification('Announcement sent successfully!');
                closeAnnouncementModal();
            } catch (error) {
                console.error('Error sending announcement:', error);
                showNotification('Error sending announcement. Please try again.', 'error');
            }
        }
    }

    // Send bulk email using Brevo API
    async function sendBulkEmail(emailData) {
        try {
            const response = await fetch('https://api.brevo.com/v3/smtp/email', {
                method: 'POST',
                headers: {
                    'accept': 'application/json',
                    'api-key': BREVO_API_KEY,
                    'content-type': 'application/json'
                },
                body: JSON.stringify(emailData)
            });
            
            const data = await response.json();
            if (!response.ok) {
                console.error('Error sending email:', data);
                throw new Error(data.message || 'Failed to send email');
            }
            
            return data;
        } catch (error) {
            console.error('Error sending email:', error);
            throw error;
        }
    }

    // Add event listeners for announcement functionality
    function initAnnouncementFunctionality() {
        // Floating button
        announcementFab.addEventListener('click', openAnnouncementModal);
        
        // Modal buttons
        closeAnnouncementModalBtn.addEventListener('click', closeAnnouncementModal);
        cancelAnnouncementModalBtn.addEventListener('click', closeAnnouncementModal);
        sendAnnouncementBtn.addEventListener('click', sendAnnouncement);
        
        // Filter changes
        announcementFilterRole.addEventListener('change', loadAnnouncementRecipients);
        announcementFilterEmployer.addEventListener('change', loadAnnouncementRecipients);
        
        // Select All checkbox
        selectAllEmployees.addEventListener('change', toggleSelectAllEmployees);
        
        // Initialize editor
        initEditor();
    }

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initApp();
        
        // Show/hide mobile close button based on screen size
        function checkScreenSize() {
            const mobileCloseBtn = document.getElementById('mobile-close-btn');
            if (window.innerWidth <= 768) {
                mobileCloseBtn.style.display = 'flex';
            } else {
                mobileCloseBtn.style.display = 'none';
            }
        }

        // Initial check
        checkScreenSize();
        
        // Check on resize
        window.addEventListener('resize', checkScreenSize);

        // Add click handler for mobile close button
        document.getElementById('mobile-close-btn').addEventListener('click', function() {
            // Close any open modal
            const openModal = document.querySelector('.modal-overlay.active');
            if (openModal) {
                openModal.classList.remove('active');
            }
        });

        // Enhanced close button animation
        document.querySelectorAll('.modal-close, .btn-outline').forEach(btn => {
            btn.addEventListener('click', function(e) {
                // Ripple effect
                const x = e.clientX - e.target.getBoundingClientRect().left;
                const y = e.clientY - e.target.getBoundingClientRect().top;
                
                const ripple = document.createElement('span');
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                ripple.classList.add('ripple-effect');
                
                this.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        });
    });
</script>
</body>
</html>
