<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DNATA Employee Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
   <style>
    /* Base Styles */
:root {
  --primary: #0066cc;
  --primary-light: #3388ff;
  --primary-dark: #004c99;
  --secondary: #ff6600;
  --success: #28a745;
  --danger: #dc3545;
  --warning: #fd7e14;
  --info: #17a2b8;
  --light: #f8f9fa;
  --dark: #343a40;
  --gray: #6c757d;
  --gray-light: #e9ecef;
  --white: #ffffff;
  --black: #000000;
  --glass-bg: rgba(255, 255, 255, 0.15);
  --glass-border: rgba(255, 255, 255, 0.18);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
  --text-primary: #212529;
  --text-secondary: #495057;
  --text-light: #f8f9fa;
}

[data-theme="dark"] {
  --primary: #3399ff;
  --primary-light: #66b3ff;
  --primary-dark: #0073e6;
  --secondary: #ff8533;
  --light: #212529;
  --dark: #f8f9fa;
  --gray: #adb5bd;
  --gray-light: #343a40;
  --white: #121212;
  --black: #ffffff;
  --glass-bg: rgba(0, 0, 0, 0.25);
  --glass-border: rgba(255, 255, 255, 0.05);
  --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
  --text-primary: #f8f9fa;
  --text-secondary: #e9ecef;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  transition: background-color 0.3s ease, color 0.3s ease;
}

html, body {
  height: 100%;
  background-color: var(--white);
  color: var(--text-primary);
}

body {
  display: flex;
  flex-direction: column;
  position: relative;
  overflow-x: hidden;
}

/* Loading Animation */
#loadingContainer {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: var(--white);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.5s ease;
}

#loadingContainer.hidden {
  opacity: 0;
  pointer-events: none;
}

#loadingAnimation {
  width: 150px;
  height: 150px;
}

/* Theme Switcher */
.theme-switcher {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background-color: var(--primary);
  color: var(--white);
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  z-index: 100;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  transition: transform 0.3s ease;
}

.theme-switcher:hover {
  transform: scale(1.1);
}

.theme-switcher i {
  font-size: 1.2rem;
}

/* Login Container */
#loginContainer {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
  background-color: var(--white);
  opacity: 1;
  transition: opacity 0.5s ease;
}

#loginContainer.hidden {
  opacity: 0;
  display: none;
}

.login-logo {
  margin-bottom: 20px;
}

.login-logo img {
  width: 120px;
  height: auto;
}

.login-title {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 5px;
  text-align: center;
}

.login-subtitle {
  font-size: 1rem;
  color: var(--gray);
  margin-bottom: 30px;
  text-align: center;
}

/* Alerts */
.alert {
  display: none;
  align-items: center;
  padding: 12px 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  width: 100%;
  max-width: 400px;
  background-color: var(--gray-light);
}

.alert i {
  margin-right: 10px;
  font-size: 1.2rem;
}

.alert-warning {
  background-color: rgba(253, 126, 20, 0.15);
  border-left: 4px solid var(--warning);
  color: var(--warning);
}

.alert-danger {
  background-color: rgba(220, 53, 69, 0.15);
  border-left: 4px solid var(--danger);
  color: var(--danger);
}

/* Login Form */
.login-form {
  width: 100%;
  max-width: 400px;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--text-primary);
}

.input-with-icon {
  position: relative;
}

.input-icon {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gray);
}

.password-toggle {
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gray);
  cursor: pointer;
}

.form-control {
  width: 100%;
  padding: 12px 15px 12px 45px;
  border: 1px solid var(--gray-light);
  border-radius: 8px;
  font-size: 1rem;
  background-color: var(--white);
  color: var(--text-primary);
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
}

.forgot-password {
  color: var(--primary);
  text-decoration: none;
  font-size: 0.9rem;
  transition: color 0.3s ease;
}

.forgot-password:hover {
  color: var(--primary-dark);
  text-decoration: underline;
}

/* Buttons */
.btn {
  display: inline-block;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
  transition: all 0.3s ease;
}

.btn-block {
  display: block;
  width: 100%;
}

.btn-primary {
  background-color: var(--primary);
  color: var(--white);
}

.btn-primary:hover {
  background-color: var(--primary-dark);
}

.btn-danger {
  background-color: var(--danger);
  color: var(--white);
}

.btn-danger:hover {
  background-color: #c82333;
}

.btn-success {
  background-color: var(--success);
  color: var(--white);
}

.btn-success:hover {
  background-color: #218838;
}

.btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

/* Ripple Effect */
.ripple {
  position: relative;
  overflow: hidden;
}

.ripple-effect {
  position: absolute;
  border-radius: 50%;
  background-color: rgba(255, 255, 255, 0.7);
  transform: scale(0);
  animation: ripple 0.6s linear;
  pointer-events: none;
}

@keyframes ripple {
  to {
    transform: scale(4);
    opacity: 0;
  }
}

/* Dashboard Container */
#dashboardContainer {
  display: none;
  flex-direction: column;
  min-height: 100vh;
  background-color: var(--white);
  opacity: 0;
  transition: opacity 0.5s ease;
}

#dashboardContainer.active {
  opacity: 1;
  display: flex;
}

/* Fixed Header */
.fixed-header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  padding: 15px 20px;
  background-color: var(--glass-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  display: flex;
  align-items: center;
  justify-content: space-between;
  z-index: 90;
  transform: translateY(-100%);
  transition: transform 0.3s ease;
}

.fixed-header.visible {
  transform: translateY(0);
}

.header-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0 auto;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 15px;
}

.header-btn {
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 1.2rem;
  cursor: pointer;
  padding: 5px;
  border-radius: 50%;
  transition: background-color 0.3s ease;
}

.header-btn:hover {
  background-color: rgba(0, 0, 0, 0.1);
}

.header-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: var(--primary);
  color: var(--white);
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: 600;
  cursor: pointer;
  background-size: cover;
  background-position: center;
}

/* Dashboard Content */
.dashboard-content {
  padding: 80px 20px 100px;
  flex: 1;
}

.dashboard-section {
  margin-bottom: 30px;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}

.dashboard-section.visible {
  opacity: 1;
  transform: translateY(0);
}

.section-title {
  font-size: 1.3rem;
  margin-bottom: 15px;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.section-title i {
  color: var(--primary);
}

.section-card {
  background-color: var(--glass-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 20px;
  box-shadow: var(--glass-shadow);
  margin-bottom: 20px;
}

/* Dashboard Icons */
#dashboardIconsContainer {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  background-color: var(--glass-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 50px;
  padding: 10px;
  box-shadow: var(--glass-shadow);
  z-index: 95;
}

#dashboardIconsContainer.hidden {
  display: none;
}

.dashboard-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
}

.dashboard-icon.active {
  background-color: var(--primary);
  color: var(--white);
}

.dashboard-icon i {
  font-size: 1.3rem;
  margin-bottom: 3px;
}

.dashboard-icon-text {
  font-size: 0.7rem;
  font-weight: 600;
}

.dashboard-icon-tooltip {
  position: absolute;
  top: -40px;
  background-color: var(--dark);
  color: var(--light);
  padding: 5px 10px;
  border-radius: 5px;
  font-size: 0.8rem;
  white-space: nowrap;
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
}

.dashboard-icon-tooltip::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 50%;
  transform: translateX(-50%);
  border-width: 5px 5px 0;
  border-style: solid;
  border-color: var(--dark) transparent transparent;
}

/* Fullscreen Content */
.fullscreen-content {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: var(--white);
  padding: 80px 20px 100px;
  overflow-y: auto;
  z-index: 80;
  display: none;
  opacity: 0;
  transform: translateX(100%);
}

.fullscreen-content.active {
  display: block;
  opacity: 1;
  transform: translateX(0);
  animation: swipeIn 0.4s forwards;
}

@keyframes swipeIn {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}

.fullscreen-content h2 {
  font-size: 1.5rem;
  margin-bottom: 20px;
  color: var(--text-primary);
}

/* Search Container */
.search-container {
  display: flex;
  margin-bottom: 20px;
}

.search-input {
  flex: 1;
  padding: 12px 15px;
  border: 1px solid var(--gray-light);
  border-radius: 8px 0 0 8px;
  font-size: 1rem;
  background-color: var(--white);
  color: var(--text-primary);
}

.search-btn {
  padding: 0 15px;
  background-color: var(--primary);
  color: var(--white);
  border: none;
  border-radius: 0 8px 8px 0;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.search-btn:hover {
  background-color: var(--primary-dark);
}

/* Employee Cards */
.employee-card {
  display: flex;
  align-items: center;
  padding: 15px;
  background-color: var(--glass-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 10px;
  margin-bottom: 15px;
  box-shadow: var(--glass-shadow);
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.employee-card.visible {
  opacity: 1;
  transform: translateY(0);
}

.employee-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background-color: var(--primary);
  color: var(--white);
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: 600;
  margin-right: 15px;
  background-size: cover;
  background-position: center;
}

.employee-info {
  flex: 1;
}

.employee-name {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 3px;
}

.employee-id {
  font-size: 0.8rem;
  color: var(--gray);
  margin-bottom: 3px;
}

.employee-position {
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.employee-connect-btn {
  padding: 8px 12px;
  background-color: var(--primary);
  color: var(--white);
  border: none;
  border-radius: 20px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 5px;
}

.employee-connect-btn:hover {
  background-color: var(--primary-dark);
}

.no-employees {
  text-align: center;
  padding: 20px;
  color: var(--gray);
}

/* Team Cards */
.team-card {
  background-color: var(--glass-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: var(--glass-shadow);
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.team-card.visible {
  opacity: 1;
  transform: translateY(0);
}

.team-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.team-name {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 1.1rem;
}

.team-date {
  font-size: 0.9rem;
  color: var(--gray);
}

.team-details {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 15px;
}

.team-detail {
  display: flex;
}

.team-label {
  font-weight: 600;
  margin-right: 5px;
  color: var(--text-primary);
}

.team-value {
  color: var(--text-secondary);
}

.break-schedule {
  margin: 15px 0;
  padding: 10px;
  background-color: rgba(0, 102, 204, 0.1);
  border-radius: 8px;
  border-left: 4px solid var(--primary);
}

.break-title {
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 5px;
}

.break-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
  font-size: 0.9rem;
}

.break-time {
  color: var(--text-primary);
}

.break-duration {
  color: var(--gray);
}

.team-members {
  margin-top: 15px;
}

.team-members h4 {
  margin-bottom: 10px;
  font-size: 1rem;
  color: var(--text-primary);
}

.member-item {
  display: flex;
  margin-bottom: 8px;
  font-size: 0.9rem;
}

.member-role {
  font-weight: 600;
  margin-right: 5px;
  color: var(--text-primary);
  min-width: 120px;
}

.member-name {
  color: var(--text-secondary);
}

.supervisor-badge {
  display: inline-block;
  background-color: var(--primary);
  color: var(--white);
  font-size: 0.7rem;
  padding: 2px 6px;
  border-radius: 10px;
  margin-left: 5px;
}

.no-teams {
  text-align: center;
  padding: 20px;
  color: var(--gray);
}

/* Announcements */
.announcement-item {
  background-color: var(--glass-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: var(--glass-shadow);
  cursor: pointer;
  transition: all 0.3s ease;
  opacity: 0;
  transform: translateY(20px);
}

.announcement-item.visible {
  opacity: 1;
  transform: translateY(0);
}

.announcement-item.expanded {
  background-color: var(--white);
}

.announcement-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.announcement-title {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 1.1rem;
}

.announcement-date {
  font-size: 0.8rem;
  color: var(--gray);
}

.announcement-content {
  font-size: 0.95rem;
  color: var(--text-secondary);
  line-height: 1.5;
}

.announcement-image {
  width: 100%;
  border-radius: 8px;
  margin: 10px 0;
}

.announcement-author {
  font-size: 0.8rem;
  color: var(--gray);
  margin-top: 10px;
  font-style: italic;
}

.no-announcements {
  text-align: center;
  padding: 20px;
  color: var(--gray);
}

/* Break Alerts */
.break-alert {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: calc(100% - 40px);
  max-width: 400px;
  z-index: 100;
  animation: breakAlertPopup 0.5s ease forwards;
}

@keyframes breakAlertPopup {
  0% {
    transform: translateY(100px);
    opacity: 0;
  }
  100% {
    transform: translateY(0);
    opacity: 1;
  }
}

.break-alert-fadeout {
  animation: breakAlertFadeout 0.3s ease forwards;
}

@keyframes breakAlertFadeout {
  100% {
    transform: translateY(100px);
    opacity: 0;
  }
}

.break-alert-content {
  background-color: var(--white);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.break-alert-header {
  display: flex;
  align-items: center;
  padding: 15px;
  background-color: var(--primary);
  color: var(--white);
}

.break-alert-icon {
  margin-right: 10px;
  font-size: 1.2rem;
}

.break-alert-title {
  flex: 1;
}

.break-alert-title h4 {
  margin-bottom: 3px;
  font-size: 1rem;
}

.break-alert-time {
  font-size: 0.8rem;
  opacity: 0.8;
}

.break-alert-close {
  background: none;
  border: none;
  color: var(--white);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0 0 0 10px;
}

.break-alert-body {
  padding: 15px;
  font-size: 0.95rem;
  color: var(--text-primary);
  border-bottom: 1px solid var(--gray-light);
}

.break-alert-footer {
  display: flex;
}

.break-alert-action {
  flex: 1;
  padding: 12px;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  transition: background-color 0.3s ease;
}

.break-alert-action:hover {
  background-color: var(--gray-light);
}

.break-alert-team {
  background-color: var(--primary);
}

.break-alert-team .break-alert-header {
  background-color: var(--primary-dark);
}

.break-alert-individual {
  background-color: var(--success);
}

.break-alert-individual .break-alert-header {
  background-color: var(--success);
}

/* Chat Modal */
#chatModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: var(--white);
  z-index: 110;
  display: none;
  flex-direction: column;
}

#chatModal.active {
  display: flex;
}

.chat-header {
  padding: 15px;
  background-color: var(--primary);
  color: var(--white);
  display: flex;
  align-items: center;
  position: relative;
}

.chat-back-btn {
  background: none;
  border: none;
  color: var(--white);
  font-size: 1.2rem;
  cursor: pointer;
  margin-right: 10px;
}

.chat-title {
  font-size: 1.2rem;
  font-weight: 600;
  flex: 1;
  text-align: center;
  padding-right: 30px;
}

.chat-messages {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  background-color: var(--white);
}

.no-messages {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray);
}

.message {
  margin-bottom: 15px;
  max-width: 80%;
}

.message-sent {
  margin-left: auto;
}

.message-received {
  margin-right: auto;
}

.message-header {
  display: flex;
  align-items: center;
  margin-bottom: 5px;
}

.message-avatar {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background-color: var(--primary);
  color: var(--white);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 0.8rem;
  font-weight: 600;
  margin-right: 10px;
  background-size: cover;
  background-position: center;
}

.message-info {
  flex: 1;
}

.message-sender {
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text-primary);
}

.message-time {
  font-size: 0.7rem;
  color: var(--gray);
}

.message-content {
  background-color: var(--glass-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 10px 15px;
  word-wrap: break-word;
  box-shadow: var(--glass-shadow);
}

.message-sent .message-content {
  background-color: var(--primary);
  color: var(--white);
  border-top-right-radius: 0;
}

.message-received .message-content {
  background-color: var(--gray-light);
  border-top-left-radius: 0;
}

.message-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 5px;
}

.message-action {
  font-size: 0.8rem;
  color: var(--gray);
  cursor: pointer;
  transition: color 0.3s ease;
}

.message-action:hover {
  color: var(--primary);
}

.file-message {
  background-color: var(--glass-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 10px;
  margin-top: 5px;
  box-shadow: var(--glass-shadow);
}

.file-message i {
  margin-right: 5px;
  color: var(--primary);
}

.file-preview {
  width: 100%;
  border-radius: 8px;
  margin-top: 10px;
}

.file-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.file-action {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 0.8rem;
  color: var(--primary);
  cursor: pointer;
}

.audio-message {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 5px;
}

.audio-message i {
  color: var(--primary);
}

.audio-player {
  flex: 1;
  max-width: 200px;
}

.chat-input-container {
  padding: 10px;
  background-color: var(--white);
  border-top: 1px solid var(--gray-light);
}

.chat-input {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid var(--gray-light);
  border-radius: 25px;
  font-size: 1rem;
  background-color: var(--white);
  color: var(--text-primary);
  padding-right: 50px;
}

.chat-send-btn {
  position: absolute;
  right: 20px;
  bottom: 20px;
  background-color: var(--primary);
  color: var(--white);
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.chat-send-btn:hover {
  background-color: var(--primary-dark);
}

.chat-actions {
  position: relative;
  margin-bottom: 10px;
}

.attachment-btn {
  background: none;
  border: none;
  color: var(--primary);
  font-size: 1.2rem;
  cursor: pointer;
  padding: 5px;
  border-radius: 50%;
  transition: background-color 0.3s ease;
}

.attachment-btn:hover {
  background-color: rgba(0, 102, 204, 0.1);
}

.expanded-actions {
  position: absolute;
  bottom: 40px;
  left: 0;
  background-color: var(--white);
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  display: none;
  flex-direction: column;
  gap: 10px;
  z-index: 1;
}

.expanded-actions.active {
  display: flex;
}

.expanded-action-btn {
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 1rem;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: background-color 0.3s ease;
}

.expanded-action-btn:hover {
  background-color: var(--gray-light);
}

.recording-indicator {
  display: none;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background-color: rgba(220, 53, 69, 0.1);
  border-radius: 20px;
  color: var(--danger);
  font-size: 0.9rem;
  margin-bottom: 10px;
}

.recording-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background-color: var(--danger);
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% {
    transform: scale(0.95);
    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
  }
  70% {
    transform: scale(1);
    box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
  }
  100% {
    transform: scale(0.95);
    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
  }
}

/* Camera Modal */
#cameraModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: var(--black);
  z-index: 120;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

#cameraModal.active {
  display: flex;
}

#cameraVideo {
  width: 100%;
  max-height: 80vh;
  object-fit: contain;
}

.camera-controls {
  position: fixed;
  bottom: 30px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 30px;
}

.camera-btn {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background-color: var(--white);
  color: var(--black);
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  border: none;
  font-size: 1.5rem;
}

#cameraCaptureBtn {
  width: 70px;
  height: 70px;
  background-color: var(--danger);
  color: var(--white);
}

#cameraCloseBtn {
  position: absolute;
  top: 30px;
  right: 30px;
  background-color: rgba(255, 255, 255, 0.3);
  color: var(--white);
}

/* Camera Preview */
#cameraPreview {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: var(--black);
  z-index: 130;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

#cameraPreview.active {
  display: flex;
}

#cameraPreviewImg {
  max-width: 100%;
  max-height: 80vh;
  object-fit: contain;
}

.preview-controls {
  position: fixed;
  bottom: 30px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 30px;
}

.preview-btn {
  padding: 10px 25px;
  border-radius: 25px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
}

#cameraPreviewRetake {
  background-color: var(--gray);
  color: var(--white);
}

#cameraPreviewAccept {
  background-color: var(--success);
  color: var(--white);
}

/* Modals */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 200;
}

.modal.active {
  display: flex;
}

.modal-content {
  background-color: var(--white);
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  overflow: hidden;
  transform: scale(0.9);
  opacity: 0;
  animation: modalFadeIn 0.3s ease forwards;
}

@keyframes modalFadeIn {
  to {
    transform: scale(1);
    opacity: 1;
  }
}

.modal-header {
  padding: 15px;
  background-color: var(--primary);
  color: var(--white);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 1.2rem;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  color: var(--white);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0 0 0 15px;
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  padding: 15px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  border-top: 1px solid var(--gray-light);
}

/* Profile Modal */
#profileModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 200;
}

#profileModal.active {
  display: flex;
}

.profile-modal-header {
  padding: 15px;
  background-color: var(--primary);
  color: var(--white);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.profile-modal-title {
  font-size: 1.2rem;
  font-weight: 600;
}

.profile-modal-close {
  background: none;
  border: none;
  color: var(--white);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0 0 0 15px;
}

.profile-modal-body {
  padding: 20px;
  max-height: 70vh;
  overflow-y: auto;
}

.profile-avatar-container {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto 20px;
}

#profileAvatar {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background-color: var(--primary);
  color: var(--white);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 2rem;
  font-weight: 600;
  background-size: cover;
  background-position: center;
}

#profileAvatarEdit {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: var(--primary);
  color: var(--white);
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  border: 3px solid var(--white);
}

#profileAvatarInput {
  display: none;
}

.profile-info-item {
  margin-bottom: 15px;
}

.profile-info-label {
  font-size: 0.9rem;
  color: var(--gray);
  margin-bottom: 5px;
}

.profile-info-value {
  font-size: 1rem;
  color: var(--text-primary);
  font-weight: 500;
}

.profile-modal-footer {
  padding: 15px;
  border-top: 1px solid var(--gray-light);
}

/* Forum Cards */
.forum-card {
  background-color: var(--glass-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: var(--glass-shadow);
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.forum-card.visible {
  opacity: 1;
  transform: translateY(0);
}

.forum-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.forum-title {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 1.1rem;
}

.forum-members {
  font-size: 0.8rem;
  color: var(--gray);
  display: flex;
  align-items: center;
  gap: 5px;
}

.forum-description {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 15px;
  line-height: 1.4;
}

.forum-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.forum-category {
  font-size: 0.8rem;
  padding: 4px 8px;
  background-color: var(--primary);
  color: var(--white);
  border-radius: 12px;
}

.forum-join-btn {
  padding: 8px 15px;
  background-color: var(--primary);
  color: var(--white);
  border: none;
  border-radius: 20px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.forum-join-btn:hover {
  background-color: var(--primary-dark);
}

.forum-exit-btn {
  padding: 8px 15px;
  background-color: var(--danger);
  color: var(--white);
  border: none;
  border-radius: 20px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-left: 10px;
}

.forum-exit-btn:hover {
  background-color: #c82333;
}

/* Confirmation Dialog */
.confirmation-dialog {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 300;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.confirmation-dialog.active {
  opacity: 1;
}

.confirmation-content {
  background-color: var(--white);
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  overflow: hidden;
  transform: scale(0.9);
  animation: modalFadeIn 0.3s ease forwards;
}

.confirmation-header {
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 15px;
}

.confirmation-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 1.5rem;
  color: var(--white);
}

.confirmation-icon.danger {
  background-color: var(--danger);
}

.confirmation-icon.warning {
  background-color: var(--warning);
}

.confirmation-icon.success {
  background-color: var(--success);
}

.confirmation-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-primary);
}

.confirmation-message {
  padding: 0 20px 20px;
  color: var(--text-secondary);
  line-height: 1.5;
}

.confirmation-input {
  width: 100%;
  padding: 10px 15px;
  border: 1px solid var(--gray-light);
  border-radius: 8px;
  margin: 10px 20px 20px;
  font-size: 1rem;
}

.confirmation-footer {
  padding: 15px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  border-top: 1px solid var(--gray-light);
}

.confirmation-btn {
  padding: 8px 15px;
  border: none;
  border-radius: 5px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.confirmation-btn-cancel {
  background-color: var(--gray-light);
  color: var(--text-primary);
}

.confirmation-btn-cancel:hover {
  background-color: #d1d1d1;
}

.confirmation-btn-confirm {
  background-color: var(--primary);
  color: var(--white);
}

.confirmation-btn-confirm:hover {
  background-color: var(--primary-dark);
}

.confirmation-btn-danger {
  background-color: var(--danger);
  color: var(--white);
}

.confirmation-btn-danger:hover {
  background-color: #c82333;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
  .dashboard-content {
    padding: 70px 15px 120px;
  }
  
  .section-title {
    font-size: 1.1rem;
  }
  
  .team-details {
    grid-template-columns: 1fr;
  }
  
  .member-role {
    min-width: 100px;
  }
  
  #dashboardIconsContainer {
    bottom: 10px;
  }
  
  .dashboard-icon {
    width: 50px;
    height: 50px;
  }
  
  .dashboard-icon i {
    font-size: 1.1rem;
  }
  
  .dashboard-icon-text {
    font-size: 0.6rem;
  }
  
  .theme-switcher {
    bottom: 80px;
  }
}

@media (max-width: 480px) {
  .login-title {
    font-size: 1.5rem;
  }
  
  .dashboard-content {
    padding: 60px 10px 110px;
  }
  
  .section-card {
    padding: 15px;
  }
  
  .team-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 5px;
  }
  
  .team-date {
    align-self: flex-end;
  }
  
  .member-item {
    flex-direction: column;
    gap: 3px;
  }
  
  .forum-footer {
    flex-direction: column;
    gap: 10px;
    align-items: flex-start;
  }
  
  .forum-join-btn, .forum-exit-btn {
    width: 100%;
  }
}
   </style>
</head>
<body>
    <!-- Loading Animation -->
    <div id="loadingContainer">
        <div id="loadingAnimation"></div>
    </div>

    <!-- Theme Switcher -->
    <div class="theme-switcher" id="themeSwitcher">
        <i class="fas fa-moon"></i>
    </div>

    <!-- Login Container -->
    <div id="loginContainer">
        <div class="login-logo">
            <img src="dnata.jpg" alt="DNATA Logo">
        </div>
        <h1 class="login-title">DNATA Employee Portal</h1>
        <p class="login-subtitle">Sign in to access your dashboard</p>
        
        <!-- Temporary Password Alert -->
        <div id="temporaryPasswordAlert" class="alert alert-warning">
            <i class="fas fa-exclamation-circle"></i>
            <div>Please change your temporary password</div>
        </div>
        
        <!-- Disabled Account Alert -->
        <div id="disabledAccountAlert" class="alert alert-danger">
            <i class="fas fa-ban"></i>
            <div>Your account has been disabled. Please contact HR.</div>
        </div>
        
        <form id="loginForm" class="login-form">
            <div class="form-group">
                <label for="username" class="form-label">Employee ID</label>
                <div class="input-with-icon">
                    <i class="fas fa-user input-icon"></i>
                    <input type="text" id="username" class="form-control" placeholder="Enter your employee ID" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <div class="input-with-icon">
                    <i class="fas fa-lock input-icon"></i>
                    <input type="password" id="password" class="form-control" placeholder="Enter your password" required>
                    <i class="fas fa-eye password-toggle" id="togglePassword"></i>
                </div>
            </div>
            
            <button type="submit" id="loginBtn" class="btn btn-primary btn-block ripple">
                <span id="btnText">Sign In</span>
                <i class="fas fa-spinner btn-spinner" id="btnSpinner"></i>
            </button>
            
            <div class="text-center mt-3">
                <a href="#" id="forgotPassword" class="forgot-password">Forgot Password?</a>
            </div>
        </form>
    </div>

    <!-- Dashboard Container -->
    <div id="dashboardContainer">
        <!-- Fixed Header -->
        <header class="fixed-header">
            <button id="globalBackButton" class="header-btn">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 id="headerTitle" class="header-title">DNATA Employee Portal</h1>
            <div id="headerActions" class="header-actions">
                <div id="headerUserAvatar" class="header-avatar"></div>
                <button id="headerLogoutBtn" class="header-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>
        
        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Dashboard Home Content -->
            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-home"></i> Dashboard</h2>
                <div class="section-card">
                    <div id="userAvatar" class="header-avatar" style="width: 60px; height: 60px; margin: 0 auto 15px;"></div>
                    <h3 style="text-align: center; margin-bottom: 5px;">Welcome Back!</h3>
                    <p style="text-align: center; color: var(--gray); font-size: 0.9rem;">Check your schedule and announcements below</p>
                </div>
            </div>
            
            <!-- Teams Section -->
            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-users"></i> Your Teams</h2>
                <div class="section-card">
                    <div id="teamsList"></div>
                </div>
            </div>
            
            <!-- Announcements Section -->
            <div class="dashboard-section">
                <h2 class="section-title"><i class="fas fa-bullhorn"></i> Announcements</h2>
                <div class="section-card">
                    <div id="announcementsBody"></div>
                </div>
            </div>
        </div>
        
        <!-- Fullscreen Content Sections -->
        <!-- Teams Content -->
        <div id="teamsContent" class="fullscreen-content">
            <h2>Your Team Assignments</h2>
            <div id="teamsModalBody"></div>
        </div>
        
        <!-- Connect Content -->
        <div id="connectContent" class="fullscreen-content">
            <h2>Connect with Colleagues</h2>
            <div class="search-container">
                <input type="text" id="employeeSearchInput" class="search-input" placeholder="Search employees...">
                <button id="employeeSearchBtn" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div id="employeeList"></div>
        </div>
        
        <!-- Forums Content -->
        <div id="forumsContent" class="fullscreen-content">
            <h2>Chat Forums</h2>
            <div id="forumsBody"></div>
        </div>
        
        <!-- Dashboard Icons -->
        <div id="dashboardIconsContainer" class="hidden">
            <div id="dashboardHomeIcon" class="dashboard-icon">
                <i class="fas fa-home"></i>
                <span class="dashboard-icon-text">Home</span>
                <div class="dashboard-icon-tooltip">Dashboard Home</div>
            </div>
            <div id="dashboardTeamsIcon" class="dashboard-icon">
                <i class="fas fa-users"></i>
                <span class="dashboard-icon-text">Teams</span>
                <div class="dashboard-icon-tooltip">View Teams</div>
            </div>
            <div id="dashboardConnectIcon" class="dashboard-icon">
                <i class="fas fa-user-friends"></i>
                <span class="dashboard-icon-text">Connect</span>
                <div class="dashboard-icon-tooltip">Connect</div>
            </div>
            <div id="dashboardForumsIcon" class="dashboard-icon">
                <i class="fas fa-comments"></i>
                <span class="dashboard-icon-text">Forums</span>
                <div class="dashboard-icon-tooltip">Chat Forums</div>
            </div>
        </div>
    </div>
    
    <!-- Chat Modal -->
    <div id="chatModal">
        <div class="chat-header">
            <button class="chat-back-btn" id="chatBackBtn">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 class="chat-title" id="chatForumTitle">Chat</h3>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-container">
            <div class="chat-actions">
                <button class="chat-action-btn" id="attachmentBtn">
                    <i class="fas fa-paperclip"></i>
                    <input type="file" id="fileUploadInput" style="display: none;">
                </button>
                <div class="expanded-actions" id="expandedActions">
                    <button class="expanded-action-btn" id="fileUploadBtn">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="expanded-action-btn" id="cameraUploadBtn">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button class="expanded-action-btn" id="voiceRecordBtn">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                <div class="recording-indicator" id="recordingIndicator">
                    <div class="recording-dot"></div>
                    <span>Recording</span>
                </div>
            </div>
            <input type="text" id="chatInput" class="chat-input" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Camera Modal -->
    <div id="cameraModal">
        <video id="cameraVideo" autoplay playsinline></video>
        <div class="camera-controls">
            <button class="camera-btn" id="cameraFlipBtn">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="camera-btn" id="cameraCaptureBtn">
                <i class="fas fa-circle"></i>
            </button>
            <button class="camera-btn" id="cameraCloseBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- Camera Preview -->
    <div id="cameraPreview">
        <img id="cameraPreviewImg" alt="Preview">
        <div class="preview-controls">
            <button class="preview-btn" id="cameraPreviewRetake">Retake</button>
            <button class="preview-btn" id="cameraPreviewAccept">Use Photo</button>
        </div>
    </div>
    
    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Change Password</h3>
                <button class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="currentPassword" class="form-label">Current Password</label>
                    <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password" required>
                </div>
                <div class="form-group">
                    <label for="newPassword" class="form-label">New Password</label>
                    <input type="password" id="newPassword" class="form-control" placeholder="Enter new password" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword" class="form-label">Confirm Password</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelPasswordChange">Cancel</button>
                <button class="btn btn-primary" id="submitNewPassword">Change Password</button>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profileModal">
        <div class="profile-modal-header">
            <h3 class="profile-modal-title">Your Profile</h3>
            <button class="profile-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="profile-modal-body">
            <div class="profile-avatar-container">
                <div id="profileAvatar"></div>
                <button id="profileAvatarEdit">
                    <i class="fas fa-camera"></i>
                    <input type="file" id="profileAvatarInput" accept="image/*">
                </button>
            </div>
            
            <div class="profile-info-item">
                <div class="profile-info-label">Employee ID</div>
                <div class="profile-info-value" id="profileEmployeeId"></div>
            </div>
            
            <div class="profile-info-item">
                <div class="profile-info-label">Name</div>
                <div class="profile-info-value" id="profileName"></div>
            </div>
            
            <div class="profile-info-item">
                <div class="profile-info-label">Department</div>
                <div class="profile-info-value" id="profileDepartment"></div>
            </div>
            
            <div class="profile-info-item">
                <div class="profile-info-label">Position</div>
                <div class="profile-info-value" id="profilePosition"></div>
            </div>
        </div>
        <div class="profile-modal-footer">
            <button class="btn btn-primary btn-block" id="logoutBtn">Sign Out</button>
        </div>
    </div>
 <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.1/lottie.min.js"></script>
  <script> 
   // Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDQfo8qILskxClJy52_19tFdx6xMsiQD2M",
    authDomain: "dnata-e2569.firebaseapp.com",
    databaseURL: "https://dnata-e2569-default-rtdb.firebaseio.com",
    projectId: "dnata-e2569",
    storageBucket: "dnata-e2569.firebasestorage.app",
    messagingSenderId: "693382423789",
    appId: "1:693382423789:web:8aa14672c6ef34ee59d8e4",
    measurementId: "G-B6F7CHPM2Y"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// Initialize loading animation
const loadingAnimation = document.getElementById('loadingAnimation');
const loadingContainer = document.getElementById('loadingContainer');

// Load Lottie animation
const anim = lottie.loadAnimation({
    container: loadingAnimation,
    renderer: 'svg',
    loop: true,
    autoplay: true,
    path: 'https://assets9.lottiefiles.com/packages/lf20_usmfx6bp.json'
});

// Hide loading animation after 1.5 seconds (simulate loading)
setTimeout(() => {
    loadingContainer.classList.add('hidden');
}, 1500);

// Global variables for break management
let breakCheckInterval = null;
let alertedBreaks = new Set();
let teams = []; // Initialize teams array globally
let activeBreakAlerts = []; // Track active break alerts

// Theme switcher functionality
const themeSwitcher = document.getElementById('themeSwitcher');
const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

// Check for saved theme preference or use system preference
const currentTheme = localStorage.getItem('theme');
if (currentTheme === 'dark' || (!currentTheme && prefersDarkScheme.matches)) {
    document.documentElement.setAttribute('data-theme', 'dark');
    themeSwitcher.innerHTML = '<i class="fas fa-sun"></i>';
} else {
    document.documentElement.setAttribute('data-theme', 'light');
    themeSwitcher.innerHTML = '<i class="fas fa-moon"></i>';
}

// Toggle theme when switcher is clicked
themeSwitcher.addEventListener('click', function() {
    if (document.documentElement.getAttribute('data-theme') === 'dark') {
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
        themeSwitcher.innerHTML = '<i class="fas fa-moon"></i>';
    } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
        themeSwitcher.innerHTML = '<i class="fas fa-sun"></i>';
    }
});

// Custom confirmation dialog function
function showConfirmation(options) {
    return new Promise((resolve) => {
        const dialog = document.createElement('div');
        dialog.className = 'confirmation-dialog';
        
        const iconClass = options.type === 'danger' ? 'danger' : 
                         options.type === 'warning' ? 'warning' : 
                         options.type === 'success' ? 'success' : '';
        
        dialog.innerHTML = `
            <div class="confirmation-content">
                <div class="confirmation-header">
                    <div class="confirmation-icon ${iconClass}">
                        <i class="fas ${options.icon || 'fa-question'}"></i>
                    </div>
                    <div>
                        <h3 class="confirmation-title">${options.title || 'Are you sure?'}</h3>
                    </div>
                </div>
                <div class="confirmation-message">${options.message}</div>
                ${options.input ? 
                    `<input type="${options.inputType || 'text'}" class="confirmation-input" 
                           placeholder="${options.inputPlaceholder || ''}" 
                           value="${options.inputValue || ''}">` : ''}
                <div class="confirmation-footer">
                    <button class="confirmation-btn confirmation-btn-cancel">
                        ${options.cancelText || 'Cancel'}
                    </button>
                    <button class="confirmation-btn ${options.danger ? 'confirmation-btn-danger' : 'confirmation-btn-confirm'}">
                        ${options.confirmText || 'Confirm'}
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
        
        setTimeout(() => dialog.classList.add('active'), 10);
        
        const cancelBtn = dialog.querySelector('.confirmation-btn-cancel');
        const confirmBtn = dialog.querySelector('.confirmation-btn-confirm, .confirmation-btn-danger');
        const input = dialog.querySelector('.confirmation-input');
        
        cancelBtn.addEventListener('click', () => {
            dialog.classList.remove('active');
            setTimeout(() => dialog.remove(), 300);
            resolve(options.input ? { confirmed: false } : false);
        });
        
        confirmBtn.addEventListener('click', () => {
            dialog.classList.remove('active');
            setTimeout(() => dialog.remove(), 300);
            if (options.input) {
                resolve({ confirmed: true, value: input.value });
            } else {
                resolve(true);
            }
        });
        
        // Close on ESC key
        document.addEventListener('keydown', function onKeydown(e) {
            if (e.key === 'Escape') {
                dialog.classList.remove('active');
                setTimeout(() => dialog.remove(), 300);
                resolve(options.input ? { confirmed: false } : false);
                document.removeEventListener('keydown', onKeydown);
            }
        });
    });
}

// Replace window.confirm with custom version
window.customConfirm = async (message, options = {}) => {
    return await showConfirmation({
        ...options,
        message: message,
        title: options.title || 'Are you sure?'
    });
};

// Replace window.prompt with custom version
window.customPrompt = async (message, defaultValue = '', options = {}) => {
    const result = await showConfirmation({
        ...options,
        message: message,
        title: options.title || 'Please enter',
        input: true,
        inputValue: defaultValue,
        inputPlaceholder: options.placeholder,
        inputType: options.type
    });
    
    return result.confirmed ? result.value : null;
};

document.addEventListener('DOMContentLoaded', function() {
    // Fixed header elements
    const fixedHeader = document.querySelector('.fixed-header');
    const headerTitle = document.getElementById('headerTitle');
    const headerActions = document.getElementById('headerActions');
    const headerUserAvatar = document.getElementById('headerUserAvatar');
    const headerLogoutBtn = document.getElementById('headerLogoutBtn');
    const globalBackButton = document.getElementById('globalBackButton');

    // Password toggle functionality
    const togglePassword = document.getElementById('togglePassword');
    const password = document.getElementById('password');
    
    togglePassword.addEventListener('click', function() {
        const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
        password.setAttribute('type', type);
        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
        
        // Micro-interaction
        this.style.transform = 'scale(1.2)';
        setTimeout(() => {
            this.style.transform = 'scale(1)';
        }, 200);
    });

    // Ripple effect for buttons
    const buttons = document.querySelectorAll('.ripple');
    buttons.forEach(button => {
        button.addEventListener('click', function(e) {
            const x = e.clientX - e.target.getBoundingClientRect().left;
            const y = e.clientY - e.target.getBoundingClientRect().top;
            
            const ripple = document.createElement('span');
            ripple.classList.add('ripple-effect');
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            
            this.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        });
    });

    // Modal functionality
    const modal = document.getElementById('changePasswordModal');
    const modalCloseButtons = document.querySelectorAll('.modal-close');
    
    modalCloseButtons.forEach(button => {
        button.addEventListener('click', function() {
            modal.classList.remove('active');
        });
    });

    // Profile modal functionality
    const profileModal = document.getElementById('profileModal');
    const profileModalClose = document.querySelector('.profile-modal-close');
    
    profileModalClose.addEventListener('click', function() {
        profileModal.classList.remove('active');
    });

    // Fullscreen content sections
    const fullscreenContents = document.querySelectorAll('.fullscreen-content');
    let currentActiveContent = null;
    let currentActiveIcon = null;

    function showFullscreenContent(contentId) {
        // Hide currently active content with animation
        if (currentActiveContent) {
            currentActiveContent.classList.remove('active');
            if (currentActiveIcon) {
                currentActiveIcon.classList.remove('active');
            }
        }
        
        // Show new content with animation
        const content = document.getElementById(contentId);
        content.classList.add('active');
        currentActiveContent = content;
        
        // Highlight the active icon
        const iconId = contentId.replace('Content', 'Icon');
        currentActiveIcon = document.getElementById(iconId);
        if (currentActiveIcon) {
            currentActiveIcon.classList.add('active');
        }
        
        // Update header title
        const contentTitle = content.querySelector('h2').textContent;
        headerTitle.textContent = contentTitle;
        
        // Show back button in header
        globalBackButton.style.display = 'block';
        
        // Load data if needed
        if (contentId === 'teamsContent') {
            const user = auth.currentUser;
            if (user) {
                const username = user.email.split('@')[0];
                loadEmployeeTeamsForModal(username);
            }
        } else if (contentId === 'connectContent') {
            // Initialize the connect page with all employees
            searchEmployees();
        } else if (contentId === 'forumsContent') {
            loadChatForums();
        }
        
        // Animate in the content
        const elements = content.querySelectorAll('.employee-card, .forum-card, .team-card');
        elements.forEach((el, index) => {
            setTimeout(() => {
                el.classList.add('visible');
            }, index * 100);
        });
    }

    function hideFullscreenContent() {
        if (currentActiveContent) {
            currentActiveContent.classList.remove('active');
            currentActiveContent = null;
            
            if (currentActiveIcon) {
                currentActiveIcon.classList.remove('active');
                currentActiveIcon = null;
            }
        }
        
        // Reset header title
        headerTitle.textContent = 'DNATA Employee Portal';
        
        // Hide back button in header
        globalBackButton.style.display = 'none';
        
        // Show dashboard sections with animation
        const sections = document.querySelectorAll('.dashboard-section');
        sections.forEach((section, index) => {
            setTimeout(() => {
                section.classList.add('visible');
            }, index * 150);
        });
    }

    // Global back button functionality
    globalBackButton.addEventListener('click', function() {
        if (currentActiveContent) {
            // Animate out the current content
            currentActiveContent.style.animation = 'swipeOut 0.4s forwards';
            setTimeout(() => {
                hideFullscreenContent();
                currentActiveContent.style.animation = '';
            }, 400);
        }
    });

    // Dashboard icon click handlers
    document.getElementById('dashboardHomeIcon').addEventListener('click', function() {
        if (currentActiveContent) {
            // Animate out the current content
            currentActiveContent.style.animation = 'swipeOut 0.4s forwards';
            setTimeout(() => {
                hideFullscreenContent();
                currentActiveContent.style.animation = '';
            }, 400);
        }
    });
    
    document.getElementById('dashboardTeamsIcon').addEventListener('click', function() {
        if (currentActiveContent && currentActiveContent.id === 'teamsContent') {
            currentActiveContent.style.animation = 'swipeOut 0.4s forwards';
            setTimeout(() => {
                hideFullscreenContent();
                currentActiveContent.style.animation = '';
            }, 400);
        } else {
            showFullscreenContent('teamsContent');
            document.getElementById('teamsContent').style.animation = 'swipeIn 0.4s forwards';
        }
    });
    
    document.getElementById('dashboardConnectIcon').addEventListener('click', function() {
        if (currentActiveContent && currentActiveContent.id === 'connectContent') {
            currentActiveContent.style.animation = 'swipeOut 0.4s forwards';
            setTimeout(() => {
                hideFullscreenContent();
                currentActiveContent.style.animation = '';
            }, 400);
        } else {
            showFullscreenContent('connectContent');
            document.getElementById('connectContent').style.animation = 'swipeIn 0.4s forwards';
        }
    });
    
    document.getElementById('dashboardForumsIcon').addEventListener('click', function() {
        if (currentActiveContent && currentActiveContent.id === 'forumsContent') {
            currentActiveContent.style.animation = 'swipeOut 0.4s forwards';
            setTimeout(() => {
                hideFullscreenContent();
                currentActiveContent.style.animation = '';
            }, 400);
        } else {
            showFullscreenContent('forumsContent');
            document.getElementById('forumsContent').style.animation = 'swipeIn 0.4s forwards';
        }
    });

    // Employee search functionality
    const employeeSearchInput = document.getElementById('employeeSearchInput');
    const employeeSearchBtn = document.getElementById('employeeSearchBtn');
    const employeeList = document.getElementById('employeeList');
    
    employeeSearchBtn.addEventListener('click', searchEmployees);
    employeeSearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchEmployees();
        }
    });

    function searchEmployees() {
        const searchTerm = employeeSearchInput.value.trim().toLowerCase();
        employeeList.innerHTML = '<div class="no-employees">Searching employees...</div>';
        
        // Add micro-interaction to search button
        employeeSearchBtn.style.transform = 'scale(0.95)';
        setTimeout(() => {
            employeeSearchBtn.style.transform = 'scale(1)';
        }, 200);
        
        db.collection('employees').get()
            .then(snapshot => {
                if (snapshot.empty) {
                    employeeList.innerHTML = '<div class="no-employees">No employees found</div>';
                    return;
                }
                
                let employees = [];
                
                snapshot.forEach(doc => {
                    const employee = doc.data();
                    employee.id = doc.id;
                    
                    // Check if employee matches search term
                    if (!searchTerm || 
                        employee.id.toLowerCase().includes(searchTerm) ||
                        (employee.firstName && employee.firstName.toLowerCase().includes(searchTerm)) ||
                        (employee.lastName && employee.lastName.toLowerCase().includes(searchTerm))) {
                        employees.push(employee);
                    }
                });
                
                if (employees.length === 0) {
                    employeeList.innerHTML = '<div class="no-employees">No employees match your search</div>';
                } else {
                    displayEmployees(employees);
                }
            })
            .catch(error => {
                console.error('Error searching employees:', error);
                employeeList.innerHTML = '<div class="no-employees">Error searching employees. Please try again.</div>';
            });
    }

    function displayEmployees(employees) {
        employeeList.innerHTML = '';
        
        employees.forEach((employee, index) => {
            const employeeCard = document.createElement('div');
            employeeCard.className = 'employee-card';
            
            const initials = `${employee.firstName?.charAt(0) || ''}${employee.lastName?.charAt(0) || ''}`;
            const avatarUrl = employee.avatarUrl || '';
            
            employeeCard.innerHTML = `
                <div class="employee-avatar" style="${avatarUrl ? `background-image: url('${avatarUrl}')` : ''}">
                    ${avatarUrl ? '' : initials}
                </div>
                <div class="employee-info">
                    <div class="employee-name">${employee.firstName || ''} ${employee.lastName || ''}</div>
                    <div class="employee-id">${employee.id}</div>
                    <div class="employee-position">${employee.position || 'Employee'}</div>
                </div>
                <button class="employee-connect-btn" data-employee-id="${employee.id}">
                    <i class="fas fa-paper-plane"></i> Message
                </button>
            `;
            
            employeeList.appendChild(employeeCard);
            
            // Animate each card with a delay
            setTimeout(() => {
                employeeCard.classList.add('visible');
            }, index * 100);
        });
        
        // Add event listeners to connect buttons
        document.querySelectorAll('.employee-connect-btn').forEach(button => {
            button.addEventListener('click', function() {
                const employeeId = this.getAttribute('data-employee-id');
                startPrivateChat(employeeId);
                
                // Micro-interaction
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 200);
            });
        });
    }

    function startPrivateChat(employeeId) {
        const user = auth.currentUser;
        if (!user) return;
        
        const currentUserId = user.email.split('@')[0];
        
        // Check if a private chat already exists between these users
        const chatId = [currentUserId, employeeId].sort().join('_');
        
        db.collection('privateChats').doc(chatId).get()
            .then(doc => {
                if (!doc.exists) {
                    // Create a new private chat
                    return db.collection('privateChats').doc(chatId).set({
                        participants: [currentUserId, employeeId],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            })
            .then(() => {
                // Open the chat
                openPrivateChat(chatId, employeeId);
            })
            .catch(error => {
                console.error('Error starting private chat:', error);
                alert('Error starting private chat. Please try again.');
            });
    }

    function openPrivateChat(chatId, employeeId) {
        currentForumId = chatId;
        
        // Get the employee's name for the chat title
        db.collection('employees').doc(employeeId).get()
            .then(doc => {
                if (doc.exists) {
                    const employee = doc.data();
                    chatForumTitle.textContent = `${employee.firstName || ''} ${employee.lastName || ''}`;
                    chatModal.classList.add('active');
                    chatMessages.innerHTML = '<div class="no-messages">Loading messages...</div>';
                    
                    // Load messages for this private chat
                    loadPrivateMessages(chatId);
                }
            });
    }

    function loadPrivateMessages(chatId) {
        if (unsubscribeMessages) {
            unsubscribeMessages();
        }

        const messagesQuery = db.collection('privateChats').doc(chatId)
            .collection('messages')
            .orderBy('timestamp', 'asc')
            .limit(100);

        unsubscribeMessages = messagesQuery.onSnapshot(snapshot => {
            if (snapshot.empty) {
                chatMessages.innerHTML = '<div class="no-messages">No messages yet. Start the conversation!</div>';
                return;
            }

            chatMessages.innerHTML = '';
            const user = auth.currentUser;
            const currentUser = user ? user.email.split('@')[0] : null;

            snapshot.forEach(doc => {
                const message = doc.data();
                const messageElement = createMessageElement(message, currentUser, doc.id);
                chatMessages.appendChild(messageElement);
            });

            // Scroll to bottom with smooth behavior
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }, error => {
            console.error('Error loading private messages:', error);
            chatMessages.innerHTML = '<div class="no-messages">Error loading messages. Please try again.</div>';
        });
    }

    // Load announcements for dashboard
    function loadAnnouncements() {
        const announcementsBody = document.getElementById('announcementsBody');
        announcementsBody.innerHTML = '<div class="no-announcements">Loading announcements...</div>';
        
        db.collection('announcements')
            .orderBy('date', 'desc')
            .limit(5) // Show only 5 most recent announcements on dashboard
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    announcementsBody.innerHTML = '<div class="no-announcements">No announcements found.</div>';
                    return;
                }
                
                announcementsBody.innerHTML = '';
                
                snapshot.forEach((doc, index) => {
                    const announcement = doc.data();
                    const date = announcement.date.toDate();
                    const formattedDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const announcementItem = document.createElement('div');
                    announcementItem.className = 'announcement-item';
                    
                    let announcementContent = `
                        <div class="announcement-header">
                            <div class="announcement-title">${announcement.title}</div>
                            <div class="announcement-date">${formattedDate}</div>
                        </div>
                        <div class="announcement-content" style="display: none;">
                            ${announcement.content}
                    `;
                    
                    // Add image if available
                    if (announcement.imageUrl) {
                        announcementContent += `
                            <img src="${announcement.imageUrl}" alt="Announcement Image" class="announcement-image">
                        `;
                    }
                    
                    announcementContent += `
                            <div class="announcement-author">Posted by: ${announcement.author || 'Management'}</div>
                        </div>
                    `;
                    
                    announcementItem.innerHTML = announcementContent;
                    announcementsBody.appendChild(announcementItem);
                    
                    // Add click event to toggle content
                    announcementItem.addEventListener('click', function() {
                        this.classList.toggle('expanded');
                        const content = this.querySelector('.announcement-content');
                        if (this.classList.contains('expanded')) {
                            content.style.display = 'block';
                        } else {
                            content.style.display = 'none';
                        }
                    });
                    
                    // Animate each item with a delay
                    setTimeout(() => {
                        announcementItem.classList.add('visible');
                    }, index * 150);
                });
            })
            .catch(error => {
                console.error('Error loading announcements:', error);
                announcementsBody.innerHTML = '<div class="no-announcements">Error loading announcements. Please try again later.</div>';
            });
    }

    // Load employee's teams for dashboard
    function loadEmployeeTeams(employeeId) {
        const teamsList = document.getElementById('teamsList');
        teamsList.innerHTML = '<div class="no-teams">Loading your team assignments...</div>';
        
        // Get current date
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Query teams where this employee is a member
        db.collection('teams')
            .where('date', '>=', today.toISOString().split('T')[0])
            .orderBy('date')
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    teamsList.innerHTML = '<div class="no-teams">You have no upcoming team assignments.</div>';
                    return;
                }
                
                teams = []; // Reset teams array
                
                snapshot.forEach(doc => {
                    const team = doc.data();
                    team.id = doc.id;
                    
                    // Check if employee is in this team
                    if (isEmployeeInTeam(employeeId, team)) {
                        teams.push(team);
                    }
                });
                
                if (teams.length === 0) {
                    teamsList.innerHTML = '<div class="no-teams">You have no upcoming team assignments.</div>';
                } else {
                    displayTeams(teams, teamsList);
                }
                
                // Start checking for break times
                startBreakCheck();
            })
            .catch(error => {
                console.error('Error loading teams:', error);
                teamsList.innerHTML = '<div class="no-teams">Error loading your team assignments. Please try again later.</div>';
            });
    }

    // Load employee's teams for modal
    function loadEmployeeTeamsForModal(employeeId) {
        const teamsModalBody = document.getElementById('teamsModalBody');
        teamsModalBody.innerHTML = '<div class="no-teams">Loading your team assignments...</div>';
        
        // Get all teams (past and future)
        db.collection('teams')
            .orderBy('date')
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    teamsModalBody.innerHTML = '<div class="no-teams">You have no team assignments.</div>';
                    return;
                }
                
                let modalTeams = [];
                
                snapshot.forEach(doc => {
                    const team = doc.data();
                    team.id = doc.id;
                    
                    // Check if employee is in this team
                    if (isEmployeeInTeam(employeeId, team)) {
                        modalTeams.push(team);
                    }
                });
                
                if (modalTeams.length === 0) {
                    teamsModalBody.innerHTML = '<div class="no-teams">You have no team assignments.</div>';
                } else {
                    displayTeams(modalTeams, teamsModalBody);
                }
            })
            .catch(error => {
                console.error('Error loading teams:', error);
                teamsModalBody.innerHTML = '<div class="no-teams">Error loading your team assignments. Please try again later.</div>';
            });
    }

    // Check if employee is in a team
    function isEmployeeInTeam(employeeId, team) {
        // Check supervisor
        if (team.supervisor && team.supervisor.id === employeeId) {
            return true;
        }
        
        // Check staff (handles both single staff and array)
        if (team.staff) {
            if (Array.isArray(team.staff)) {
                if (team.staff.some(staff => staff.id === employeeId)) {
                    return true;
                }
            } else if (team.staff.id === employeeId) {
                return true;
            }
        }
        
        // Check porters
        if (team.porters && team.porters.some(porter => porter.id === employeeId)) {
            return true;
        }
        
        // Check forklift operators (handles both single and array)
        if (team.forkliftOperator && team.forkliftOperator.id === employeeId) {
            return true;
        }
        
        if (team.forkliftOperators && team.forkliftOperators.some(forklift => forklift.id === employeeId)) {
            return true;
        }
        
        return false;
    }

    // Display teams in the specified container
    function displayTeams(teamsToDisplay, container) {
        container.innerHTML = '';
        
        teamsToDisplay.forEach((team, index) => {
            const teamCard = document.createElement('div');
            teamCard.className = 'team-card';
            
            // Format date
            const date = new Date(team.date);
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Format shift
            const shift = team.shift === 'morning' ? 'Morning (6:00 AM - 6:00 PM)' : 'Night (6:00 PM - 6:00 AM)';
            
            // Determine if this is a past team
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isPastTeam = date < today;
            
            // Format breaks information
            let breaksHTML = '';
            if (team.breaks && (team.breaks.teamBreaks || team.breaks.individualBreaks)) {
                const teamBreaks = team.breaks.teamBreaks || [];
                const individualBreaks = team.breaks.individualBreaks || [];
                
                if (teamBreaks.length > 0 || individualBreaks.length > 0) {
                    breaksHTML = `
                        <div class="break-schedule">
                            <div class="break-title">
                                <i class="fas fa-clock"></i> Break Schedule
                            </div>
                            ${teamBreaks.slice(0, 2).map(breakItem => `
                                <div class="break-item">
                                    <div class="break-time">Team: ${formatTime(breakItem.start)} - ${formatTime(breakItem.end)}</div>
                                    <div class="break-duration">${calculateDuration(breakItem.start, breakItem.end)}</div>
                                </div>
                            `).join('')}
                            ${individualBreaks.length > 0 ? `
                                <div class="break-item">
                                    <div class="break-time">${individualBreaks.length} individual breaks</div>
                                </div>
                            ` : ''}
                            ${teamBreaks.length > 2 ? `
                                <div class="break-item">
                                    <div class="break-time">+${teamBreaks.length - 2} more team breaks</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            }
            
            teamCard.innerHTML = `
                <div class="team-header">
                    <div class="team-name">${team.name} ${isPastTeam ? '<span style="color: var(--gray); font-size: 0.8rem;">(Completed)</span>' : ''}</div>
                    <div class="team-date">${formattedDate}</div>
                </div>
                <div class="team-details">
                    <div class="team-detail">
                        <div class="team-label">Shift:</div>
                        <div class="team-value">${shift}</div>
                    </div>
                    <div class="team-detail">
                        <div class="team-label">Location:</div>
                        <div class="team-value">${team.location || 'Not specified'}</div>
                    </div>
                    <div class="team-detail">
                        <div class="team-label">Area:</div>
                        <div class="team-value">${team.area || 'Not specified'}</div>
                    </div>
                </div>
                ${breaksHTML}
                <div class="team-members">
                    <h4>Team Members</h4>
                    ${team.supervisor ? `
                        <div class="member-item">
                            <div class="member-role">Supervisor:</div>
                            <div class="member-name">${team.supervisor.name} <span class="supervisor-badge">Team Leader</span></div>
                        </div>
                    ` : ''}
                    ${team.staff ? 
                        (Array.isArray(team.staff) ? 
                            team.staff.map(staff => `
                                <div class="member-item">
                                    <div class="member-role">Staff:</div>
                                    <div class="member-name">${staff.name}</div>
                                </div>
                            `).join('') : `
                            <div class="member-item">
                                <div class="member-role">Staff:</div>
                                <div class="member-name">${team.staff.name}</div>
                            </div>
                            `) : ''}
                    ${team.porters ? team.porters.map(porter => `
                        <div class="member-item">
                            <div class="member-role">Porter:</div>
                            <div class="member-name">${porter.name}</div>
                        </div>
                    `).join('') : ''}
                    ${team.forkliftOperator ? `
                        <div class="member-item">
                            <div class="member-role">Forklift Operator:</div>
                            <div class="member-name">${team.forkliftOperator.name}</div>
                        </div>
                    ` : ''}
                    ${team.forkliftOperators ? team.forkliftOperators.map(forklift => `
                        <div class="member-item">
                            <div class="member-role">Forklift Operator:</div>
                            <div class="member-name">${forklift.name}</div>
                        </div>
                    `).join('') : ''}
                </div>
            `;
            
            container.appendChild(teamCard);
            
            // Animate each card with a delay
            setTimeout(() => {
                teamCard.classList.add('visible');
            }, index * 100);
        });
    }

    // Format time for display (HH:MM AM/PM)
    function formatTime(timeString) {
        if (!timeString) return '';
        
        const [hours, minutes] = timeString.split(':');
        const hourNum = parseInt(hours, 10);
        const period = hourNum >= 12 ? 'PM' : 'AM';
        const displayHour = hourNum % 12 || 12;
        
        return `${displayHour}:${minutes} ${period}`;
    }

    // Calculate duration between two times
    function calculateDuration(startTime, endTime) {
        if (!startTime || !endTime) return '';
        
        const [startHours, startMinutes] = startTime.split(':').map(Number);
        const [endHours, endMinutes] = endTime.split(':').map(Number);
        
        let totalMinutes = (endHours * 60 + endMinutes) - (startHours * 60 + startMinutes);
        
        if (totalMinutes < 0) {
            totalMinutes += 24 * 60; // Handle overnight breaks
        }
        
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        
        return `${hours > 0 ? hours + 'h ' : ''}${minutes}m`;
    }

    // Start checking for break times
    function startBreakCheck() {
        if (breakCheckInterval) {
            clearInterval(breakCheckInterval);
        }
        
        // Check every minute
        breakCheckInterval = setInterval(checkBreakTimes, 60000);
        
        // Initial check
        checkBreakTimes();
    }

    // Check if any breaks are starting or ending soon
    function checkBreakTimes() {
        const now = new Date();
        const currentHours = now.getHours().toString().padStart(2, '0');
        const currentMinutes = now.getMinutes().toString().padStart(2, '0');
        const currentTime = `${currentHours}:${currentMinutes}`;
        
        const user = auth.currentUser;
        if (!user) return;
        
        const currentUserId = user.email.split('@')[0];
        
        // Get all teams where the current user is a member
        const userTeams = teams.filter(team => isEmployeeInTeam(currentUserId, team));
        
        userTeams.forEach(team => {
            if (!team.breaks) return;
            
            // Check team breaks
            if (team.breaks.teamBreaks) {
                team.breaks.teamBreaks.forEach((breakItem, index) => {
                    const breakKey = `team-${team.id}-${index}`;
                    
                    // Check if break is starting within 5 minutes
                    if (isTimeWithinRange(currentTime, breakItem.start, 5) && !alertedBreaks.has(`start-${breakKey}`)) {
                        alertedBreaks.add(`start-${breakKey}`);
                        showBreakAlert(
                            `Team Break Starting Soon`, 
                            `Team ${team.name}'s break starts at ${formatTime(breakItem.start)}`,
                            'team'
                        );
                    }
                    
                    // Check if break has just started
                    if (isTimeWithinRange(currentTime, breakItem.start, 1) && !alertedBreaks.has(`started-${breakKey}`)) {
                        alertedBreaks.add(`started-${breakKey}`);
                        showBreakAlert(
                            `Team Break Started`, 
                            `Team ${team.name}'s break has started! Enjoy your break until ${formatTime(breakItem.end)}`,
                            'team'
                        );
                    }
                    
                    // Check if break is ending within 5 minutes
                    if (isTimeWithinRange(currentTime, breakItem.end, 5) && !alertedBreaks.has(`end-${breakKey}`)) {
                        alertedBreaks.add(`end-${breakKey}`);
                        showBreakAlert(
                            `Team Break Ending Soon`, 
                            `Team ${team.name}'s break ends at ${formatTime(breakItem.end)}`,
                            'team'
                        );
                    }
                });
            }
            
            // Check individual breaks for this user
            if (team.breaks.individualBreaks) {
                team.breaks.individualBreaks.forEach((breakItem, index) => {
                    if (breakItem.employeeId === currentUserId) {
                        const breakKey = `individual-${team.id}-${index}`;
                        
                        // Check if break is starting within 5 minutes
                        if (isTimeWithinRange(currentTime, breakItem.start, 5) && !alertedBreaks.has(`start-${breakKey}`)) {
                            alertedBreaks.add(`start-${breakKey}`);
                            showBreakAlert(
                                `Your Break Starting Soon`, 
                                `Your break starts at ${formatTime(breakItem.start)} (Team: ${team.name})`,
                                'individual'
                            );
                        }
                        
                        // Check if break has just started
                        if (isTimeWithinRange(currentTime, breakItem.start, 1) && !alertedBreaks.has(`started-${breakKey}`)) {
                            alertedBreaks.add(`started-${breakKey}`);
                            showBreakAlert(
                                `Your Break Started`, 
                                `Your break has started! Enjoy your break until ${formatTime(breakItem.end)} (Team: ${team.name})`,
                                'individual'
                            );
                        }
                        
                        // Check if break is ending within 5 minutes
                        if (isTimeWithinRange(currentTime, breakItem.end, 5) && !alertedBreaks.has(`end-${breakKey}`)) {
                            alertedBreaks.add(`end-${breakKey}`);
                            showBreakAlert(
                                `Your Break Ending Soon`, 
                                `Your break ends at ${formatTime(breakItem.end)} (Team: ${team.name})`,
                                'individual'
                            );
                        }
                    }
                });
            }
        });
    }

    // Check if time is within range of target time (in minutes)
    function isTimeWithinRange(currentTime, targetTime, rangeMinutes) {
        const [currentH, currentM] = currentTime.split(':').map(Number);
        const [targetH, targetM] = targetTime.split(':').map(Number);
        
        const currentTotal = currentH * 60 + currentM;
        const targetTotal = targetH * 60 + targetM;
        
        // Check if current time is within rangeMinutes of target time
        return Math.abs(currentTotal - targetTotal) <= rangeMinutes;
    }

    // Show break alert with sound and vibration
    function showBreakAlert(title, message, type) {
        // Close any existing alerts of the same type
        closeBreakAlerts(type);
        
        const breakAlert = document.createElement('div');
        breakAlert.className = `break-alert break-alert-${type}`;
        breakAlert.dataset.type = type;
        
        // Add animation class
        breakAlert.classList.add('break-alert-popup');
        
        breakAlert.innerHTML = `
            <div class="break-alert-content">
                <div class="break-alert-header">
                    <div class="break-alert-icon">
                        <i class="fas ${type === 'team' ? 'fa-users' : 'fa-user'}"></i>
                    </div>
                    <div class="break-alert-title">
                        <h4>${title}</h4>
                        <div class="break-alert-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                    <button class="break-alert-close">&times;</button>
                </div>
                <div class="break-alert-body">
                    ${message}
                </div>
                <div class="break-alert-footer">
                    <button class="break-alert-action" onclick="handleBreakAction('snooze', this)">
                        <i class="fas fa-clock"></i> Snooze (5 min)
                    </button>
                    <button class="break-alert-action" onclick="handleBreakAction('dismiss', this)">
                        <i class="fas fa-check"></i> Dismiss
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(breakAlert);
        activeBreakAlerts.push(breakAlert);
        
        // Play notification sound
        try {
            const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
            audio.play().catch(e => console.log('Audio play failed:', e));
        } catch (e) {
            console.log('Audio error:', e);
        }
        
        // Vibrate device if supported
        try {
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        } catch (e) {
            console.log('Vibration error:', e);
        }
        
        // Auto-remove after 30 seconds if not manually dismissed
        const autoDismissTimer = setTimeout(() => {
            if (breakAlert.parentNode) {
                breakAlert.classList.add('break-alert-fadeout');
                setTimeout(() => {
                    breakAlert.remove();
                    activeBreakAlerts = activeBreakAlerts.filter(alert => alert !== breakAlert);
                }, 300);
            }
        }, 30000);
        
        // Store timer reference for manual dismissal
        breakAlert.dataset.dismissTimer = autoDismissTimer;
        
        // Close button functionality
        breakAlert.querySelector('.break-alert-close').addEventListener('click', () => {
            clearTimeout(autoDismissTimer);
            breakAlert.classList.add('break-alert-fadeout');
            setTimeout(() => {
                breakAlert.remove();
                activeBreakAlerts = activeBreakAlerts.filter(alert => alert !== breakAlert);
            }, 300);
        });
    }

    // Close all break alerts of a specific type
    function closeBreakAlerts(type) {
        activeBreakAlerts.forEach(alert => {
            if (alert.dataset.type === type) {
                clearTimeout(alert.dataset.dismissTimer);
                alert.classList.add('break-alert-fadeout');
                setTimeout(() => {
                    alert.remove();
                }, 300);
            }
        });
        activeBreakAlerts = activeBreakAlerts.filter(alert => alert.dataset.type !== type);
    }

    // Handle break alert actions (snooze or dismiss)
    window.handleBreakAction = function(action, button) {
        const breakAlert = button.closest('.break-alert');
        if (!breakAlert) return;
        
        clearTimeout(breakAlert.dataset.dismissTimer);
        
        if (action === 'snooze') {
            // Change button to show loading state
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Snoozing...';
            button.disabled = true;
            
            // Snooze for 5 minutes
            setTimeout(() => {
                // Reshow the alert
                const title = breakAlert.querySelector('h4').textContent;
                const message = breakAlert.querySelector('.break-alert-body').textContent.trim();
                const type = breakAlert.dataset.type;
                
                breakAlert.classList.add('break-alert-fadeout');
                setTimeout(() => {
                    breakAlert.remove();
                    activeBreakAlerts = activeBreakAlerts.filter(alert => alert !== breakAlert);
                    showBreakAlert(title, message, type);
                }, 300);
            }, 5000);
        } else {
            // Dismiss the alert
            breakAlert.classList.add('break-alert-fadeout');
            setTimeout(() => {
                breakAlert.remove();
                activeBreakAlerts = activeBreakAlerts.filter(alert => alert !== breakAlert);
            }, 300);
        }
    };

    // Chat modal functionality
    const chatModal = document.getElementById('chatModal');
    const chatBackBtn = document.getElementById('chatBackBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatForumTitle = document.getElementById('chatForumTitle');
    const fileUploadBtn = document.getElementById('fileUploadBtn');
    const fileUploadInput = document.getElementById('fileUploadInput');
    const cameraUploadBtn = document.getElementById('cameraUploadBtn');
    const voiceRecordBtn = document.getElementById('voiceRecordBtn');
    const recordingIndicator = document.getElementById('recordingIndicator');
    
    let currentForumId = null;
    let currentForumName = '';
    let unsubscribeMessages = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    // Chat back button functionality
    chatBackBtn.addEventListener('click', function() {
        chatModal.classList.remove('active');
        if (unsubscribeMessages) {
            unsubscribeMessages();
            unsubscribeMessages = null;
        }
    });

    // Camera functionality
    const cameraModal = document.getElementById('cameraModal');
    const cameraVideo = document.getElementById('cameraVideo');
    const cameraCloseBtn = document.getElementById('cameraCloseBtn');
    const cameraCaptureBtn = document.getElementById('cameraCaptureBtn');
    const cameraFlipBtn = document.getElementById('cameraFlipBtn');
    const cameraPreview = document.getElementById('cameraPreview');
    const cameraPreviewImg = document.getElementById('cameraPreviewImg');
    const cameraPreviewRetake = document.getElementById('cameraPreviewRetake');
    const cameraPreviewAccept = document.getElementById('cameraPreviewAccept');
    
    let stream = null;
    let facingMode = "user"; // front camera by default

    // Open camera modal
    cameraUploadBtn.addEventListener('click', async function() {
        try {
            // Stop any existing stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            // Get camera stream
            stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            });
            
            cameraVideo.srcObject = stream;
            cameraModal.classList.add('active');
        } catch (error) {
            console.error('Error accessing camera:', error);
            alert('Could not access camera. Please check permissions.');
        }
    });

    // Close camera modal
    cameraCloseBtn.addEventListener('click', function() {
        cameraModal.classList.remove('active');
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    });

    // Flip camera
    cameraFlipBtn.addEventListener('click', function() {
        facingMode = facingMode === "user" ? "environment" : "user";
        // Restart camera with new facing mode
        cameraUploadBtn.click();
    });

    // Capture photo
    cameraCaptureBtn.addEventListener('click', function() {
        const canvas = document.createElement('canvas');
        canvas.width = cameraVideo.videoWidth;
        canvas.height = cameraVideo.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
        
        cameraPreviewImg.src = canvas.toDataURL('image/jpeg');
        cameraModal.classList.remove('active');
        cameraPreview.classList.add('active');
        
        // Stop camera stream
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    });

    // Retake photo
    cameraPreviewRetake.addEventListener('click', function() {
        cameraPreview.classList.remove('active');
        cameraUploadBtn.click();
    });

    // Accept photo and upload
    cameraPreviewAccept.addEventListener('click', function() {
        cameraPreview.classList.remove('active');
        
        // Convert data URL to blob
        fetch(cameraPreviewImg.src)
            .then(res => res.blob())
            .then(blob => {
                // Create a file from the blob
                const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
                uploadFile(file);
            });
    });

    // Voice recording functionality
    voiceRecordBtn.addEventListener('click', toggleRecording);

    async function toggleRecording() {
        if (isRecording) {
            stopRecording();
        } else {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                startRecording(stream);
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }
    }

    function startRecording(stream) {
        isRecording = true;
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        voiceRecordBtn.classList.add('recording');
        recordingIndicator.style.display = 'flex';
        
        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
            await uploadAudio(audioBlob);
        };
        
        mediaRecorder.start();
        
        // Stop recording after 2 minutes (safety limit)
        setTimeout(() => {
            if (isRecording) {
                stopRecording();
            }
        }, 120000);
    }

    function stopRecording() {
        if (!isRecording) return;
        
        isRecording = false;
        mediaRecorder.stop();
        voiceRecordBtn.classList.remove('recording');
        recordingIndicator.style.display = 'none';
        
        // Stop all tracks in the stream
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
    }

    async function uploadAudio(audioBlob) {
        if (!currentForumId || audioBlob.size === 0) return;
        
        const user = auth.currentUser;
        if (!user) return;
        
        const username = user.email.split('@')[0];
        const timestamp = firebase.firestore.FieldValue.serverTimestamp();
        
        // Create a unique filename
        const uniqueFilename = `audio_${Date.now()}.mp3`;
        const storageRef = storage.ref(`forum_audio/${currentForumId}/${uniqueFilename}`);
        
        try {
            // Show uploading indicator
            const originalBtnText = voiceRecordBtn.innerHTML;
            voiceRecordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            voiceRecordBtn.disabled = true;
            
            // Upload audio file
            const uploadTask = storageRef.put(audioBlob);
            
            await new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    null,
                    error => reject(error),
                    () => resolve()
                );
            });
            
            // Get download URL
            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
            
            // Save audio info to Firestore
            if (currentForumId.includes('_')) {
                // Private chat
                await db.collection('privateChats').doc(currentForumId).collection('messages').add({
                    audio: {
                        url: downloadURL,
                        duration: Math.floor(audioBlob.size / 6000) // Rough estimate in seconds
                    },
                    sender: username,
                    timestamp: timestamp
                });
            } else {
                // Forum chat
                await db.collection('chatForums').doc(currentForumId).collection('messages').add({
                    audio: {
                        url: downloadURL,
                        duration: Math.floor(audioBlob.size / 6000) // Rough estimate in seconds
                    },
                    sender: username,
                    timestamp: timestamp
                });
            }
            
        } catch (error) {
            console.error('Error uploading audio:', error);
            alert('Error uploading voice message. Please try again.');
        } finally {
            // Reset button
            voiceRecordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceRecordBtn.disabled = false;
        }
    }

    // File upload functionality
    fileUploadBtn.addEventListener('click', function() {
        fileUploadInput.click();
    });

    fileUploadInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            alert('File size too large. Maximum size is 5MB.');
            return;
        }

        uploadFile(file);
    });

    function uploadFile(file) {
        const user = auth.currentUser;
        if (!user || !currentForumId) return;

        const username = user.email.split('@')[0];
        const timestamp = firebase.firestore.FieldValue.serverTimestamp();
        
        // Create a unique filename to prevent overwrites
        const uniqueFilename = Date.now() + '_' + file.name;
        let storageRef;
        
        if (currentForumId.includes('_')) {
            // Private chat
            storageRef = storage.ref(`private_chat_files/${currentForumId}/${uniqueFilename}`);
        } else {
            // Forum chat
            storageRef = storage.ref(`forum_files/${currentForumId}/${uniqueFilename}`);
        }
        
        const uploadTask = storageRef.put(file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                // Progress monitoring can be added here
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Upload is ' + progress + '% done');
            }, 
            (error) => {
                console.error('Error uploading file:', error);
                alert('Error uploading file. Please try again.');
            }, 
            () => {
                uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                    // Save file info to Firestore
                    let savePromise;
                    
                    if (currentForumId.includes('_')) {
                        savePromise = db.collection('privateChats').doc(currentForumId).collection('messages').add({
                            file: {
                                url: downloadURL,
                                type: file.type,
                                size: file.size
                            },
                            sender: username,
                            timestamp: timestamp
                        });
                    } else {
                        savePromise = db.collection('chatForums').doc(currentForumId).collection('messages').add({
                            file: {
                                url: downloadURL,
                                type: file.type,
                                size: file.size
                            },
                            sender: username,
                            timestamp: timestamp
                        });
                    }
                    
                    savePromise.then(() => {
                        // Clear the file input
                        fileUploadInput.value = '';
                    })
                    .catch(error => {
                        console.error('Error saving file info:', error);
                        alert('Error saving file information. Please try again.');
                    });
                });
            }
        );
    }

    // Send message functionality
    chatSendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        const messageText = chatInput.value.trim();
        if (!messageText || !currentForumId) return;

        const user = auth.currentUser;
        if (!user) return;

        const username = user.email.split('@')[0];
        const timestamp = firebase.firestore.FieldValue.serverTimestamp();

        let savePromise;
        
        if (currentForumId.includes('_')) {
            savePromise = db.collection('privateChats').doc(currentForumId).collection('messages').add({
                text: messageText,
                sender: username,
                timestamp: timestamp
            });
        } else {
            savePromise = db.collection('chatForums').doc(currentForumId).collection('messages').add({
                text: messageText,
                sender: username,
                timestamp: timestamp
            });
        }
        
        savePromise.then(() => {
            chatInput.value = '';
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('Error sending message. Please try again.');
        });
    }

    // Open chat forum
    function openChatForum(forumId, forumName) {
        currentForumId = forumId;
        currentForumName = forumName;
        chatForumTitle.textContent = forumName;
        chatModal.classList.add('active');
        chatMessages.innerHTML = '<div class="no-messages">Loading messages...</div>';

        // Load messages
        loadForumMessages(forumId);
    }

    // Load forum messages
    function loadForumMessages(forumId) {
        if (unsubscribeMessages) {
            unsubscribeMessages();
        }

        const messagesQuery = db.collection('chatForums').doc(forumId)
            .collection('messages')
            .orderBy('timestamp', 'asc')
            .limit(100);

        unsubscribeMessages = messagesQuery.onSnapshot(snapshot => {
            if (snapshot.empty) {
                chatMessages.innerHTML = '<div class="no-messages">No messages yet. Be the first to say something!</div>';
                return;
            }

            chatMessages.innerHTML = '';
            const user = auth.currentUser;
            const currentUser = user ? user.email.split('@')[0] : null;

            snapshot.forEach(doc => {
                const message = doc.data();
                const messageElement = createMessageElement(message, currentUser, doc.id);
                chatMessages.appendChild(messageElement);
            });

            // Scroll to bottom with smooth behavior
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }, error => {
            console.error('Error loading messages:', error);
            chatMessages.innerHTML = '<div class="no-messages">Error loading messages. Please try again.</div>';
        });
    }

    // Create message element
    function createMessageElement(message, currentUser, messageId) {
        const isCurrentUser = message.sender === currentUser;
        const messageClass = isCurrentUser ? 'message message-sent' : 'message message-received';
        
        const date = message.timestamp?.toDate() || new Date();
        const formattedTime = date.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });

        const messageElement = document.createElement('div');
        messageElement.className = messageClass;
        
        // Get sender's avatar
        const avatarUrl = getAvatarUrl(message.sender);
        
        let messageContent = '';
        if (message.text) {
            messageContent += `<div class="message-content">${message.text}</div>`;
        }
        
        if (message.file) {
            if (message.file.type.startsWith('image/')) {
                messageContent += `
                    <div class="file-message">
                        <i class="fas fa-image"></i> Image Attachment
                        <img src="${message.file.url}" alt="Image Attachment" class="file-preview">
                        <div class="file-actions">
                            <div class="file-action" onclick="window.open('${message.file.url}', '_blank')">
                                <i class="fas fa-download"></i> Download
                            </div>
                            ${isCurrentUser ? `
                            <div class="file-action" onclick="deleteFileAttachment('${currentForumId}', '${messageId}', '${message.file.url}', ${currentForumId.includes('_')})">
                                <i class="fas fa-trash"></i> Delete
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                messageContent += `
                    <div class="file-message">
                        <i class="fas fa-file"></i> File Attachment
                        <div class="file-actions">
                            <div class="file-action" onclick="window.open('${message.file.url}', '_blank')">
                                <i class="fas fa-download"></i> Download
                            </div>
                            ${isCurrentUser ? `
                            <div class="file-action" onclick="deleteFileAttachment('${currentForumId}', '${messageId}', '${message.file.url}', ${currentForumId.includes('_')})">
                                <i class="fas fa-trash"></i> Delete
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        }
        
        if (message.audio) {
            messageContent += `
                <div class="audio-message">
                    <i class="fas fa-microphone"></i>
                    <audio controls class="audio-player">
                        <source src="${message.audio.url}" type="audio/mp3">
                        Your browser does not support the audio element.
                    </audio>
                    ${isCurrentUser ? `
                    <div class="file-action" onclick="deleteFileAttachment('${currentForumId}', '${messageId}', '${message.audio.url}', ${currentForumId.includes('_')})">
                        <i class="fas fa-trash"></i> Delete
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        messageElement.innerHTML = `
            <div class="message-header">
                <div class="message-avatar" style="background-image: url('${avatarUrl}')"></div>
                <div class="message-info">
                    <div class="message-sender">${message.sender}</div>
                    <div class="message-time">${formattedTime}</div>
                </div>
            </div>
            ${messageContent}
            ${isCurrentUser ? `
            <div class="message-actions">
                <div class="message-action" onclick="editMessage('${currentForumId}', '${messageId}', '${message.text || ''}', ${currentForumId.includes('_')})">
                    <i class="fas fa-edit"></i>
                </div>
                <div class="message-action" onclick="deleteMessage('${currentForumId}', '${messageId}', ${currentForumId.includes('_')})">
                    <i class="fas fa-trash"></i>
                </div>
            </div>
            ` : ''}
        `;
        
        return messageElement;
    }

    // Delete message
    window.deleteMessage = async function(forumId, messageId, isPrivateChat) {
        const result = await customConfirm('Are you sure you want to delete this message?', {
            type: 'danger',
            icon: 'fa-trash',
            title: 'Delete Message',
            confirmText: 'Delete',
            danger: true
        });
        
        if (result) {
            let deletePromise;
            
            if (isPrivateChat) {
                deletePromise = db.collection('privateChats').doc(forumId).collection('messages').doc(messageId).delete();
            } else {
                deletePromise = db.collection('chatForums').doc(forumId).collection('messages').doc(messageId).delete();
            }
            
            deletePromise.then(() => {
                console.log('Message deleted successfully');
            })
            .catch(error => {
                console.error('Error deleting message:', error);
                alert('Error deleting message. Please try again.');
            });
        }
    };

    // Edit message
    window.editMessage = async function(forumId, messageId, currentText, isPrivateChat) {
        const newText = await customPrompt('Edit your message:', currentText, {
            title: 'Edit Message',
            confirmText: 'Save',
            icon: 'fa-edit'
        });
        
        if (newText !== null && newText !== currentText) {
            let updatePromise;
            
            if (isPrivateChat) {
                updatePromise = db.collection('privateChats').doc(forumId).collection('messages').doc(messageId).update({
                    text: newText,
                    edited: true
                });
            } else {
                updatePromise = db.collection('chatForums').doc(forumId).collection('messages').doc(messageId).update({
                    text: newText,
                    edited: true
                });
            }
            
            updatePromise.then(() => {
                console.log('Message updated successfully');
            })
            .catch(error => {
                console.error('Error updating message:', error);
                alert('Error updating message. Please try again.');
            });
        }
    };

    // Delete file attachment
    window.deleteFileAttachment = async function(forumId, messageId, fileUrl, isPrivateChat) {
        const result = await customConfirm('Are you sure you want to delete this attachment?', {
            type: 'danger',
            icon: 'fa-trash',
            title: 'Delete Attachment',
            confirmText: 'Delete',
            danger: true
        });
        
        if (result) {
            // Delete from storage first
            const fileRef = storage.refFromURL(fileUrl);
            
            fileRef.delete().then(() => {
                // Then delete the message or update it in Firestore
                let deletePromise;
                
                if (isPrivateChat) {
                    deletePromise = db.collection('privateChats').doc(forumId).collection('messages').doc(messageId).delete();
                } else {
                    deletePromise = db.collection('chatForums').doc(forumId).collection('messages').doc(messageId).delete();
                }
                
                return deletePromise;
            })
            .then(() => {
                console.log('File attachment deleted successfully');
            })
            .catch(error => {
                console.error('Error deleting file attachment:', error);
                alert('Error deleting file attachment. Please try again.');
            });
        }
    };

    // Get avatar URL for a user
    function getAvatarUrl(username) {
        // In a real app, you would fetch this from the user's profile in Firestore
        // For now, we'll use a placeholder or check if we have it in localStorage
        const cachedAvatar = localStorage.getItem(`avatar_${username}`);
        return cachedAvatar || 'https://via.placeholder.com/150?text=' + username.charAt(0);
    }

    // Load chat forums
    function loadChatForums() {
        const forumsBody = document.getElementById('forumsBody');
        forumsBody.innerHTML = '<div class="no-teams">Loading chat forums...</div>';
        
        const user = auth.currentUser;
        if (!user) return;
        
        const username = user.email.split('@')[0];
        
        db.collection('chatForums')
            .orderBy('createdAt', 'desc')
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    forumsBody.innerHTML = '<div class="no-teams">No chat forums available.</div>';
                    return;
                }
                
                forumsBody.innerHTML = '';
                
                snapshot.forEach((doc, index) => {
                    const forum = doc.data();
                    const forumId = doc.id;
                    const isMember = forum.members && forum.members.includes(username);
                    
                    const forumCard = document.createElement('div');
                    forumCard.className = 'forum-card';
                    forumCard.innerHTML = `
                        <div class="forum-header">
                            <div class="forum-title">${forum.name}</div>
                            <div class="forum-members">
                                <i class="fas fa-users"></i> ${forum.memberCount || 0} members
                            </div>
                        </div>
                        <div class="forum-description">${forum.description || 'Join this forum to connect with colleagues'}</div>
                        <div class="forum-footer">
                            <div class="forum-category">${forum.category || 'General'}</div>
                            ${isMember ? 
                                `<button class="forum-join-btn" data-forum-id="${forumId}" data-forum-name="${forum.name}" style="background-color: var(--success);">Open Chat</button>
                                 <button class="forum-exit-btn" data-forum-id="${forumId}">Exit Forum</button>` : 
                                `<button class="forum-join-btn" data-forum-id="${forumId}">Join Forum</button>`}
                        </div>
                    `;
                    
                    forumsBody.appendChild(forumCard);
                    
                    // Animate each card with a delay
                    setTimeout(() => {
                        forumCard.classList.add('visible');
                    }, index * 100);
                });
                
                // Add event listeners to join buttons
                document.querySelectorAll('.forum-join-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const forumId = this.getAttribute('data-forum-id');
                        const forumName = this.getAttribute('data-forum-name');
                        
                        if (this.textContent === 'Open Chat') {
                            openChatForum(forumId, forumName);
                        } else {
                            joinChatForum(forumId);
                        }
                        
                        // Micro-interaction
                        this.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.style.transform = 'scale(1)';
                        }, 200);
                    });
                });
                
                // Add event listeners to exit buttons
                document.querySelectorAll('.forum-exit-btn').forEach(button => {
                    button.addEventListener('click', async function() {
                        const forumId = this.getAttribute('data-forum-id');
                        const result = await customConfirm('Are you sure you want to exit this forum?', {
                            type: 'warning',
                            icon: 'fa-sign-out-alt',
                            title: 'Exit Forum',
                            confirmText: 'Exit'
                        });
                        
                        if (result) {
                            exitChatForum(forumId);
                        }
                        
                        // Micro-interaction
                        this.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.style.transform = 'scale(1)';
                        }, 200);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading forums:', error);
                forumsBody.innerHTML = '<div class="no-teams">Error loading chat forums. Please try again later.</div>';
            });
    }

    // Join a chat forum
    function joinChatForum(forumId) {
        const user = auth.currentUser;
        if (!user) return;
        
        const username = user.email.split('@')[0];
        
        // Add user to forum members
        db.collection('chatForums').doc(forumId).update({
            members: firebase.firestore.FieldValue.arrayUnion(username),
            memberCount: firebase.firestore.FieldValue.increment(1)
        })
        .then(() => {
            // Show success animation
            const joinBtn = document.querySelector(`.forum-join-btn[data-forum-id="${forumId}"]`);
            if (joinBtn) {
                joinBtn.innerHTML = '<i class="fas fa-check"></i> Joined';
                joinBtn.style.backgroundColor = 'var(--success)';
                
                setTimeout(() => {
                    joinBtn.innerHTML = 'Open Chat';
                    loadChatForums(); // Refresh the list
                }, 1000);
            }
        })
        .catch(error => {
            console.error('Error joining forum:', error);
            alert('Error joining forum. Please try again.');
        });
    }

    // Exit a chat forum
    function exitChatForum(forumId) {
        const user = auth.currentUser;
        if (!user) return;
        
        const username = user.email.split('@')[0];
        
        // Remove user from forum members
        db.collection('chatForums').doc(forumId).update({
            members: firebase.firestore.FieldValue.arrayRemove(username),
            memberCount: firebase.firestore.FieldValue.increment(-1)
        })
        .then(() => {
            loadChatForums(); // Refresh the list
        })
        .catch(error => {
            console.error('Error exiting forum:', error);
            alert('Error exiting forum. Please try again.');
        });
    }

    // Profile avatar upload
    const profileAvatar = document.getElementById('profileAvatar');
    const profileAvatarEdit = document.getElementById('profileAvatarEdit');
    const profileAvatarInput = document.getElementById('profileAvatarInput');
    
    profileAvatarEdit.addEventListener('click', function() {
        profileAvatarInput.click();
    });
    
    profileAvatarInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }
        
        const user = auth.currentUser;
        if (!user) return;
        
        const username = user.email.split('@')[0];
        const storageRef = storage.ref(`avatars/${username}`);
        
        // Show loading state
        const originalContent = profileAvatarEdit.innerHTML;
        profileAvatarEdit.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // Upload file
        storageRef.put(file)
            .then(snapshot => {
                return snapshot.ref.getDownloadURL();
            })
            .then(downloadURL => {
                // Update user's avatar in Firestore
                return db.collection('employees').doc(username).update({
                    avatarUrl: downloadURL
                });
            })
            .then(() => {
                // Update avatar display
                profileAvatar.style.backgroundImage = `url('${URL.createObjectURL(file)}')`;
                
                // Cache the avatar URL locally
                localStorage.setItem(`avatar_${username}`, URL.createObjectURL(file));
                
                // Update avatar in dashboard
                document.getElementById('userAvatar').style.backgroundImage = `url('${URL.createObjectURL(file)}')`;
                headerUserAvatar.style.backgroundImage = `url('${URL.createObjectURL(file)}')`;
                headerUserAvatar.textContent = '';
            })
            .catch(error => {
                console.error('Error uploading avatar:', error);
                alert('Error uploading avatar. Please try again.');
            })
            .finally(() => {
                profileAvatarEdit.innerHTML = originalContent;
            });
    });

    // Login form submission
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    const temporaryPasswordAlert = document.getElementById('temporaryPasswordAlert');
    const disabledAccountAlert = document.getElementById('disabledAccountAlert');
    const loginContainer = document.getElementById('loginContainer');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const logoutBtn = document.getElementById('logoutBtn');
    const userAvatar = document.getElementById('userAvatar');
    const teamsList = document.getElementById('teamsList');
    const announcementsBody = document.getElementById('announcementsBody');
    const dashboardIconsContainer = document.getElementById('dashboardIconsContainer');
    
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        // Show loading state
        btnText.textContent = 'Authenticating...';
        btnSpinner.style.display = 'inline-block';
        loginBtn.disabled = true;
        temporaryPasswordAlert.style.display = 'none';
        disabledAccountAlert.style.display = 'none';
        
        // Sign in with email and password
        auth.signInWithEmailAndPassword(`${username}@dnata.com`, password)
            .then((userCredential) => {
                // Check if account is disabled
                if (userCredential.user.disabled) {
                    auth.signOut();
                    disabledAccountAlert.style.display = 'flex';
                    return;
                }
                
                // Check if this is the first login (temporary password)
                return db.collection('employees').doc(username).get()
                    .then((doc) => {
                        if (doc.exists && doc.data().passwordChanged === false) {
                            // Show temporary password alert
                            temporaryPasswordAlert.style.display = 'flex';
                            
                            // Show change password modal
                            modal.classList.add('active');
                        } else {
                            // Successful login - show dashboard
                            showDashboard(userCredential.user);
                        }
                    });
            })
            .catch((error) => {
                // Handle errors
                const errorCode = error.code;
                const errorMessage = error.message;
                
                if (errorCode === 'auth/user-not-found') {
                    alert('Employee ID not found. Please check your ID and try again.');
                } else if (errorCode === 'auth/wrong-password') {
                    alert('Incorrect password. Please try again.');
                } else if (errorCode === 'auth/user-disabled') {
                    disabledAccountAlert.style.display = 'flex';
                } else {
                    alert('Login error: ' + errorMessage);
                }
            })
            .finally(() => {
                // Reset button state
                btnText.textContent = 'Sign In';
                btnSpinner.style.display = 'none';
                loginBtn.disabled = false;
            });
    });

    // Show dashboard after successful login
    function showDashboard(user) {
        // Animate login container out
        loginContainer.classList.add('hidden');
        
        // After animation completes, show dashboard
        setTimeout(() => {
            loginContainer.style.display = 'none';
            dashboardContainer.classList.add('active');
            dashboardIconsContainer.classList.remove('hidden');
            
            // Show fixed header with glass effect
            fixedHeader.classList.add('visible');
            
            // Set user avatar initials
            const email = user.email.split('@')[0];
            db.collection('employees').doc(email).get()
                .then(doc => {
                    if (doc.exists) {
                        const employee = doc.data();
                        const initials = `${employee.firstName?.charAt(0) || ''}${employee.lastName?.charAt(0) || ''}`;
                        userAvatar.textContent = initials;
                        headerUserAvatar.textContent = initials;
                        
                        // Load avatar if available
                        if (employee.avatarUrl) {
                            userAvatar.style.backgroundImage = `url('${employee.avatarUrl}')`;
                            userAvatar.textContent = '';
                            headerUserAvatar.style.backgroundImage = `url('${employee.avatarUrl}')`;
                            headerUserAvatar.textContent = '';
                            localStorage.setItem(`avatar_${email}`, employee.avatarUrl);
                        }
                        
                        // Load profile info
                        document.getElementById('profileEmployeeId').textContent = email;
                        document.getElementById('profileName').textContent = `${employee.firstName || ''} ${employee.lastName || ''}`;
                        document.getElementById('profileDepartment').textContent = employee.department || 'Not specified';
                        document.getElementById('profilePosition').textContent = employee.position || 'Not specified';
                        
                        if (employee.avatarUrl) {
                            profileAvatar.style.backgroundImage = `url('${employee.avatarUrl}')`;
                            profileAvatar.textContent = '';
                        } else {
                            profileAvatar.style.backgroundImage = '';
                            profileAvatar.textContent = initials;
                        }
                        
                        // Load employee's teams and announcements
                        loadEmployeeTeams(email);
                        loadAnnouncements();
                    }
                });
                
            // Make user avatar clickable to show profile
            userAvatar.addEventListener('click', function() {
                profileModal.classList.add('active');
            });

            // Make header avatar clickable to show profile
            headerUserAvatar.addEventListener('click', function() {
                profileModal.classList.add('active');
            });
            
            // Animate dashboard sections in
            const sections = document.querySelectorAll('.dashboard-section');
            sections.forEach((section, index) => {
                setTimeout(() => {
                    section.classList.add('visible');
                }, index * 150);
            });
        }, 400);
    }

    // Logout functionality
    function logoutUser() {
        // Clear break check interval
        if (breakCheckInterval) {
            clearInterval(breakCheckInterval);
            breakCheckInterval = null;
        }
        
        // Clear alerted breaks
        alertedBreaks = new Set();
        
        // Close any active break alerts
        activeBreakAlerts.forEach(alert => {
            clearTimeout(alert.dataset.dismissTimer);
            alert.remove();
        });
        activeBreakAlerts = [];
        
        // Animate dashboard out
        dashboardContainer.classList.remove('active');
        dashboardIconsContainer.classList.add('hidden');
        
        // Hide fixed header
        fixedHeader.classList.remove('visible');
        
        // After animation completes, show login
        setTimeout(() => {
            auth.signOut().then(() => {
                dashboardContainer.style.display = 'none';
                loginContainer.style.display = 'block';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                // Hide any open fullscreen content
                hideFullscreenContent();
                
                // Hide chat modal if open
                chatModal.classList.remove('active');
                if (unsubscribeMessages) {
                    unsubscribeMessages();
                    unsubscribeMessages = null;
                }
                
                // Animate login container back in
                setTimeout(() => {
                    loginContainer.classList.remove('hidden');
                }, 50);
            }).catch(error => {
                console.error('Error signing out:', error);
                alert('Error signing out. Please try again.');
            });
        }, 400);
    }

    // Logout button click handlers
    logoutBtn.addEventListener('click', logoutUser);
    headerLogoutBtn.addEventListener('click', logoutUser);

    // Change password form submission
    const changePasswordForm = document.getElementById('changePasswordForm');
    const submitNewPassword = document.getElementById('submitNewPassword');
    
    submitNewPassword.addEventListener('click', function() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const username = document.getElementById('username').value;
        
        // Validate inputs
        if (newPassword !== confirmPassword) {
            alert('New passwords do not match');
            return;
        }
        
        if (newPassword.length < 8) {
            alert('Password must be at least 8 characters long');
            return;
        }
        
        // Get current user
        const user = auth.currentUser;
        
        if (user) {
            // Reauthenticate with current password
            const credential = firebase.auth.EmailAuthProvider.credential(
                `${username}@dnata.com`,
                currentPassword
            );
            
            user.reauthenticateWithCredential(credential)
                .then(() => {
                    // Update password
                    return user.updatePassword(newPassword);
                })
                .then(() => {
                    // Password updated successfully
                    alert('Password changed successfully!');
                    modal.classList.remove('active');
                    temporaryPasswordAlert.style.display = 'none';
                    
                    // Update user in Firestore
                    return db.collection('employees').doc(username).update({
                        passwordChanged: true,
                        lastPasswordChange: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    // Show dashboard after password change
                    showDashboard(user);
                })
                .catch((error) => {
                    console.error('Error changing password:', error);
                    alert('Error changing password. Please try again.');
                });
        } else {
            alert('No user is currently signed in');
        }
    });

    // Forgot password link
    document.getElementById('forgotPassword').addEventListener('click', function(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        
        if (!username) {
            alert('Please enter your Employee ID first');
            return;
        }
        
        const email = `${username}@dnata.com`;
        
        auth.sendPasswordResetEmail(email)
            .then(() => {
                alert('Password reset email sent. Please check your inbox.');
            })
            .catch((error) => {
                console.error('Error sending password reset email:', error);
                if (error.code === 'auth/user-not-found') {
                    alert('Employee ID not found. Please check your ID and try again.');
                } else if (error.code === 'auth/user-disabled') {
                    alert('Your account has been disabled. Please contact HR.');
                } else {
                    alert('Error sending password reset email. Please try again.');
                }
            });
    });

    // Tooltip functionality for floating icons
    const floatingIcons = document.querySelectorAll('.floating-icon');
    floatingIcons.forEach(icon => {
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.textContent = icon.getAttribute('data-tooltip');
        icon.appendChild(tooltip);
        
        icon.addEventListener('mouseenter', function() {
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
        });
        
        icon.addEventListener('mouseleave', function() {
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';
        });
    });

    // Tooltip functionality for dashboard icons
    const dashboardIcons = document.querySelectorAll('.dashboard-icon');
    dashboardIcons.forEach(icon => {
        const tooltip = icon.querySelector('.dashboard-icon-tooltip');
        
        icon.addEventListener('mouseenter', function() {
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
        });
        
        icon.addEventListener('mouseleave', function() {
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';
        });
    });

    // Check if user is already logged in
    auth.onAuthStateChanged((user) => {
        if (user) {
            // Check if account is disabled
            if (user.disabled) {
                disabledAccountAlert.style.display = 'flex';
                auth.signOut();
                return;
            }
            
            // User is signed in, check if password needs to be changed
            const username = user.email.split('@')[0];
            db.collection('employees').doc(username).get()
                .then((doc) => {
                    if (doc.exists) {
                        const employeeData = doc.data();
                        if (employeeData.passwordChanged === false) {
                            // Show password change modal
                            document.getElementById('username').value = username;
                            temporaryPasswordAlert.style.display = 'flex';
                            modal.classList.add('active');
                        } else {
                            // Show dashboard
                            showDashboard(user);
                        }
                    }
                });
        } else {
            // Hide dashboard floating icons when logged out
            hideFullscreenContent();
        }
    });

    // Initially hide the fixed header
    fixedHeader.style.display = 'none';
    globalBackButton.style.display = 'none';
});
// Attachment button functionality
const attachmentBtn = document.getElementById('attachmentBtn');
const expandedActions = document.getElementById('expandedActions');

attachmentBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    expandedActions.classList.toggle('active');
});

// Close expanded actions when clicking outside
document.addEventListener('click', function() {
    expandedActions.classList.remove('active');
});

// Prevent expanded actions from closing when clicking inside
expandedActions.addEventListener('click', function(e) {
    e.stopPropagation();
});

// File upload button
document.getElementById('fileUploadBtn').addEventListener('click', function() {
    document.getElementById('fileUploadInput').click();
    expandedActions.classList.remove('active');
});

// Camera upload button
document.getElementById('cameraUploadBtn').addEventListener('click', function() {
    startCamera();
    expandedActions.classList.remove('active');
});

// Voice record button
const voiceRecordBtn = document.getElementById('voiceRecordBtn');
const recordingIndicator = document.getElementById('recordingIndicator');

voiceRecordBtn.addEventListener('click', function() {
    if (recordingIndicator.style.display === 'flex') {
        // Stop recording
        recordingIndicator.style.display = 'none';
        voiceRecordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        
        // Here you would stop the actual recording
        // For demo, we'll just show a sent message
        setTimeout(() => {
            addMessage('You', 'Voice message', true, 'audio');
        }, 500);
    } else {
        // Start recording
        recordingIndicator.style.display = 'flex';
        voiceRecordBtn.innerHTML = '<i class="fas fa-stop"></i>';
        
        // Here you would start the actual recording
    }
    expandedActions.classList.remove('active');
});

// File upload handler
document.getElementById('fileUploadInput').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        const file = e.target.files[0];
        const fileName = file.name;
        const fileType = file.type.split('/')[0]; // 'image', 'video', 'audio', etc.
        
        // For demo, we'll just show the file name
        addMessage('You', fileName, true, fileType);
    }
});

// Camera functionality
let stream = null;

function startCamera() {
    document.getElementById('cameraModal').classList.add('active');
    
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(function(s) {
            stream = s;
            const video = document.getElementById('cameraVideo');
            video.srcObject = stream;
        })
        .catch(function(err) {
            console.error("Error accessing camera: ", err);
        });
}

// Camera capture button
document.getElementById('cameraCaptureBtn').addEventListener('click', function() {
    const video = document.getElementById('cameraVideo');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Stop camera stream
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    
    // Show preview
    document.getElementById('cameraModal').classList.remove('active');
    document.getElementById('cameraPreviewImg').src = canvas.toDataURL('image/png');
    document.getElementById('cameraPreview').classList.add('active');
});

// Camera close button
document.getElementById('cameraCloseBtn').addEventListener('click', function() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    document.getElementById('cameraModal').classList.remove('active');
});

// Camera preview retake button
document.getElementById('cameraPreviewRetake').addEventListener('click', function() {
    document.getElementById('cameraPreview').classList.remove('active');
    startCamera();
});

// Camera preview accept button
document.getElementById('cameraPreviewAccept').addEventListener('click', function() {
    document.getElementById('cameraPreview').classList.remove('active');
    
    // For demo, we'll just show the image in chat
    addMessage('You', 'Photo', true, 'image');
});
</script>
   
</body>
</html>
